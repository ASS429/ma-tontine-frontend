<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Tontines Pro</title>
    <script src="https://cdn.tailwindcss.com">
// === Gestion des tirages ===
async function supprimerTirage(tirageId, tontineId) {
    if (!confirm("Supprimer ce tirage ?")) return;

    try {
        await apiFetch(`/tirages/${tirageId}`, { method: "DELETE" });
        alert("✅ Tirage supprimé !");
        chargerTontineTirage();
        mettreAJourAlertes();
    } catch (e) {
        console.error(e);
        alert("❌ Erreur lors de la suppression du tirage");
    }
}

</script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .card-premium {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            box-shadow: 
                20px 20px 60px #d9d9d9,
                -20px -20px 60px #ffffff,
                inset 0 1px 0 rgba(255,255,255,0.6);
            border-radius: 20px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .card-premium:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 
                25px 25px 80px #d0d0d0,
                -25px -25px 80px #ffffff,
                0 25px 50px rgba(0,0,0,0.1);
        }
        
        .btn-gradient {
            background: var(--primary-gradient);
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 15px;
            padding: 12px 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-gradient:hover::before {
            left: 100%;
        }
        
        .btn-gradient:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: var(--success-gradient);
        }
        
        .btn-warning {
            background: var(--warning-gradient);
        }
        
        .btn-danger {
            background: var(--danger-gradient);
        }
        
        .floating-animation {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
                transform: scale(1.05);
            }
        }
        
        .slide-in-right {
            animation: slideInRight 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.8s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: pageTransition 0.5s ease-out;
        }
        
        @keyframes pageTransition {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .nav-button {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: width 0.3s ease;
        }
        
        .nav-button:hover::before {
            width: 100%;
        }
        
        .nav-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .member-card {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border-radius: 20px;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .member-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary-gradient);
        }
        
        .member-card:hover {
            transform: translateY(-8px) rotateX(5deg);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .alert-notification {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            border-radius: 15px;
            animation: alertPulse 2s infinite;
        }
        
        @keyframes alertPulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(255, 154, 158, 0.7);
            }
            70% { 
                box-shadow: 0 0 0 10px rgba(255, 154, 158, 0);
            }
        }
        
        .form-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .form-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }
        
        .winner-announcement {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border-radius: 20px;
            animation: winnerCelebration 1s ease-out;
        }
        
        @keyframes winnerCelebration {
            0% { 
                transform: scale(0.8) rotate(-5deg);
                opacity: 0;
            }
            50% { 
                transform: scale(1.1) rotate(2deg);
            }
            100% { 
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .dice-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .dice {
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            animation: diceRoll 2s ease-in-out;
            position: relative;
        }
        
        @keyframes diceRoll {
            0% { 
                transform: rotateX(0deg) rotateY(0deg) scale(1);
            }
            25% { 
                transform: rotateX(180deg) rotateY(90deg) scale(1.2);
            }
            50% { 
                transform: rotateX(360deg) rotateY(180deg) scale(1.1);
            }
            75% { 
                transform: rotateX(540deg) rotateY(270deg) scale(1.2);
            }
            100% { 
                transform: rotateX(720deg) rotateY(360deg) scale(1);
            }
        }
        
        .dice-glow {
            animation: diceGlow 2s ease-in-out;
        }
        
        @keyframes diceGlow {
            0%, 100% { 
                box-shadow: 
                    0 10px 30px rgba(0, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.6);
            }
            50% { 
                box-shadow: 
                    0 15px 40px rgba(102, 126, 234, 0.6),
                    0 0 30px rgba(102, 126, 234, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.6);
            }
        }
        
        .tontine-card {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border-radius: 25px;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .tontine-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: var(--primary-gradient);
        }
        
        .tontine-card:hover {
            transform: translateY(-15px) scale(1.02);
            box-shadow: 
                0 30px 60px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.05);
        }
        
        .header-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .icon-bounce {
            animation: iconBounce 2s infinite;
        }
        
        @keyframes iconBounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        /* Lisibilité renforcée pour publics peu alphabétisés */
html { font-size: 18px; }              /* +12.5% environ */
body { line-height: 1.6; }
input, select, textarea { font-size: 1rem; }
label { font-size: 0.95rem; font-weight: 600; }
.btn-gradient { padding: 14px 22px; font-size: 1rem; }


        /* Bordure contrastée pour les bannières de statut */
.status-banner { border-left: 6px solid rgba(255,255,255,0.6); }


    </style>
</head>
<body>
    <!-- En-tête avec effet glass -->
    <header class="header-glass sticky top-0 z-50 mb-4 md:mb-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 sm:py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <div class="w-12 h-12 sm:w-16 sm:h-16 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 rounded-xl sm:rounded-2xl flex items-center justify-center floating-animation">
                        <span class="text-white font-bold text-lg sm:text-2xl">🎯</span>
                    </div>
                    <div>
                        <h1 class="text-xl sm:text-2xl md:text-3xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                            Mes Tontines Pro
                        </h1>
                        <p class="text-gray-600 font-medium text-xs sm:text-sm">Gestionnaire Premium</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4 md:space-x-6">
                    <!-- Bannière de statut réseau -->
                    <div id="banniereReseau" class="hidden fixed top-0 left-0 right-0 bg-orange-500 text-white text-center py-2 text-sm font-medium z-50">
                        📡 Mode hors ligne - Données locales utilisées
                    </div>
                    
                    <div id="infoUtilisateur" class="text-right hidden sm:block">
                        <p class="text-xs sm:text-sm text-gray-600 font-medium">Connecté en tant que</p>
                        <p class="text-sm sm:text-base font-bold text-gray-800" id="nomUtilisateur">-</p>
                    </div>
                    
                    <div class="text-right hidden sm:block">
                        <p class="text-xs sm:text-sm text-gray-600 font-medium">Tontines Actives</p>
                        <p class="text-xl sm:text-2xl md:text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent" id="nombreTontines">0</p>
                    </div>
                    
                    <button id="btnDeconnexion" onclick="seDeconnecter()" class="btn-gradient btn-danger text-sm sm:text-base px-3 sm:px-4 py-2 sm:py-3 hidden">
                        🚪 Déconnexion
                    </button>
                    
                    <button id="btnRetour" onclick="retourAccueil()" class="hidden btn-gradient text-sm sm:text-base px-3 sm:px-4 py-2 sm:py-3">
                        ← Retour
                    </button>
                </div>
            </div>
        </div>
    
<!-- Dropdown Profil -->
<div class="relative inline-block text-left" id="profileMenu">
  <button id="profileButton" class="flex items-center text-gray-700 hover:text-blue-600 font-medium focus:outline-none">
    👤
  </button>
  <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg py-2 z-50">
    <button id="installAppBtnDropdown" class="block w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100">📲 Installer l’application</button>
    <button id="logoutBtnDropdown" class="block w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100">🚪 Déconnexion</button>
  </div>
</div>
<script>
// === Global DOMContentLoaded wrapper ===
document.addEventListener("DOMContentLoaded", function() {

  const profileButton = document.getElementById('profileButton');
  const profileDropdown = document.getElementById('profileDropdown');

  if (profileButton) {
    profileButton.addEventListener('click', () => {
      profileDropdown.classList.toggle('hidden');
    });

    // Cacher le menu si on clique ailleurs
    document.addEventListener('click', (e) => {
      if (!profileButton.contains(e.target) && !profileDropdown.contains(e.target)) {
        profileDropdown.classList.add('hidden');
      }
    });
  }

  const logoutBtnDropdown = document.getElementById('logoutBtnDropdown');
  if (logoutBtnDropdown) {
    logoutBtnDropdown.addEventListener('click', () => {
      localStorage.removeItem('token');
      location.reload();
    });
  }

});

</script>

</header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6">
        <!-- PAGE CONNEXION -->
        <div id="page-connexion" class="page active">
            <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                <div class="max-w-md w-full space-y-8">
                    <div class="card-premium p-8 fade-in-up">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 floating-animation">
                                <span class="text-white font-bold text-3xl">🎯</span>
                            </div>
                            <h2 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                                Connexion
                            </h2>
                            <p class="text-gray-600 font-medium mt-2">Accédez à vos tontines</p>
                        </div>
                        
                        <form onsubmit="seConnecter(event)" class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">Email</label>
                                <input type="email" id="emailConnexion" required placeholder="votre@email.com" class="form-input w-full">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">Mot de passe</label>
                                <input type="password" id="motPasseConnexion" required placeholder="••••••••" class="form-input w-full">
                            </div>
                            
                            <button type="submit" class="btn-gradient w-full py-4 rounded-xl text-lg font-bold">
                                🔐 Se connecter
                            </button>
                        </form>
                        
                        <div class="mt-6 text-center">
                            <p class="text-gray-600">Pas encore de compte ?</p>
                            <button onclick="ouvrirPageInscription()" class="text-blue-600 hover:text-blue-800 font-semibold mt-2">
                                Créer un compte
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE INSCRIPTION -->
        <div id="page-inscription" class="page">
            <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                <div class="max-w-md w-full space-y-8">
                    <div class="card-premium p-8 fade-in-up">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 bg-gradient-to-r from-green-400 to-blue-500 rounded-2xl flex items-center justify-center mx-auto mb-4 floating-animation">
                                <span class="text-white font-bold text-3xl">👤</span>
                            </div>
                            <h2 class="text-3xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
                                Inscription
                            </h2>
                            <p class="text-gray-600 font-medium mt-2">Créez votre compte</p>
                        </div>
                        
                        <form onsubmit="sInscrire(event)" class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">Nom complet</label>
                                <input type="text" id="nomInscription" required placeholder="Jean Dupont" class="form-input w-full">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">Email</label>
                                <input type="email" id="emailInscription" required placeholder="votre@email.com" class="form-input w-full">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">Mot de passe</label>
                                <input type="password" id="motPasseInscription" required placeholder="••••••••" class="form-input w-full" minlength="6">
                                <p class="text-xs text-gray-500 mt-1">Minimum 6 caractères</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">Confirmer le mot de passe</label>
                                <input type="password" id="confirmMotPasse" required placeholder="••••••••" class="form-input w-full" minlength="6">
                            </div>
                            
                            <button type="submit" class="btn-gradient btn-success w-full py-4 rounded-xl text-lg font-bold">
                                ✅ Créer mon compte
                            </button>
                        </form>
                        
                        <div class="mt-6 text-center">
                            <p class="text-gray-600">Déjà un compte ?</p>
                            <button onclick="ouvrirPageConnexion()" class="text-blue-600 hover:text-blue-800 font-semibold mt-2">
                                Se connecter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE ACCUEIL -->
        <div id="page-accueil" class="page">
            <!-- Navigation principale avec effets glass -->
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-3 sm:gap-4 md:gap-6 mb-8 md:mb-12">
                <button onclick="ouvrirPage('creer')" class="nav-button text-white p-4 sm:p-5 md:p-6 rounded-xl md:rounded-2xl text-center relative z-10">
                    <div class="text-2xl sm:text-3xl md:text-4xl mb-1 md:mb-2 icon-bounce">➕</div>
                    <div class="font-semibold text-xs sm:text-sm md:text-base">Créer</div>
                </button>
                <button onclick="ouvrirPage('gestion')" class="nav-button text-white p-4 sm:p-5 md:p-6 rounded-xl md:rounded-2xl text-center relative z-10">
                    <div class="text-2xl sm:text-3xl md:text-4xl mb-1 md:mb-2 icon-bounce" style="animation-delay: 0.2s">⚙️</div>
                    <div class="font-semibold text-xs sm:text-sm md:text-base">Gérer</div>
                </button>
                <button onclick="ouvrirPage('membres')" class="nav-button text-white p-4 sm:p-5 md:p-6 rounded-xl md:rounded-2xl text-center relative z-10">
                    <div class="text-2xl sm:text-3xl md:text-4xl mb-1 md:mb-2 icon-bounce" style="animation-delay: 0.4s">👥</div>
                    <div class="font-semibold text-xs sm:text-sm md:text-base">Membres</div>
                </button>
                <button onclick="ouvrirPage('tirages')" class="nav-button text-white p-4 sm:p-5 md:p-6 rounded-xl md:rounded-2xl text-center relative z-10">
                    <div class="text-2xl sm:text-3xl md:text-4xl mb-1 md:mb-2 icon-bounce" style="animation-delay: 0.6s">🎲</div>
                    <div class="font-semibold text-xs sm:text-sm md:text-base">Tirages</div>
                </button>
                <button onclick="ouvrirPage('statistiques')" class="nav-button text-white p-4 sm:p-5 md:p-6 rounded-xl md:rounded-2xl text-center relative z-10">
                    <div class="text-2xl sm:text-3xl md:text-4xl mb-1 md:mb-2 icon-bounce" style="animation-delay: 0.8s">📊</div>
                    <div class="font-semibold text-xs sm:text-sm md:text-base">Stats</div>
                </button>
                <button onclick="ouvrirPage('alertes')" class="nav-button text-white p-4 sm:p-5 md:p-6 rounded-xl md:rounded-2xl text-center relative z-10">
                    <div class="text-2xl sm:text-3xl md:text-4xl mb-1 md:mb-2 icon-bounce" style="animation-delay: 1s">🔔</div>
                    <div class="font-semibold text-xs sm:text-sm md:text-base">Alertes</div>
                    <div id="badgeAlertes" class="absolute -top-1 -right-1 sm:-top-2 sm:-right-2 bg-red-500 text-white text-xs rounded-full w-6 h-6 sm:w-8 sm:h-8 flex items-center justify-center font-bold hidden pulse-glow">0</div>
                </button>
            </div>

            <!-- Liste des tontines avec design premium -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-8" id="listeTontines">
                <!-- Les tontines seront affichées ici -->
            </div>
        </div>

       <!-- PAGE CRÉER TONTINE (version pas à pas) -->
<div id="page-creer" class="page">
  <div class="card-premium p-6 sm:p-8 fade-in-up max-w-2xl mx-auto">
    
    <!-- En-tête -->
    <div class="text-center mb-8">
      <div class="w-20 h-20 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 floating-animation">
        <span class="text-white text-3xl">➕</span>
      </div>
      <h2 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
        Créer une Nouvelle Tontine
      </h2>
      <p class="text-gray-600 text-sm mt-1">Étape <span id="etapeNum">1</span> / 4</p>
    </div>

    <!-- Etapes -->
    <div id="etape-1" class="etape space-y-6">
      <div>
        <label class="block font-semibold mb-2">Nom de la Tontine</label>
        <input type="text" id="nomTontine" placeholder="Ex: Tontine Famille" class="form-input w-full">
      </div>
      <div>
        <label class="block font-semibold mb-2">Type de Tontine</label>
        <select id="typeTontine" class="form-input w-full">
          <option value="argent">💰 Argent</option> 
          <option value="electronique">📱 Électronique</option>
          <option value="cosmetique">💄 Cosmétiques</option>
          <option value="autre">🎁 Autre</option>
        </select>
      </div>
    </div>

    <div id="etape-2" class="etape hidden space-y-6">
      <div>
        <label class="block font-semibold mb-2">Montant par Cotisation</label>
        <input type="number" id="montantCotisation" placeholder="Ex: 5000" class="form-input w-full">
      </div>
      <div>
        <label class="block font-semibold mb-2">Fréquence des Cotisations</label>
        <select id="frequenceCotisation" class="form-input w-full">
          <option value="quotidien">📅 Quotidien</option>
          <option value="hebdomadaire">📆 Hebdomadaire</option>
          <option value="mensuel">🗓️ Mensuel</option>
          <option value="annuel">📋 Annuel</option>
        </select>
      </div>
    </div>

    <div id="etape-3" class="etape hidden space-y-6">
      <div>
        <label class="block font-semibold mb-2">Jour de Cotisation</label>
        <select id="jourCotisation" class="form-input w-full">
          <option value="lundi">Lundi</option>
          <option value="mardi">Mardi</option>
          <option value="mercredi">Mercredi</option>
          <option value="jeudi">Jeudi</option>
          <option value="vendredi">Vendredi</option>
          <option value="samedi">Samedi</option>
          <option value="dimanche">Dimanche</option>
          <option value="1">1er du mois</option>
          <option value="10">10 du mois</option>
          <option value="20">20 du mois</option>
        </select>
      </div>
      <div>
        <label class="block font-semibold mb-2">Fréquence des Tirages</label>
        <select id="frequenceTirage" class="form-input w-full">
          <option value="hebdomadaire">📆 Hebdomadaire</option>
          <option value="mensuel">🗓️ Mensuel</option>
          <option value="trimestriel">📊 Trimestriel</option>
        </select>
      </div>
    </div>

    <div id="etape-4" class="etape hidden space-y-6">
      <div>
        <label class="block font-semibold mb-2">Nombre de Membres</label>
        <input type="number" id="nombreMembres" placeholder="Ex: 10" min="2" max="50" class="form-input w-full">
      </div>
      <div>
        <label class="block font-semibold mb-2">Description (optionnel)</label>
        <textarea id="descriptionTontine" placeholder="Détails sur la tontine..." class="form-input w-full h-24 resize-none"></textarea>
      </div>
    </div>

    <!-- Navigation étapes -->
    <div class="flex justify-between mt-8">
      <button id="btnPrev" onclick="changerEtape(-1)" class="btn-gradient px-6 py-3 rounded-xl hidden">⬅️ Retour</button>
      <button id="btnNext" onclick="changerEtape(1)" class="btn-gradient btn-success px-6 py-3 rounded-xl">Suivant ➡️</button>
      <button id="btnCreate" onclick="creerTontine()" class="btn-gradient btn-success px-6 py-3 rounded-xl hidden">✅ Créer la Tontine</button>
    </div>
  </div>
</div>
        <!-- PAGE GESTION -->
        <div id="page-gestion" class="page">
            <div class="card-premium p-8 mb-8 fade-in-up">
                <h2 class="text-3xl font-bold bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent mb-6 text-center">
                    ⚙️ Gestion des Tontines
                </h2>
                <select id="selectTontineGestion" onchange="chargerTontineGestion()" class="form-input w-full text-lg">
                    <option value="">Choisir une tontine...</option>
                </select>
            </div>
            
            <div id="panneauGestion" class="hidden space-y-8">
                <!-- Informations de la tontine -->
                <div class="card-premium p-8 slide-in-right">
                    <div id="infosTontine"></div>
                </div>
                
                <!-- Gestion des membres -->
                <div class="card-premium p-8 slide-in-right" style="animation-delay: 0.2s">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">👥 Membres</h3>
                    </div>
                    <div class="flex gap-4 mb-6">
                        <input type="text" id="nouveauMembre" placeholder="Nom du nouveau membre" class="form-input flex-1">
                        <button onclick="ajouterMembreTontine()" class="btn-gradient btn-success px-8 py-3 rounded-xl">Ajouter</button>
                    </div>
                    <div id="listeMembresTontineGestion" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6"></div>
                </div>
                
                <!-- Cotisations -->
                <div class="card-premium p-8 slide-in-right" style="animation-delay: 0.4s">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">💵 Enregistrer Cotisation</h3>
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <select id="membreCotisationSelect" class="form-input">
                            <option value="">Choisir un membre</option>
                        </select>
                        <input type="date" id="dateCotisation" class="form-input">
                        <button onclick="enregistrerCotisationTontine()" class="btn-gradient btn-success px-6 py-3 rounded-xl">Enregistrer</button>
                    </div>
                    <div id="historiqueCotisations" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- PAGE MEMBRES -->
        <div id="page-membres" class="page">
            <div class="card-premium p-8 mb-8 fade-in-up">
                <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-6 text-center">
                    👥 Vue d'ensemble des Membres
                </h2>
                <select id="selectTontineMembres" onchange="afficherMembresTontine()" class="form-input w-full text-lg">
                    <option value="">Choisir une tontine...</option>
                </select>
            </div>
            
            <div id="panneauMembres" class="hidden">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-8" id="cartesMembres">
                    <!-- Les cartes des membres seront affichées ici -->
                </div>
            </div>
        </div>

        <!-- PAGE TIRAGES -->
        <div id="page-tirages" class="page">
            <div class="card-premium p-8 mb-8 fade-in-up">
                <h2 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-8 text-center">
                    🎲 Tirages Automatiques
                </h2>
                
                <div class="mb-8">
                    <select id="selectTontineTirage" onchange="chargerTontineTirage()" class="form-input w-full text-lg">
                        <option value="">Choisir une tontine pour le tirage...</option>
                    </select>
                </div>
                
                <div id="panneauTirage" class="hidden">
                    <div class="grid md:grid-cols-2 gap-8 mb-8">
                        <div class="card-premium p-6 slide-in-right">
                            <h3 class="text-xl font-bold text-gray-700 mb-4">Membres Éligibles</h3>
                            <div id="membresEligibles" class="space-y-3"></div>
                        </div>
                        <div class="card-premium p-6 slide-in-right" style="animation-delay: 0.2s">
                            <h3 class="text-xl font-bold text-gray-700 mb-4">Historique des Gagnants</h3>
                            <div id="historiqueGagnants" class="space-y-3"></div>
                        </div>
                    </div>
                    
                    <div class="card-premium p-8 text-center">
                        <div id="infoTirage" class="mb-6"></div>
                        <button onclick="effectuerTirage()" id="btnTirage" class="btn-gradient text-2xl px-12 py-6 rounded-2xl font-bold">
                            🎲 Effectuer le Tirage
                        </button>
                        
                        <div id="animationDe" class="dice-container hidden">
                            <div class="dice dice-glow">
                                🎲
                            </div>
                        </div>
                        
                        <div id="resultatTirage" class="mt-8 hidden">
                            <div class="winner-announcement p-8 text-center">
                                <div class="text-6xl mb-4">🎉</div>
                                <div class="text-3xl font-bold text-gray-800" id="gagnantTirage"></div>
                                <div class="text-xl text-gray-700" id="montantGagne"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE STATISTIQUES -->
        <div id="page-statistiques" class="page">
            <div class="space-y-8">
                <div class="card-premium p-8 fade-in-up">
                    <h2 class="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-8 text-center">
                        📊 Tableau de Bord Premium
                    </h2>
                    
                    <!-- Métriques principales -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 mb-8">
                        <div class="stat-card p-4 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-blue-500 to-blue-600 bg-clip-text text-transparent" id="statTotalTontines">0</div>
                            <div class="text-xs text-gray-600 font-medium mt-1">Tontines Actives</div>
                        </div>
                        <div class="stat-card p-4 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-green-500 to-green-600 bg-clip-text text-transparent" id="statTotalMembres">0</div>
                            <div class="text-xs text-gray-600 font-medium mt-1">Total Membres</div>
                        </div>
                        <div class="stat-card p-4 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-purple-500 to-purple-600 bg-clip-text text-transparent" id="statTotalCotisations">0</div>
                            <div class="text-xs text-gray-600 font-medium mt-1">FCFA Collectés</div>
                        </div>
                        <div class="stat-card p-4 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-orange-500 to-orange-600 bg-clip-text text-transparent" id="statTotalTirages">0</div>
                            <div class="text-xs text-gray-600 font-medium mt-1">Tirages Effectués</div>
                        </div>
                        <div class="stat-card p-4 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-red-500 to-red-600 bg-clip-text text-transparent" id="statRetards">0</div>
                            <div class="text-xs text-gray-600 font-medium mt-1">⚠️ Retards</div>
                        </div>
                        <div class="stat-card p-4 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-yellow-500 to-yellow-600 bg-clip-text text-transparent" id="statCyclesRetard">0</div>
                            <div class="text-xs text-gray-600 font-medium mt-1">⏳ Cycles Retard</div>
                        </div>
                        <div class="stat-card p-4 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-indigo-500 to-indigo-600 bg-clip-text text-transparent" id="statPaiementsAttente">0</div>
                            <div class="text-xs text-gray-600 font-medium mt-1">💳 Paiements</div>
                        </div>
                        <div class="stat-card p-4 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-emerald-500 to-emerald-600 bg-clip-text text-transparent" id="statTiragesDisponibles">0</div>
                            <div class="text-xs text-gray-600 font-medium mt-1">🎲 Tirages Dispo</div>
                        </div>
                    </div>
                </div>

                <!-- Graphiques -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                    <div class="card-premium p-8 slide-in-right">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Répartition par Type</h3>
                        <div class="relative h-80 w-full">
                            <canvas id="graphiqueTypes"></canvas>
                        </div>
                    </div>
                    <div class="card-premium p-8 slide-in-right" style="animation-delay: 0.2s">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Évolution des Cotisations</h3>
                        <div class="relative h-80 w-full">
                            <canvas id="graphiqueCotisations"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Tableau détaillé -->
                <div class="card-premium p-8 slide-in-right" style="animation-delay: 0.4s">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Performance des Tontines</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                                <tr>
                                    <th class="text-left p-3 font-semibold">Tontine</th>
                                    <th class="text-left p-3 font-semibold">Type</th>
                                    <th class="text-left p-3 font-semibold">Progression Membres</th>
                                    <th class="text-left p-3 font-semibold">Cotisations</th>
                                    <th class="text-left p-3 font-semibold">Progression Tirages</th>
                                    <th class="text-left p-3 font-semibold">Statut</th>
                                </tr>
                            </thead>
                            <tbody id="tableauPerformance">
                                <!-- Les données seront ajoutées ici -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Résumé des alertes intégré -->
                <div class="card-premium p-8 slide-in-right" style="animation-delay: 0.6s">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">📊 Résumé des Alertes</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="resumeAlertes">
                        <!-- Le résumé sera généré ici -->
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE ALERTES -->
        <div id="page-alertes" class="page">
            <div class="card-premium p-8 fade-in-up">
                <h2 class="text-3xl font-bold bg-gradient-to-r from-red-600 to-pink-600 bg-clip-text text-transparent mb-8 text-center">
                    🔔 Alertes et Notifications
                </h2>
                <div id="listeAlertes" class="space-y-6"></div>
            </div>
        </div>
    </div>

    <!-- Modale d'édition de tontine -->
    <div id="modaleEditionTontine" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 md:p-8 max-w-2xl w-full card-premium max-h-[90vh] overflow-y-auto">
            <h3 class="text-3xl font-bold text-gray-800 mb-8 text-center">✏️ Éditer la Tontine</h3>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Nom de la Tontine</label>
                        <input type="text" id="editNomTontine" class="form-input w-full">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Type de Tontine</label>
                        <select id="editTypeTontine" class="form-input w-full">
                            <option value="argent">💰 Argent</option>
                            <option value="electronique">📱 Électronique</option>
                            <option value="cosmetique">💄 Cosmétiques</option>
                            <option value="autre">🎁 Autre</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Montant/Valeur par Cotisation</label>
                        <input type="number" id="editMontantCotisation" class="form-input w-full">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Fréquence des Cotisations</label>
                        <select id="editFrequenceCotisation" class="form-input w-full">
                            <option value="quotidien">📅 Quotidien</option>
                            <option value="hebdomadaire">📆 Hebdomadaire</option>
                            <option value="mensuel">🗓️ Mensuel</option>
                            <option value="annuel">📋 Annuel</option>
                        </select>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Jour de Cotisation</label>
                        <select id="editJourCotisation" class="form-input w-full">
                            <option value="lundi">Lundi</option>
                            <option value="mardi">Mardi</option>
                            <option value="mercredi">Mercredi</option>
                            <option value="jeudi">Jeudi</option>
                            <option value="vendredi">Vendredi</option>
                            <option value="samedi">Samedi</option>
                            <option value="dimanche">Dimanche</option>
                            <option value="1">1er du mois</option>
                            <option value="5">5 du mois</option>
                            <option value="10">10 du mois</option>
                            <option value="15">15 du mois</option>
                            <option value="20">20 du mois</option>
                            <option value="25">25 du mois</option>
                            <option value="30">30 du mois</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Fréquence des Tirages</label>
                        <select id="editFrequenceTirage" class="form-input w-full">
                            <option value="hebdomadaire">📆 Hebdomadaire</option>
                            <option value="mensuel">🗓️ Mensuel</option>
                            <option value="trimestriel">📊 Trimestriel</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre de Membres Max</label>
                        <input type="number" id="editNombreMembres" min="2" max="50" class="form-input w-full">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                        <textarea id="editDescriptionTontine" class="form-input w-full h-24 resize-none"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4 mt-8">
                <button onclick="fermerModaleEdition()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-6 rounded-xl font-medium transition-colors">
                    Annuler
                </button>
                <button onclick="sauvegarderEditionTontine()" class="flex-1 btn-gradient btn-success py-3 px-6 rounded-xl font-medium">
                    ✅ Sauvegarder
                </button>
            </div>
        </div>
    </div>

    <!-- Modale d'édition de membre -->
    <div id="modaleEditionMembre" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 md:p-8 max-w-md w-full card-premium">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">✏️ Éditer le Membre</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nom du membre</label>
                    <input type="text" id="editNomMembre" class="form-input w-full">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Date d'ajout</label>
                    <input type="date" id="editDateAjoutMembre" class="form-input w-full">
                </div>
            </div>
            
            <div class="flex gap-4 mt-8">
                <button onclick="fermerModaleEditionMembre()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-6 rounded-xl font-medium transition-colors">
                    Annuler
                </button>
                <button onclick="sauvegarderEditionMembre()" class="flex-1 btn-gradient btn-success py-3 px-6 rounded-xl font-medium">
                    ✅ Sauvegarder
                </button>
            </div>
        </div>
    </div>

    <!-- Modale d'édition de cotisation -->
    <div id="modaleEditionCotisation" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 md:p-8 max-w-md w-full card-premium">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">💰 Éditer la Cotisation</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Membre</label>
                    <input type="text" id="editMembreCotisation" class="form-input w-full bg-gray-100" readonly>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Date de cotisation</label>
                    <input type="date" id="editDateCotisation" class="form-input w-full">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Montant (FCFA)</label>
                    <input type="number" id="editMontantCotisation" class="form-input w-full" min="0" step="100">
                    <div class="text-xs text-gray-500 mt-1">
                        <div>Cotisation unitaire: <span id="cotisationUnitaire"></span> FCFA</div>
                        <div>Équivalent: <span id="equivalentCotisations"></span> cotisation(s)</div>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4 mt-8">
                <button onclick="fermerModaleEditionCotisation()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-6 rounded-xl font-medium transition-colors">
                    Annuler
                </button>
                <button onclick="sauvegarderEditionCotisation()" class="flex-1 btn-gradient btn-success py-3 px-6 rounded-xl font-medium">
                    ✅ Sauvegarder
                </button>
            </div>
        </div>
    </div>

    <script>
        // Système d'authentification
        let utilisateurConnecte = JSON.parse(localStorage.getItem('utilisateur_connecte') || 'null');
        let utilisateurs = JSON.parse(localStorage.getItem('app_utilisateurs') || '[]');
        
        // --- Hash SHA-256 pour mots de passe (stockage local sécurisé) ---
async function hashPassword(plain) {
  const bytes = new TextEncoder().encode(plain);
  const digest = await crypto.subtle.digest('SHA-256', bytes);
  return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2,'0')).join('');
}

// Migration douce: si un compte est stocké en clair, on l'upgrade en hash
async function migrerComptesEnClair() {
  let modif = false;
  utilisateurs = await Promise.all((utilisateurs || []).map(async u => {
    if (u.motPasse && !String(u.motPasse).startsWith('sha256:')) {
      modif = true;
      return { ...u, motPasse: 'sha256:' + await hashPassword(u.motPasse) };
    }
    return u;
  }));
  if (modif) localStorage.setItem('app_utilisateurs', JSON.stringify(utilisateurs));
}
  
    // Variables pour la synchronisation

  let donneesModifiees = false;
  let derniereSynchronisation = null;
  let estEnLigne = navigator.onLine;

document.addEventListener('DOMContentLoaded', () => {
  migrerComptesEnClair(); 

  // Données de l'application (spécifiques à l'utilisateur connecté)
  let tontines = [];
  let alertes = [];
  let tontineActive = null;
  let pageActuelle = 'accueil';
  
  

  // Initialisation
  verifierAuthentification();
  configurerEvenementsReseau();
  
  // Vérifier les alertes toutes les 5 minutes
  setInterval(() => verifierAlertes(), 5 * 60 * 1000);
  
  // Vérifier la synchronisation toutes les 30 secondes
  setInterval(verifierSynchronisation, 30 * 1000);

  // Système d'authentification
  function verifierAuthentification() {
    const token = localStorage.getItem("token");
    if (token) {
      chargerDonneesUtilisateur();
      initialiserApplication();
      afficherInterfaceConnectee();
    } else {
      afficherPageConnexion();
    }
  }
});


        async function seConnecter(event) {
  event.preventDefault();

  const email = document.getElementById('emailConnexion').value.trim();
  const motPasse = document.getElementById('motPasseConnexion').value;

  if (!email || !motPasse) { alert('Remplissez tous les champs.'); return; }

  const utilisateur = utilisateurs.find(u => u.email === email);
  if (!utilisateur) { alert('Identifiants invalides. Réessayez.'); return; }

  const stocke = utilisateur.motPasse || '';
  let ok = false;

  if (String(stocke).startsWith('sha256:')) {
    const h = await hashPassword(motPasse);
    ok = stocke === ('sha256:' + h);
  } else {
    // Compat plain → on migre immédiatement au format hashé
    ok = stocke === motPasse;
    if (ok) {
      utilisateur.motPasse = 'sha256:' + await hashPassword(motPasse);
      localStorage.setItem('app_utilisateurs', JSON.stringify(utilisateurs));
    }
  }

  if (!ok) { alert('Identifiants invalides. Réessayez.'); return; }

  utilisateurConnecte = utilisateur;
  localStorage.setItem('utilisateur_connecte', JSON.stringify(utilisateur));

  chargerDonneesUtilisateur();
  initialiserApplication();
  afficherInterfaceConnectee();

  document.getElementById('emailConnexion').value = '';
  document.getElementById('motPasseConnexion').value = '';
}


        async function sInscrire(event) {
  event.preventDefault();

  const nom = document.getElementById('nomInscription').value.trim();
  const email = document.getElementById('emailInscription').value.trim();
  const motPasse = document.getElementById('motPasseInscription').value;
  const confirmMotPasse = document.getElementById('confirmMotPasse').value;

  if (!nom || !email || !motPasse || !confirmMotPasse) { alert('Remplissez tous les champs.'); return; }
  if (motPasse !== confirmMotPasse) { alert('Les mots de passe ne correspondent pas.'); return; }
  if (motPasse.length < 6) { alert('Le mot de passe doit avoir au moins 6 caractères.'); return; }
  if (utilisateurs.some(u => u.email === email)) { alert('Cet email est déjà utilisé.'); return; }

  const nouvelUtilisateur = {
    id: Date.now(),
    nom,
    email,
    motPasse: 'sha256:' + await hashPassword(motPasse),
    dateCreation: new Date().toISOString()
  };

  utilisateurs.push(nouvelUtilisateur);
  localStorage.setItem('app_utilisateurs', JSON.stringify(utilisateurs));

  // Connexion auto
  utilisateurConnecte = nouvelUtilisateur;
  localStorage.setItem('utilisateur_connecte', JSON.stringify(nouvelUtilisateur));

  tontines = [];
  alertes = [];
  sauvegarderDonneesUtilisateur();

  initialiserApplication();
  afficherInterfaceConnectee();

  // Reset formulaire
  document.getElementById('nomInscription').value = '';
  document.getElementById('emailInscription').value = '';
  document.getElementById('motPasseInscription').value = '';
  document.getElementById('confirmMotPasse').value = '';
}


        function seDeconnecter() {
            if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                // Sauvegarder les données avant déconnexion
                sauvegarderDonneesUtilisateur();
                
                // Nettoyer les données de session
                utilisateurConnecte = null;
                localStorage.removeItem('utilisateur_connecte');
                
                // Réinitialiser les données
                tontines = [];
                alertes = [];
                tontineActive = null;
                pageActuelle = 'connexion';
                
                // Afficher la page de connexion
                afficherPageConnexion();
                
                alert('✅ Déconnexion réussie !');
            }
        }

        function ouvrirPageConnexion() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-connexion').classList.add('active');
            pageActuelle = 'connexion';
        }

        function ouvrirPageInscription() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-inscription').classList.add('active');
            pageActuelle = 'inscription';
        }

        function afficherPageConnexion() {
            // Masquer l'en-tête et afficher la page de connexion
            document.querySelector('header').style.display = 'none';
            ouvrirPageConnexion();
        }

        function afficherInterfaceConnectee() {
            // Afficher l'en-tête et les éléments connectés
            document.querySelector('header').style.display = 'block';
            document.getElementById('infoUtilisateur').classList.remove('hidden');
            document.getElementById('btnDeconnexion').classList.remove('hidden');
            document.getElementById('nomUtilisateur').textContent = utilisateurConnecte.nom;
            
            // Aller à l'accueil
            ouvrirPage('accueil');
        }

        function chargerDonneesUtilisateur() {
            if (!utilisateurConnecte) return;
            
            const cleUtilisateur = `user_${utilisateurConnecte.id}`;
            tontines = JSON.parse(localStorage.getItem(`${cleUtilisateur}_tontines`) || '[]');
            alertes = JSON.parse(localStorage.getItem(`${cleUtilisateur}_alertes`) || '[]');
            derniereSynchronisation = localStorage.getItem(`${cleUtilisateur}_derniere_sync`) || null;
        }

        function sauvegarderDonneesUtilisateur() {
            if (!utilisateurConnecte) return;
            
            const cleUtilisateur = `user_${utilisateurConnecte.id}`;
            localStorage.setItem(`${cleUtilisateur}_tontines`, JSON.stringify(tontines));
            localStorage.setItem(`${cleUtilisateur}_alertes`, JSON.stringify(alertes));
            localStorage.setItem(`${cleUtilisateur}_derniere_sync`, derniereSynchronisation || '');
        }

        // Initialisation de l'application
        function initialiserApplication() {
            mettreAJourStatutReseau();
            mettreAJourAffichage();
            mettreAJourAlertes();
            
            // Initialiser la date de cotisation si l'élément existe
            const dateCotisation = document.getElementById('dateCotisation');
            if (dateCotisation) {
                dateCotisation.value = new Date().toISOString().split('T')[0];
            }
            
            // Afficher la dernière synchronisation si disponible
            if (derniereSynchronisation) {
                const dateDerniere = new Date(derniereSynchronisation);
                console.log(`Dernière synchronisation: ${dateDerniere.toLocaleString('fr-FR')}`);
            }
        }

        // Configuration des événements réseau
        function configurerEvenementsReseau() {
    window.addEventListener('online', function() {
        estEnLigne = true;
        mettreAJourStatutReseau();
        synchroniserDonnees();
    });

    window.addEventListener('offline', function() {
        estEnLigne = false;
        mettreAJourStatutReseau();
    });
}

// Mise à jour du statut réseau
function mettreAJourStatutReseau() {
    const banniere = document.getElementById('banniereReseau');
    
    if (!estEnLigne) {
        banniere.classList.remove('hidden');
        banniere.innerHTML = '📡 Mode hors ligne - Données locales utilisées';
        banniere.className = 'fixed top-0 left-0 right-0 bg-orange-500 text-white text-center py-2 text-sm font-medium z-50';
    } else {
        if (donneesModifiees) {
            banniere.classList.remove('hidden');
            banniere.innerHTML = '🔄 Synchronisation en cours...';
            banniere.className = 'fixed top-0 left-0 right-0 bg-blue-500 text-white text-center py-2 text-sm font-medium z-50';
        } else {
            banniere.classList.add('hidden');
        }
    }
}

// Synchronisation des données
function synchroniserDonnees() {
    if (!estEnLigne || !donneesModifiees || !utilisateurConnecte) return;
    
    try {
        // Simulation de synchronisation avec un serveur
        setTimeout(() => {
            // Marquer comme synchronisé
            donneesModifiees = false;
            derniereSynchronisation = new Date().toISOString();
            
            // Sauvegarder la date de synchronisation pour l'utilisateur
            const cleUtilisateur = `user_${utilisateurConnecte.id}`;
            localStorage.setItem(`${cleUtilisateur}_derniere_sync`, derniereSynchronisation);
            
            // Mettre à jour l'interface
            mettreAJourStatutReseau();
            
            // Afficher une notification de succès
            afficherNotificationSync('✅ Données synchronisées avec succès');
            
            console.log('Synchronisation terminée:', new Date().toLocaleString('fr-FR'));
        }, 2000); // Simulation d'un délai de synchronisation
    } catch (error) {
        console.error('Erreur de synchronisation:', error);
        afficherNotificationSync('❌ Erreur de synchronisation');
    }
}

// Vérification périodique de la synchronisation
function verifierSynchronisation() {
    if (estEnLigne && donneesModifiees) {
        synchroniserDonnees();
    }
}

// Affichage des notifications de synchronisation
function afficherNotificationSync(message) {
    const banniere = document.getElementById('banniereReseau');
    banniere.classList.remove('hidden');
    banniere.innerHTML = message;
    banniere.className = 'fixed top-0 left-0 right-0 bg-green-500 text-white text-center py-2 text-sm font-medium z-50';
    
    setTimeout(() => {
        banniere.classList.add('hidden');
    }, 3000);
}


        // Navigation entre pages
        function ouvrirPage(page) {
            // Masquer toutes les pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            // Afficher la page demandée
            const pageElement = document.getElementById('page-' + page);
            pageElement.classList.add('active');
            
            // Afficher/masquer le bouton retour
            const btnRetour = document.getElementById('btnRetour');
            if (page === 'accueil') {
                btnRetour.classList.add('hidden');
            } else {
                btnRetour.classList.remove('hidden');
            }
            
            pageActuelle = page;
            
            // Charger le contenu spécifique à la page
            switch(page) {
                case 'accueil':
                    afficherTontines();
                    break;
                case 'gestion':
                    chargerSelectsTontines();
                    break;
                case 'membres':
                    chargerSelectsTontines();
                    break;
                case 'tirages':
                    chargerSelectsTontines();
                    break;
                case 'statistiques':
                    afficherStatistiques();
                    break;
                case 'alertes':
                    afficherAlertes();
                    break;
            }
        }


        function retourAccueil() {
            ouvrirPage('accueil');
        }

        // Création de tontine
let etape = 1;

function changerEtape(dir) {
  // Validation avant d'avancer
  if (dir === 1 && !validerEtape(etape)) return;

  // Masquer l’étape actuelle
  document.getElementById("etape-" + etape).classList.add("hidden");

  // Changer d’étape
  etape += dir;

  // Afficher la nouvelle étape
  document.getElementById("etape-" + etape).classList.remove("hidden");

  // Mettre à jour compteur
  document.getElementById("etapeNum").innerText = etape;

  // Gérer boutons
  document.getElementById("btnPrev").classList.toggle("hidden", etape === 1);
  document.getElementById("btnNext").classList.toggle("hidden", etape === 4);
  document.getElementById("btnCreate").classList.toggle("hidden", etape !== 4);
}

// Validation par étape
function validerEtape(num) {
  switch (num) {
    case 1:
      if (!document.getElementById('nomTontine').value.trim()) {
        afficherErreur("Veuillez entrer un nom de tontine");
        return false;
      }
      return true;

    case 2:
      const montant = parseFloat(document.getElementById('montantCotisation').value);
      if (!montant || montant <= 0) {
        afficherErreur("Veuillez entrer un montant valide");
        return false;
      }
      return true;

    case 3:
      if (!document.getElementById('jourCotisation').value) {
        afficherErreur("Veuillez choisir un jour de cotisation");
        return false;
      }
      return true;

    case 4:
      const nbMembres = parseInt(document.getElementById('nombreMembres').value);
      if (!nbMembres || nbMembres < 2) {
        afficherErreur("Veuillez entrer au moins 2 membres");
        return false;
      }
      return true;
  }
  return true;
}

// Affichage d’une petite notification erreur (au lieu d’alert)
function afficherErreur(msg) {
  const div = document.createElement("div");
  div.className = "bg-red-500 text-white text-center py-2 rounded-lg mb-4";
  div.textContent = "⚠️ " + msg;
  const parent = document.querySelector("#page-creer .card-premium");
  parent.insertBefore(div, parent.firstChild);

  setTimeout(() => div.remove(), 3000);
}

// Création finale (uniquement à l’étape 4)
function creerTontine() {
  if (!validerEtape(4)) return;

  const tontine = {
    id: Date.now(),
    nom: document.getElementById('nomTontine').value.trim(),
    type: document.getElementById('typeTontine').value,
    montant: parseFloat(document.getElementById('montantCotisation').value),
    frequenceCotisation: document.getElementById('frequenceCotisation').value,
    jourCotisation: document.getElementById('jourCotisation').value,
    frequenceTirage: document.getElementById('frequenceTirage').value,
    nombreMembresMax: parseInt(document.getElementById('nombreMembres').value),
    description: document.getElementById('descriptionTontine').value.trim(),
    dateCreation: new Date().toISOString(),
    statut: 'active',
    membres: [],
    cotisations: [],
    tirages: [],
    gagnants: []
  };

  tontines.push(tontine);
  sauvegarder();

  // Réinitialiser le wizard
  document.querySelectorAll(".etape").forEach(e => e.classList.add("hidden"));
  etape = 1;
  document.getElementById("etape-1").classList.remove("hidden");
  document.getElementById("etapeNum").innerText = etape;
  document.getElementById("btnPrev").classList.add("hidden");
  document.getElementById("btnNext").classList.remove("hidden");
  document.getElementById("btnCreate").classList.add("hidden");

  // Nettoyer les champs
  document.getElementById('nomTontine').value = '';
  document.getElementById('montantCotisation').value = '';
  document.getElementById('nombreMembres').value = '';
  document.getElementById('descriptionTontine').value = '';

  // Message succès
  alert('✅ Tontine créée avec succès !');
  ouvrirPage('accueil');
}

        // Affichage des tontines
     function afficherTontines() {
    const liste = document.getElementById('listeTontines');
    liste.innerHTML = '';

    // 👉 Vérifier si le guide est masqué dans localStorage
    const guideMasque = localStorage.getItem('guideMasque') === 'true';

    if (!guideMasque) {
        const guide = document.createElement('div');
        guide.className = 'col-span-full bg-gradient-to-r from-green-400 to-green-500 text-white rounded-xl shadow-md p-4 mb-6 text-center relative';
        guide.innerHTML = `
            <button onclick="masquerGuide()" class="absolute top-2 right-2 text-white font-bold text-lg">❌</button>
            <h3 class="text-lg font-semibold mb-2">📘 Guide rapide</h3>
            <ol class="text-left list-decimal list-inside space-y-1">
              <li>➕ Créez une tontine</li>
              <li>👥 Ajoutez les membres</li>
              <li>💰 Enregistrez les cotisations</li>
              <li>🎲 Faites le tirage quand c’est prêt</li>
            </ol>
        `;
        liste.appendChild(guide);
    }

    if (tontines.length === 0) {
        liste.innerHTML += `
            <div class="col-span-full text-center py-16">
                <div class="text-8xl mb-6 floating-animation">🎯</div>
                <h3 class="text-2xl font-bold text-white mb-4">Aucune tontine créée</h3>
                <p class="text-white/80 mb-6 text-lg">Commencez par créer votre première tontine</p>
                <button onclick="ouvrirPage('creer')" class="btn-gradient btn-success px-8 py-4 rounded-2xl text-lg">
                    ➕ Créer une Tontine
                </button>
            </div>
        `;
        return;
    }

    tontines.forEach((tontine, index) => {
        const typeIcon = {
            'argent': '💰',
            'electronique': '📱',
            'cosmetique': '💄',
            'autre': '🎁'
        };

        const frequenceText = {
            'quotidien': 'Quotidien',
            'hebdomadaire': 'Hebdomadaire',
            'mensuel': 'Mensuel',
            'annuel': 'Annuel'
        };

        const progression = (tontine.membres.length / tontine.nombreMembresMax) * 100;
        const cotisationsCompletes = verifierCotisationsCompletes(tontine);
        const tiragePossible = verifierDateTiragePossible(tontine);
        const prochaineTirage = obtenirProchaineDateTirage(tontine);
        const eligibles = tontine.membres.filter(m => !m.aGagne);

        const div = document.createElement('div');
        div.className = 'tontine-card p-8 fade-in-up';
        div.style.animationDelay = `${index * 0.1}s`;
        div.innerHTML = `
            <div class="flex justify-between items-start mb-6">
                <div class="flex items-center space-x-4">
                    <div class="text-5xl floating-animation">${typeIcon[tontine.type]}</div>
                    <div>
                        <h3 class="font-bold text-xl text-gray-800">${tontine.nom}</h3>
                        <p class="text-gray-600 font-medium">${frequenceText[tontine.frequenceCotisation]} - ${tontine.montant.toLocaleString()} FCFA</p>
                    </div>
                </div>
                <span class="px-4 py-2 bg-gradient-to-r from-green-400 to-green-500 text-white rounded-full text-sm font-semibold">
                    ${tontine.statut}
                </span>
            </div>
            
            <div class="mb-6">
                <div class="flex justify-between text-sm text-gray-600 mb-2 font-medium">
                    <span>Membres: ${tontine.membres.length}/${tontine.nombreMembresMax}</span>
                    <span>${Math.round(progression)}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="progress-bar h-3 rounded-full" style="width: ${progression}%"></div>
                </div>
            </div>
            
            ${eligibles.length === 0 ? `
                <div class="bg-gradient-to-r from-gray-400 to-gray-500 text-center px-4 py-3 mb-6 text-white font-semibold rounded-xl">
                    🏁 Tontine terminée
                </div>
            ` : tontine.membres.length === 0 ? `
                <div class="bg-gradient-to-r from-blue-400 to-blue-500 text-center px-4 py-3 mb-6 text-white font-semibold rounded-xl">
                    👥 En attente de membres
                </div>
            ` : tontine.cotisations.length === 0 ? `
                <div class="bg-gradient-to-r from-purple-400 to-purple-500 text-center px-4 py-3 mb-6 text-white font-semibold rounded-xl">
                    💰 En attente de cotisations
                </div>
            ` : (cotisationsCompletes && tiragePossible) ? `
                <div class="alert-notification text-center px-4 py-3 mb-6 text-white font-semibold">
                    ${tontine.tirages.length === 0 ? '🎯 Premier tirage disponible !' : '🎲 Tirage disponible !'}
                </div>
            ` : cotisationsCompletes && !tiragePossible ? `
                <div class="bg-gradient-to-r from-orange-400 to-orange-500 text-center px-4 py-3 mb-6 text-white font-semibold rounded-xl">
                    ⏳ Prochain tirage dans ${obtenirJoursRestantsAvantTirage(tontine)} jour(s)
                </div>
            ` : !cotisationsCompletes ? `
                <div class="bg-gradient-to-r from-red-400 to-red-500 text-center px-4 py-3 mb-6 text-white font-semibold rounded-xl">
                    ❌ Cotisations incomplètes (${tontine.membres.filter(m => {
                        const periodeActuelle = obtenirPeriodeCotisation(new Date().toISOString().split('T')[0], tontine.frequenceCotisation);
                        return !m.cotisationsPayees.some(c => obtenirPeriodeCotisation(c.date, tontine.frequenceCotisation) === periodeActuelle);
                    }).length} membre(s) en retard)
                </div>
            ` : ''}
            
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="gererTontine(${tontine.id})" class="btn-gradient text-sm py-3 px-4 rounded-xl font-medium">
                    ⚙️ Gérer
                </button>
                <button onclick="voirMembres(${tontine.id})" class="btn-gradient text-sm py-3 px-4 rounded-xl font-medium" style="background: var(--secondary-gradient)">
                    👥 Membres
                </button>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="editerTontineAccueil(${tontine.id})" class="btn-gradient text-sm py-3 px-4 rounded-xl font-medium" style="background: var(--warning-gradient)">
                    ✏️ Éditer
                </button>
                <button onclick="supprimerTontine(${tontine.id})" class="btn-gradient btn-danger text-sm py-3 px-4 rounded-xl font-medium">
                    🗑️ Supprimer
                </button>
            </div>
        `;
        liste.appendChild(div);
    }); // <-- fermeture du forEach
} // <-- fermeture de la fonction afficherTontines


// ------------------------------
// Fonctions complémentaires
// ------------------------------

function masquerGuide() {
    localStorage.setItem('guideMasque', 'true'); // Sauvegarde le choix
    afficherTontines(); // Recharge la page d’accueil sans le guide
}

// Gestion des tontines
function gererTontine(id) {
    ouvrirPage('gestion');
    document.getElementById('selectTontineGestion').value = id;
    chargerTontineGestion();
}

function voirMembres(id) {
    ouvrirPage('membres');
    document.getElementById('selectTontineMembres').value = id;
    afficherMembresTontine();
}

function chargerSelectsTontines() {
    const selects = ['selectTontineGestion', 'selectTontineMembres', 'selectTontineTirage'];
    
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = '<option value="">Choisir une tontine...</option>';
            
            tontines.forEach(tontine => {
                const option = document.createElement('option');
                option.value = tontine.id;
                option.textContent = tontine.nom;
                select.appendChild(option);
            });
        }
    });
}



        function chargerTontineGestion() {
            const id = parseInt(document.getElementById('selectTontineGestion').value);
            if (!id) {
                document.getElementById('panneauGestion').classList.add('hidden');
                return;
            }

            tontineActive = tontines.find(t => t.id === id);
            document.getElementById('panneauGestion').classList.remove('hidden');
            
            afficherInfosTontine();
            afficherMembresTontineGestion();
            mettreAJourSelectMembres();
            afficherHistoriqueCotisations();
        }

        function afficherInfosTontine() {
            const tontine = tontineActive;
            const typeIcon = {
                'argent': '💰',
                'electronique': '📱',
                'cosmetique': '💄',
                'autre': '🎁'
            };

            // Calculer le cycle actuel
            const cycleActuel = obtenirCycleActuel(tontine);
            const totalCycles = tontine.membres.length;
            const progressionCycle = totalCycles > 0 ? ((cycleActuel - 1) / totalCycles) * 100 : 0;

            document.getElementById('infosTontine').innerHTML = `
                <div class="grid md:grid-cols-5 gap-6">
                    <div class="text-center">
                        <div class="text-5xl mb-3 floating-animation">${typeIcon[tontine.type]}</div>
                        <div class="font-bold text-xl text-gray-800">${tontine.nom}</div>
                        <div class="text-sm text-gray-600 font-medium">${tontine.type}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold bg-gradient-to-r from-green-500 to-green-600 bg-clip-text text-transparent">${tontine.montant.toLocaleString()}</div>
                        <div class="text-sm text-gray-600 font-medium">FCFA par cotisation</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold bg-gradient-to-r from-blue-500 to-blue-600 bg-clip-text text-transparent">${tontine.membres.length}/${tontine.nombreMembresMax}</div>
                        <div class="text-sm text-gray-600 font-medium">Membres</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold bg-gradient-to-r from-orange-500 to-orange-600 bg-clip-text text-transparent">${cycleActuel}/${totalCycles || '?'}</div>
                        <div class="text-sm text-gray-600 font-medium">Cycle actuel</div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            <div class="bg-gradient-to-r from-orange-500 to-orange-600 h-2 rounded-full" style="width: ${progressionCycle}%"></div>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold bg-gradient-to-r from-purple-500 to-purple-600 bg-clip-text text-transparent">${tontine.gagnants.length}</div>
                        <div class="text-sm text-gray-600 font-medium">Tirages effectués</div>
                    </div>
                </div>
            `;
        }

        // Affichage des membres par tontine
        function afficherMembresTontine() {
    const id = parseInt(document.getElementById('selectTontineMembres').value);
    if (!id) {
        document.getElementById('panneauMembres').classList.add('hidden');
        return;
    }

    const tontine = tontines.find(t => t.id === id);
    document.getElementById('panneauMembres').classList.remove('hidden');
    
    const cartes = document.getElementById('cartesMembres');
    cartes.innerHTML = '';

    if (tontine.membres.length === 0) {
        cartes.innerHTML = `
            <div class="col-span-full text-center py-12">
                <div class="text-6xl mb-6 floating-animation">👥</div>
                <h3 class="text-xl font-bold text-gray-700">Aucun membre</h3>
                <p class="text-gray-600">Cette tontine n'a pas encore de membres</p>
            </div>
        `;
        return;
    }

    tontine.membres.forEach((membre, index) => {
        const cotisationsCount = membre.cotisationsPayees.length;
        const totalCotise = cotisationsCount * tontine.montant;
        const statut = membre.aGagne ? 'Gagnant' : 'Actif';
        const couleurStatut = membre.aGagne 
            ? 'bg-gradient-to-r from-yellow-400 to-yellow-500 text-white' 
            : 'bg-gradient-to-r from-green-400 to-green-500 text-white';
        
        // Calculer le statut de paiement pour la période actuelle
        const tousOntGagne = tontine.membres.every(m => m.aGagne);
        let statutPaiement;
        
        if (tousOntGagne) {
            statutPaiement = '<span class="text-blue-600 font-semibold">🏁 Tontine terminée</span>';
        } else {
            const periodeActuelle = obtenirPeriodeCotisation(
                new Date().toISOString().split('T')[0], 
                tontine.frequenceCotisation
            );
            
            const aCotisePeriodeActuelle = membre.cotisationsPayees.some(c => {
                const periodeCotisation = obtenirPeriodeCotisation(c.date, tontine.frequenceCotisation);
                return periodeCotisation === periodeActuelle;
            });

            statutPaiement = aCotisePeriodeActuelle 
                ? '<span class="text-green-600 font-semibold">✅ À jour</span>' 
                : '<span class="text-red-600 font-semibold">⚠️ En retard</span>';
        }
        
        const div = document.createElement('div');
        div.className = 'member-card p-8 fade-in-up';
        div.style.animationDelay = `${index * 0.1}s`;
        div.innerHTML = `
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-4 floating-animation">
                    <span class="text-white text-3xl">${membre.aGagne ? '🏆' : '👤'}</span>
                </div>
                <h3 class="font-bold text-xl text-gray-800 mb-2">${membre.nom}</h3>
                <span class="px-4 py-2 ${couleurStatut} rounded-full text-sm font-semibold">${statut}</span>
            </div>
            
            <div class="space-y-4">
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-600 font-medium">Cotisations:</span>
                    <span class="font-bold text-lg">${cotisationsCount}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-600 font-medium">Total cotisé:</span>
                    <span class="font-bold text-lg text-green-600">${totalCotise.toLocaleString()} FCFA</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-600 font-medium">Statut paiement:</span>
                    ${statutPaiement}
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-600 font-medium">Membre depuis:</span>
                    <span class="font-bold">${new Date(membre.dateAjout).toLocaleDateString('fr-FR')}</span>
                </div>
            </div>
            
            <div class="mt-6 pt-4 border-t">
                <div class="text-sm text-gray-600 font-medium mb-3">Historique des paiements:</div>
                <div class="space-y-2 max-h-40 overflow-y-auto">
                    ${membre.cotisationsPayees.slice(-5).reverse().map(c => 
                        `<div class="flex justify-between items-center text-xs bg-gradient-to-r from-blue-50 to-purple-50 p-3 rounded-lg">
                            <div>
                                <div class="font-medium">${new Date(c.date).toLocaleDateString('fr-FR')}</div>
                                <div class="text-gray-500">${c.montant.toLocaleString()} FCFA</div>
                                ${c.montant > tontine.montant 
                                    ? `<div class="text-green-600 font-semibold text-xs">📊 ${Math.round(c.montant / tontine.montant)} cotisations</div>` 
                                    : ''
                                }
                            </div>
                            <div class="flex gap-1">
                                <button onclick="editerCotisation('${c.id}', ${tontine.id})" class="text-blue-500 hover:text-blue-700 text-sm" title="Éditer">✏️</button>
                                <button onclick="supprimerCotisation('${c.id}', ${tontine.id})" class="text-red-500 hover:text-red-700 text-sm" title="Supprimer">❌</button>
                            </div>
                        </div>`
                    ).join('')}
                </div>
            </div>
            
            <div class="flex gap-3 mt-6 pt-4 border-t">
                <button onclick="ouvrirModaleEditionMembre(${membre.id})" class="flex-1 btn-gradient px-4 py-3 rounded-xl font-medium" style="background: var(--warning-gradient)">
                    ✏️ Éditer
                </button>
                <button onclick="retirerMembreTontine(${membre.id}, ${tontine.id})" class="flex-1 btn-gradient btn-danger py-3 rounded-xl font-medium">
                    🗑️ Retirer
                </button>
            </div>
        `;
        cartes.appendChild(div);
    });
}


        // Gestion des membres
        function ajouterMembreTontine() {
            const nom = document.getElementById('nouveauMembre').value.trim();
            if (!nom) {
                alert('Veuillez entrer un nom');
                return;
            }

            if (tontineActive.membres.length >= tontineActive.nombreMembresMax) {
                alert('Nombre maximum de membres atteint');
                return;
            }

            const membre = {
                id: Date.now(),
                nom: nom,
                dateAjout: new Date().toISOString(),
                cotisationsPayees: [],
                aGagne: false
            };

            tontineActive.membres.push(membre);
            sauvegarder();
            
            document.getElementById('nouveauMembre').value = '';
            afficherMembresTontineGestion();
            mettreAJourSelectMembres();
            mettreAJourAffichage();
        }

        function afficherMembresTontineGestion() {
    const liste = document.getElementById('listeMembresTontineGestion');
    liste.innerHTML = '';

    if (tontineActive.membres.length === 0) {
        liste.innerHTML = `
            <div class="col-span-full text-center py-12">
                <div class="text-6xl mb-6 floating-animation">👥</div>
                <h3 class="text-xl font-bold text-gray-700">Aucun membre</h3>
                <p class="text-gray-600">Cette tontine n'a pas encore de membres</p>
            </div>
        `;
        return;
    }

    tontineActive.membres.forEach((membre, index) => {
        const cotisationsCount = membre.cotisationsPayees.length;
        const totalCotise = cotisationsCount * tontineActive.montant;
        const statut = membre.aGagne ? 'Gagnant' : 'Actif';
        const couleurStatut = membre.aGagne 
            ? 'bg-gradient-to-r from-yellow-400 to-yellow-500 text-white' 
            : 'bg-gradient-to-r from-green-400 to-green-500 text-white';
        
        const div = document.createElement('div');
        div.className = 'member-card p-4 bg-gradient-to-r from-blue-50 to-purple-50 fade-in-up';
        div.style.animationDelay = `${index * 0.1}s`;
        div.innerHTML = `
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                        <span class="text-white text-lg">${membre.aGagne ? '🏆' : '👤'}</span>
                    </div>
                    <div>
                        <div class="font-bold text-gray-800">${membre.nom}</div>
                        <span class="px-2 py-1 ${couleurStatut} rounded-full text-xs font-semibold">${statut}</span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="font-bold text-lg text-green-600">${totalCotise.toLocaleString()} FCFA</div>
                    <div class="text-sm text-gray-600">${cotisationsCount} cotisations</div>
                </div>
            </div>
        `;
        liste.appendChild(div);
    });
} // <-- il manquait cette accolade fermante


function supprimerMembreTontine(membreId) {
    if (confirm('Supprimer ce membre ?')) {
        tontineActive.membres = tontineActive.membres.filter(m => m.id !== membreId);
        sauvegarder();
        afficherMembresTontineGestion();
        mettreAJourSelectMembres();
        mettreAJourAffichage();
    }
}

function editerTontineAccueil(id) {
    const tontine = tontines.find(t => t.id === id);
    if (!tontine) return;
    
    tontineActive = tontine;
    ouvrirModaleEditionTontine();
}

function mettreAJourSelectMembres() {
    const select = document.getElementById('membreCotisationSelect');
    select.innerHTML = '<option value="">Choisir un membre</option>';
    
    tontineActive.membres.forEach(membre => {
        const option = document.createElement('option');
        option.value = membre.id;
        option.textContent = membre.nom;
        select.appendChild(option);
    });
} // <-- il manquait cette accolade fermante


// Gestion des cotisations
function enregistrerCotisationTontine() {
    const membreId = parseInt(document.getElementById('membreCotisationSelect').value);
    const date = document.getElementById('dateCotisation').value;
    
    if (!membreId || !date) {
        alert('Veuillez sélectionner un membre et une date');
        return;
    }

    const membre = tontineActive.membres.find(m => m.id === membreId);

    const cotisation = {
        id: Date.now(),
        membreId: membreId,
        date: date,
        montant: tontineActive.montant
    };

    membre.cotisationsPayees.push(cotisation);
    tontineActive.cotisations.push(cotisation);
    
    sauvegarder();
    afficherHistoriqueCotisations();
    afficherMembresTontineGestion();
    mettreAJourAlertes();
    
    alert('✅ Cotisation enregistrée.');
}


       function afficherHistoriqueCotisations() {
    const liste = document.getElementById('historiqueCotisations');
    liste.innerHTML = '';
    
    if (tontineActive.cotisations.length === 0) {
        liste.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <div class="text-4xl mb-3">💰</div>
                <p>Aucune cotisation enregistrée</p>
            </div>
        `;
        return;
    }
    
    const cotisationsRecentes = tontineActive.cotisations.slice(-10).reverse();
    
    cotisationsRecentes.forEach((cotisation, index) => {
        const membre = tontineActive.membres.find(m => m.id === cotisation.membreId);
        const div = document.createElement('div');
        div.className = 'member-card p-4 bg-gradient-to-r from-green-50 to-green-100 fade-in-up';
        div.style.animationDelay = `${index * 0.1}s`;
        div.innerHTML = `
            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <div class="flex items-center gap-3">
                        <span class="font-semibold text-gray-800">${membre ? membre.nom : 'Membre supprimé'}</span>
                        <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-medium">${new Date(cotisation.date).toLocaleDateString('fr-FR')}</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="font-bold text-green-600 text-lg">+${cotisation.montant.toLocaleString()} FCFA</span>
                    <button onclick="supprimerCotisation('${cotisation.id}', ${tontineActive.id})" 
                            class="text-red-500 hover:text-red-700 text-lg transition-colors" 
                            title="Supprimer cette cotisation">
                        ❌
                    </button>
                </div>
            </div>
        `;
        liste.appendChild(div);
    });
} // <-- manquait cette accolade fermante


// Fonctions de gestion des cotisations et membres
function retirerMembreTontine(membreId, tontineId) {
    const tontine = tontines.find(t => t.id === tontineId);
    if (!tontine) return;
    
    const membre = tontine.membres.find(m => m.id === membreId);
    if (!membre) return;
    
    const cotisationsCount = membre.cotisationsPayees.length;
    const totalCotise = cotisationsCount * tontine.montant;
    const cotisationsTontine = tontine.cotisations.filter(c => c.membreId === membreId).length;
    
    const message = `⚠️ RETRAIT DE MEMBRE ⚠️\n\n` +
                  `Membre: "${membre.nom}"\n` +
                  `Tontine: "${tontine.nom}"\n` +
                  `Statut: ${membre.aGagne ? '🏆 Gagnant' : '👤 Actif'}\n` +
                  `Membre depuis: ${new Date(membre.dateAjout).toLocaleDateString('fr-FR')}\n\n` +
                  `💰 IMPACT FINANCIER:\n` +
                  `• Cotisations payées: ${cotisationsCount}\n` +
                  `• Montant total cotisé: ${totalCotise.toLocaleString()} FCFA\n` +
                  `• Cotisations dans l'historique: ${cotisationsTontine}\n\n` +
                  `⚠️ CONSÉQUENCES:\n` +
                  `• Toutes ses cotisations seront supprimées\n` +
                  `• Son historique sera effacé définitivement\n` +
                  `${membre.aGagne ? '• Son statut de gagnant sera perdu\n' : ''}\n` +
                  `Confirmer le retrait ?`;
    
    if (confirm(message)) {
        // Supprimer le membre et ses cotisations
        tontine.membres = tontine.membres.filter(m => m.id !== membreId);
        tontine.cotisations = tontine.cotisations.filter(c => c.membreId !== membreId);
        
        // Supprimer des gagnants si applicable
        if (membre.aGagne) {
            tontine.gagnants = tontine.gagnants.filter(g => g.gagnantId !== membreId);
            tontine.tirages = tontine.tirages.filter(t => t.gagnantId !== membreId);
        }
        
        sauvegarder();
        
        if (pageActuelle === 'gestion') {
            afficherMembresTontineGestion();
            mettreAJourSelectMembres();
        } else if (pageActuelle === 'membres') {
            afficherMembresTontine();
        }
        
        mettreAJourAlertes();
        
        alert(`✅ Membre "${membre.nom}" retiré avec succès !\n\n` +
              `📊 Résumé du retrait:\n` +
              `• ${cotisationsCount} cotisations supprimées\n` +
              `• ${totalCotise.toLocaleString()} FCFA retirés de l'historique\n` +
              `${membre.aGagne ? '• Statut de gagnant annulé\n' : ''}` +
              `• Membre retiré de "${tontine.nom}"`);
    }
}

function supprimerCotisation(cotisationId, tontineId) {
    if (confirm('Supprimer cette cotisation ?')) {
        const tontine = tontines.find(t => t.id === tontineId);
        if (!tontine) return;
        
        const cotisation = tontine.cotisations.find(c => c.id == cotisationId);
        if (!cotisation) return;
        
        tontine.cotisations = tontine.cotisations.filter(c => c.id != cotisationId);
        
        const membre = tontine.membres.find(m => m.id === cotisation.membreId);
        if (membre) {
            membre.cotisationsPayees = membre.cotisationsPayees.filter(c => c.id != cotisationId);
        }
        
        sauvegarder();
        
        if (pageActuelle === 'gestion') {
            afficherHistoriqueCotisations();
        } else if (pageActuelle === 'membres') {
            afficherMembresTontine();
        }
        
        mettreAJourAlertes();
        alert('✅ Cotisation supprimée !');
    }
}

        // Système de tirage
        function chargerTontineTirage() {
            const id = parseInt(document.getElementById('selectTontineTirage').value);
            if (!id) {
                document.getElementById('panneauTirage').classList.add('hidden');
                return;
            }

            tontineActive = tontines.find(t => t.id === id);
            document.getElementById('panneauTirage').classList.remove('hidden');
            
            afficherMembresEligibles();
            afficherHistoriqueGagnants();
            afficherInfosTirage();
        }

 function afficherMembresEligibles() {
    const liste = document.getElementById('membresEligibles');
    liste.innerHTML = '';
    
    const eligibles = tontineActive.membres.filter(m => !m.aGagne);
    
    if (eligibles.length === 0) {
        liste.innerHTML = '<p class="text-gray-600 text-center py-4">Aucun membre éligible</p>';
        return;
    }

    eligibles.forEach((membre, index) => {
        const div = document.createElement('div');
        div.className = 'member-card p-4 bg-gradient-to-r from-blue-50 to-purple-50 fade-in-up';
        div.style.animationDelay = `${index * 0.1}s`;
        div.innerHTML = `
            <div class="flex justify-between items-center">
                <span class="font-semibold text-gray-800">${membre.nom}</span>
                <span class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-medium">
                    ${membre.cotisationsPayees.length} cotisations
                </span>
            </div>
        `;
        liste.appendChild(div);
    });
}

function afficherHistoriqueGagnants() {
    const liste = document.getElementById('historiqueGagnants');
    liste.innerHTML = '';
    
    tontineActive.gagnants.forEach((gagnant, index) => {
        const div = document.createElement('div');
        div.className = 'member-card p-4 bg-gradient-to-r from-yellow-50 to-yellow-100 fade-in-up';
        div.style.animationDelay = `${index * 0.1}s`;
        div.innerHTML = `
            <div class="flex justify-between items-center">
                <span class="font-semibold text-gray-800">🏆 ${gagnant.nom}</span>
                <span class="text-sm bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full font-medium">
                    ${new Date(gagnant.date).toLocaleDateString('fr-FR')}
                </span>
            </div>
        `;
        liste.appendChild(div);
    });
}

function afficherInfosTirage() {
    const infoDiv = document.getElementById('infoTirage');
    const btnTirage = document.getElementById('btnTirage');
    
    const eligibles = tontineActive.membres.filter(m => !m.aGagne);
    
    // 🔴 GRIS - Tontine terminée
    if (eligibles.length === 0) {
        infoDiv.innerHTML = `
            <div class="bg-gradient-to-r from-gray-400 to-gray-500 p-6 rounded-xl text-white">
                <div class="text-xl font-bold mb-2">🏁 Tontine Terminée</div>
                <div class="text-sm opacity-90">Tous les membres ont déjà gagné</div>
                <div class="text-sm opacity-75 mt-2">Aucun tirage possible</div>
            </div>
        `;
        btnTirage.style.display = 'none';
        return;
    }
    
    const cotisationsCompletes = verifierCotisationsCompletes(tontineActive);
    const tiragePossible = verifierDateTiragePossible(tontineActive);
    const membresEnRetard = tontineActive.membres.filter(m => 
        !m.aGagne && estEnRetardPeriode(m, tontineActive)
    );

    // 🔴 ROUGE - Cotisations incomplètes
    if (!cotisationsCompletes) {
        infoDiv.innerHTML = `
            <div class="bg-gradient-to-r from-red-500 to-red-600 p-6 rounded-xl text-white">
                <div class="text-xl font-bold mb-2">❌ Tirage Impossible</div>
                <div class="text-sm opacity-90 mb-3">Cotisations incomplètes</div>
                <div class="bg-red-600 bg-opacity-50 p-3 rounded-lg text-sm">
                    <div class="font-semibold mb-1">📋 Membres en retard:</div>
                    ${membresEnRetard.map(m => `• ${m.nom}`).join('<br>')}
                </div>
                <div class="text-xs opacity-75 mt-3">Tous les membres éligibles doivent cotiser</div>
            </div>
        `;
        btnTirage.disabled = true;
        btnTirage.style.opacity = '0.3';
        btnTirage.style.background = 'linear-gradient(135deg, #9ca3af, #6b7280)';
        btnTirage.style.cursor = 'not-allowed';
        btnTirage.style.display = 'inline-block';
        return;
    }
    
    // 🟠 ORANGE - Intervalle non respecté
    if (!tiragePossible) {
        const joursRestants = obtenirJoursRestantsAvantTirage(tontineActive);
        const prochaineTirage = obtenirProchaineDateTirage(tontineActive);
        const intervalles = {
            'hebdomadaire': '7 jours',
            'mensuel': '30 jours',
            'trimestriel': '90 jours'
        };
        
        const couleurOrange = joursRestants <= 3 ? 'from-yellow-500 to-orange-500' : 'from-orange-500 to-orange-600';
        
        infoDiv.innerHTML = `
            <div class="bg-gradient-to-r ${couleurOrange} p-6 rounded-xl text-white">
                <div class="text-xl font-bold mb-2">⏳ Tirage en Attente</div>
                <div class="text-sm opacity-90 mb-3">Intervalle de temps non respecté</div>
                <div class="bg-orange-600 bg-opacity-50 p-3 rounded-lg text-sm space-y-1">
                    <div><span class="font-semibold">Fréquence:</span> ${intervalles[tontineActive.frequenceTirage] || '30 jours'}</div>
                    <div><span class="font-semibold">Temps restant:</span> ${joursRestants} jour(s)</div>
                    <div><span class="font-semibold">Disponible le:</span> ${prochaineTirage.toLocaleDateString('fr-FR')}</div>
                </div>
                <div class="text-xs opacity-75 mt-3">
                    ${joursRestants <= 3 ? '🔥 Bientôt disponible !' : 'Patience requise pour respecter l\'intervalle'}
                </div>
            </div>
        `;
        btnTirage.disabled = true;
        btnTirage.style.opacity = '0.6';
        btnTirage.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
        btnTirage.style.cursor = 'not-allowed';
        btnTirage.style.display = 'inline-block';
        btnTirage.innerHTML = `⏳ Disponible dans ${joursRestants}j`;
        return;
    }
    
    // 🟢 VERT - Tirage possible
    const estPremierTirage = tontineActive.tirages.length === 0;
    const montantTotal = tontineActive.montant * tontineActive.membres.length;
    
    infoDiv.innerHTML = `
        <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 rounded-xl text-white">
            <div class="text-xl font-bold mb-2">
                ${estPremierTirage ? '🎯 Premier Tirage Disponible !' : '✅ Nouveau Tirage Disponible !'}
            </div>
            <div class="text-sm opacity-90 mb-3">Toutes les conditions sont remplies</div>
            <div class="bg-green-600 bg-opacity-50 p-3 rounded-lg text-sm space-y-1">
                <div><span class="font-semibold">Membres éligibles:</span> ${eligibles.length}</div>
                <div><span class="font-semibold">Montant à gagner:</span> ${montantTotal.toLocaleString()} FCFA</div>
                <div><span class="font-semibold">Cotisations:</span> ✅ Toutes complètes</div>
                ${estPremierTirage ? 
                    '<div class="font-semibold text-yellow-200">🎉 Premier tirage de cette tontine !</div>' : 
                    '<div><span class="font-semibold">Intervalle:</span> ✅ Respecté</div>'
                }
            </div>
        </div>
    `;
    
    btnTirage.disabled = false;
    btnTirage.style.opacity = '1';
    btnTirage.style.background = 'linear-gradient(135deg, #10b981, #059669)';
    btnTirage.style.cursor = 'pointer';
    btnTirage.style.display = 'inline-block';
    btnTirage.innerHTML = '🎲 Effectuer le Tirage';
}


        function effectuerTirage() {
            const eligibles = tontineActive.membres.filter(m => !m.aGagne);
            
            if (eligibles.length === 0) {
                alert('Aucun membre éligible pour le tirage');
                return;
            }

            if (!verifierCotisationsCompletes(tontineActive)) {
                alert('Toutes les cotisations ne sont pas complètes');
                return;
            }

            if (!verifierDateTiragePossible(tontineActive)) {
                const joursRestants = obtenirJoursRestantsAvantTirage(tontineActive);
                const intervalles = {
                    'hebdomadaire': '7 jours',
                    'mensuel': '30 jours',
                    'trimestriel': '90 jours'
                };
                alert(`Tirage non autorisé !\n\nIntervalle requis: ${intervalles[tontineActive.frequenceTirage] || '30 jours'}\nProchain tirage possible dans: ${joursRestants} jour(s)`);
                return;
            }

            // Masquer le bouton et afficher l'animation du dé
            const btnTirage = document.getElementById('btnTirage');
            const animationDe = document.getElementById('animationDe');
            const resultatTirage = document.getElementById('resultatTirage');
            
            btnTirage.style.display = 'none';
            resultatTirage.classList.add('hidden');
            animationDe.classList.remove('hidden');
            
            // Attendre la fin de l'animation (2 secondes) avant d'afficher le résultat
            setTimeout(() => {
                // Tirage aléatoire
                const gagnantIndex = Math.floor(Math.random() * eligibles.length);
                const gagnant = eligibles[gagnantIndex];
                
                // Marquer comme gagnant
                gagnant.aGagne = true;
                
                // Ajouter à l'historique
                const tirage = {
                    id: Date.now(),
                    gagnantId: gagnant.id,
                    nom: gagnant.nom,
                    date: new Date().toISOString(),
                    montantTotal: tontineActive.montant * tontineActive.membres.length
                };
                
                tontineActive.gagnants.push(tirage);
                tontineActive.tirages.push(tirage);
                
                sauvegarder();
                
                // Masquer l'animation et afficher le résultat
                animationDe.classList.add('hidden');
                
                // Afficher le résultat avec une animation
                document.getElementById('gagnantTirage').textContent = `🎉 ${gagnant.nom} a gagné !`;
                document.getElementById('montantGagne').textContent = `Montant: ${tirage.montantTotal.toLocaleString()} FCFA`;
                resultatTirage.classList.remove('hidden');
                
                // Remettre le bouton après 3 secondes
                setTimeout(() => {
                    btnTirage.style.display = 'inline-block';
                }, 3000);
                
                // Mettre à jour l'affichage
                afficherMembresEligibles();
                afficherHistoriqueGagnants();
                afficherInfosTirage();
                
                // Vérifier si la tontine est terminée
                const tousOntGagne = tontineActive.membres.every(m => m.aGagne);
                if (tousOntGagne) {
                    tontineActive.statut = 'terminee';
                    setTimeout(() => {
                        alert('🎊 Tontine terminée ! Tous les membres ont gagné.');
                    }, 1000);
                }
            }, 2000); // Attendre 2 secondes pour l'animation du dé
        }

        // Statistiques et graphiques
        function afficherStatistiques() {
            calculerMetriques();
            creerGraphiques();
            remplirTableauPerformance();
        }

       function calculerMetriques() {
    const alertesActuelles = mettreAJourAlertes();
    
    const totalTontines = tontines.filter(t => t.statut === 'active').length;
    const totalMembres = tontines.reduce((sum, t) => sum + t.membres.length, 0);
    const totalCotisations = tontines.reduce((sum, t) => 
        sum + t.cotisations.reduce((s, c) => s + c.montant, 0), 0);
    const totalTirages = tontines.reduce((sum, t) => sum + t.tirages.length, 0);
    
    // Calculer les nouvelles métriques d'alertes
    const retards = alertesActuelles.filter(a => a.type === 'retard').length;

    const cyclesRetard = tontines.filter(t => {
        const eligibles = t.membres.filter(m => !m.aGagne);
        return eligibles.length > 0 
            && !verifierDateTiragePossible(t) 
            && verifierCotisationsCompletes(t);
    }).length;

    const paiementsAttente = tontines.reduce((sum, t) => {
        const tousOntGagne = t.membres.every(m => m.aGagne);
        if (tousOntGagne) return sum;
        
        const periodeActuelle = obtenirPeriodeCotisation(
            new Date().toISOString().split('T')[0],
            t.frequenceCotisation
        );

        const nbAttente = t.membres.filter(m => {
            // Vérifie si le membre n’a pas payé pour la période actuelle
            return !m.cotisationsPayees.some(c => {
                const periodeCotisation = obtenirPeriodeCotisation(c.date, t.frequenceCotisation);
                return periodeCotisation === periodeActuelle;
            });
        }).length;

        return sum + nbAttente;
    }, 0);

    const tiragesDisponibles = alertesActuelles.filter(a => a.type === 'tirage').length;

    // Mise à jour du DOM
    document.getElementById('statTotalTontines').textContent = totalTontines;
    document.getElementById('statTotalMembres').textContent = totalMembres;
    document.getElementById('statTotalCotisations').textContent = totalCotisations.toLocaleString();
    document.getElementById('statTotalTirages').textContent = totalTirages;
    document.getElementById('statRetards').textContent = retards;
    document.getElementById('statCyclesRetard').textContent = cyclesRetard;
    document.getElementById('statPaiementsAttente').textContent = paiementsAttente;
    document.getElementById('statTiragesDisponibles').textContent = tiragesDisponibles;
}


// ✅ Tableau des performances
function remplirTableauPerformance() {
    const tableau = document.getElementById('tableauPerformance');
    tableau.innerHTML = '';

    tontines.forEach((tontine, index) => {
        const typeIcons = { 'argent': '💰', 'electronique': '📱', 'cosmetique': '💄', 'autre': '🎁' };
        const totalCotisations = tontine.cotisations.reduce((sum, c) => sum + c.montant, 0);

        // Progression des membres
        const progressionMembres = (tontine.membres.length / tontine.nombreMembresMax) * 100;

        // Progression des tirages
        const eligibles = tontine.membres.filter(m => !m.aGagne);
        const progressionTirages = tontine.membres.length > 0 ?
            ((tontine.membres.length - eligibles.length) / tontine.membres.length) * 100 : 0;

        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all fade-in-up';
        tr.style.animationDelay = `${index * 0.1}s`;
        tr.innerHTML = `
            <td class="p-3 font-semibold">${typeIcons[tontine.type]} ${tontine.nom}</td>
            <td class="p-3 capitalize">${tontine.type}</td>
            <td class="p-3">
                <div class="flex items-center gap-2">
                    <div class="flex-1">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full" style="width: ${progressionMembres}%"></div>
                        </div>
                    </div>
                    <span class="text-xs font-semibold text-gray-600">${tontine.membres.length}/${tontine.nombreMembresMax}</span>
                </div>
            </td>
            <td class="p-3 font-semibold text-green-600">${totalCotisations.toLocaleString()} FCFA</td>
            <td class="p-3">
                <div class="flex items-center gap-2">
                    <div class="flex-1">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 h-2 rounded-full" style="width: ${progressionTirages}%"></div>
                        </div>
                    </div>
                    <span class="text-xs font-semibold text-gray-600">${tontine.tirages.length}/${tontine.membres.length}</span>
                </div>
            </td>
            <td class="p-3">
                <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                    tontine.statut === 'active' ? 'bg-gradient-to-r from-green-400 to-green-500 text-white' : 
                    tontine.statut === 'terminee' ? 'bg-gradient-to-r from-gray-400 to-gray-500 text-white' :
                    'bg-gray-100 text-gray-800'
                }">
                    ${tontine.statut === 'active' ? '🟢 Active' : 
                      tontine.statut === 'terminee' ? '🏁 Terminée' : tontine.statut}
                </span>
            </td>
        `;
        tableau.appendChild(tr);
    });

    // Générer le résumé des alertes
    genererResumeAlertes();
}

function genererResumeAlertes() {
    const alertesActuelles = mettreAJourAlertes();
    const resume = document.getElementById('resumeAlertes');

    const retards = alertesActuelles.filter(a => a.type === 'retard');
    const tirages = alertesActuelles.filter(a => a.type === 'tirage');

    const cyclesRetard = tontines.filter(t => {
        const eligibles = t.membres.filter(m => !m.aGagne);
        return eligibles.length > 0 && !verifierDateTiragePossible(t) && verifierCotisationsCompletes(t);
    }).length;

    const paiementsAttente = tontines.reduce((sum, t) => {
        const tousOntGagne = t.membres.every(m => m.aGagne);
        if (tousOntGagne) return sum;

        const periodeActuelle = obtenirPeriodeCotisation(new Date().toISOString().split('T')[0], t.frequenceCotisation);
        return sum + t.membres.filter(m => {
            return !m.cotisationsPayees.some(c => {
                const periodeCotisation = obtenirPeriodeCotisation(c.date, t.frequenceCotisation);
                return periodeCotisation === periodeActuelle;
            });
        }).length;
    }, 0);

    resume.innerHTML = `
        <div class="bg-gradient-to-r from-red-100 to-red-200 p-4 rounded-xl text-center">
            <div class="text-2xl font-bold text-red-600">${retards.length}</div>
            <div class="text-sm text-red-700 font-medium">⚠️ Retards de paiement</div>
            <div class="text-xs text-red-600 mt-1">${retards.filter(r => r.urgence === 'haute').length} urgents</div>
        </div>
        <div class="bg-gradient-to-r from-yellow-100 to-yellow-200 p-4 rounded-xl text-center">
            <div class="text-2xl font-bold text-yellow-600">${cyclesRetard}</div>
            <div class="text-sm text-yellow-700 font-medium">⏳ Cycles en retard</div>
            <div class="text-xs text-yellow-600 mt-1">Tirages en attente</div>
        </div>
        <div class="bg-gradient-to-r from-blue-100 to-blue-200 p-4 rounded-xl text-center">
            <div class="text-2xl font-bold text-blue-600">${paiementsAttente}</div>
            <div class="text-sm text-blue-700 font-medium">💳 Paiements en attente</div>
            <div class="text-xs text-blue-600 mt-1">Membres à jour</div>
        </div>
        <div class="bg-gradient-to-r from-green-100 to-green-200 p-4 rounded-xl text-center">
            <div class="text-2xl font-bold text-green-600">${tirages.length}</div>
            <div class="text-sm text-green-700 font-medium">🎲 Tirages disponibles</div>
            <div class="text-xs text-green-600 mt-1">${tirages.filter(t => t.estPremierTirage).length} premiers tirages</div>
        </div>
    `;
}

        // Nouvelle gestion des alertes connectée à l'API backend
// Charger les alertes depuis l'API
async function chargerAlertes() {
  try {
    const res = await fetch(`${API_BASE}/alertes`, {
      headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
    });

    if (!res.ok) throw new Error("Erreur récupération alertes");

    alertes = await res.json();
    mettreAJourBadgeAlertes();
    afficherAlertes();
  } catch (err) {
    console.error("Erreur alertes:", err);
  }
}

// Met à jour le badge d’alertes
function mettreAJourBadgeAlertes() {
  const badge = document.getElementById("badgeAlertes");
  if (!badge) return;

  if (alertes.length > 0) {
    badge.textContent = alertes.length;
    badge.classList.remove("hidden");
  } else {
    badge.classList.add("hidden");
  }
}

// Affiche les alertes
function afficherAlertes() {
  const liste = document.getElementById("listeAlertes");
  liste.innerHTML = "";

  if (!alertes || alertes.length === 0) {
    liste.innerHTML = `
      <div class="text-center py-16">
        <div class="text-8xl mb-6 floating-animation">✅</div>
        <h3 class="text-3xl font-bold text-gray-700 mb-4">Aucune alerte active</h3>
        <p class="text-gray-600 text-lg mb-4">Toutes les tontines sont bien gérées !</p>
      </div>
    `;
    return;
  }

  alertes.forEach((alerte, index) => {
    const div = document.createElement("div");
    div.className = "bg-gradient-to-r from-indigo-500 to-purple-600 p-6 rounded-2xl text-white fade-in-up mb-6 shadow-lg";
    div.style.animationDelay = `${index * 0.1}s`;
    div.innerHTML = `
      <div class="flex items-start justify-between">
        <div class="flex items-start flex-1">
          <span class="text-4xl mr-4 floating-animation">${alerte.icone || "⚠️"}</span>
          <div class="flex-1">
            <div class="font-bold text-xl mb-1">${alerte.message}</div>
            <div class="text-sm opacity-75 mb-2">📋 Tontine: ${alerte.tontine}</div>
          </div>
        </div>
      </div>
    `;
    liste.appendChild(div);
  });
}

// Aller au tirage d’une tontine
function allerAuTirage(tontineId) {
  ouvrirPage('tirages');
  document.getElementById('selectTontineTirage').value = tontineId;
  chargerTontineTirage();
}

// Supprimer une alerte
function supprimerAlerte(alerteId) {
  alertes = alertes.filter(a => a.id != alerteId);
  localStorage.setItem('app_alertes', JSON.stringify(alertes));
  mettreAJourBadgeAlertes();
  afficherAlertes();
}

// Fonction pour calculer le cycle actuel
function obtenirCycleActuel(tontine) {
  if (tontine.membres.length === 0) return 1;

  // Le cycle actuel est basé sur le nombre de tirages effectués + 1
  // Si aucun tirage n'a été effectué, on est au cycle 1
  return tontine.tirages.length + 1;
}


        // Fonctions utilitaires
function verifierCotisationsCompletes(tontine) {
    if (tontine.membres.length === 0) return false;
    
    // Tous les membres doivent cotiser, même ceux qui ont déjà gagné
    // Seule exception : si tous les membres ont gagné (tontine terminée)
    const tousOntGagne = tontine.membres.every(m => m.aGagne);
    if (tousOntGagne) return true;
    
    // Vérifier que tous les membres ont cotisé pour la période actuelle
    const periodeActuelle = obtenirPeriodeCotisation(
        new Date().toISOString().split('T')[0], 
        tontine.frequenceCotisation
    );
    
    return tontine.membres.every(membre => {
        return membre.cotisationsPayees.some(c => {
            const periodeCotisation = obtenirPeriodeCotisation(c.date, tontine.frequenceCotisation);
            return periodeCotisation === periodeActuelle;
        });
    });
}

function verifierDateTiragePossible(tontine) {
    if (!verifierCotisationsCompletes(tontine)) return false;
    
    const eligibles = tontine.membres.filter(m => !m.aGagne);
    if (eligibles.length === 0) return false;
    
    // Premier tirage : disponible dès que toutes les cotisations sont complètes
    if (tontine.tirages.length === 0) return true;
    
    // Tirages suivants : vérifier l'intervalle de temps
    const dernierTirage = tontine.tirages[tontine.tirages.length - 1];
    const dateDernierTirage = new Date(dernierTirage.date);
    const maintenant = new Date();
    const diffJours = (maintenant - dateDernierTirage) / (1000 * 60 * 60 * 24);
    
    // Intervalles selon la fréquence
    const intervalles = {
        'hebdomadaire': 7,
        'mensuel': 30,
        'trimestriel': 90
    };
    
    const intervalleRequis = intervalles[tontine.frequenceTirage] || 30;
    return diffJours >= intervalleRequis;
}

function obtenirProchaineDateTirage(tontine) {
    if (tontine.tirages.length === 0) {
        return new Date();
    }
    
    const dernierTirage = new Date(tontine.tirages[tontine.tirages.length - 1].date);
    const intervalles = {
        'hebdomadaire': 7,
        'mensuel': 30,
        'trimestriel': 90
    };
    
    const intervalle = intervalles[tontine.frequenceTirage] || 30;
    const prochaineTirage = new Date(dernierTirage);
    prochaineTirage.setDate(dernierTirage.getDate() + intervalle);
    
    return prochaineTirage;
}

function obtenirJoursRestantsAvantTirage(tontine) {
    if (tontine.tirages.length === 0) return 0;
    
    const prochaineTirage = obtenirProchaineDateTirage(tontine);
    const maintenant = new Date();
    const diffJours = Math.ceil((prochaineTirage - maintenant) / (1000 * 60 * 60 * 24));
    
    return Math.max(0, diffJours);
}

function estEnRetard(derniereCotisation, frequence) {
    const aujourd_hui = new Date();
    const dateCotisation = new Date(derniereCotisation);
    const diffJours = (aujourd_hui - dateCotisation) / (1000 * 60 * 60 * 24);
    
    switch (frequence) {
        case 'quotidien': return diffJours > 1;
        case 'hebdomadaire': return diffJours > 7;
        case 'mensuel': return diffJours > 30;
        case 'annuel': return diffJours > 365;
        default: return false;
    }
}

        function obtenirPeriodeCotisation(date, frequence) {
            const dateObj = new Date(date);
            switch (frequence) {
                case 'quotidien': return date.split('T')[0];
                case 'hebdomadaire': 
                    const debutSemaine = new Date(dateObj);
                    debutSemaine.setDate(dateObj.getDate() - dateObj.getDay());
                    return debutSemaine.toISOString().split('T')[0];
                case 'mensuel': return `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                case 'annuel': return dateObj.getFullYear().toString();
                default: return date.split('T')[0];
            }
        }

        function obtenirPeriodeActuelle(frequence) {
            const aujourd_hui = new Date();
            switch (frequence) {
                case 'quotidien': return aujourd_hui.toISOString().split('T')[0];
                case 'hebdomadaire': 
                    const debutSemaine = new Date(aujourd_hui);
                    debutSemaine.setDate(aujourd_hui.getDate() - aujourd_hui.getDay());
                    return debutSemaine.toISOString().split('T')[0];
                case 'mensuel': return `${aujourd_hui.getFullYear()}-${String(aujourd_hui.getMonth() + 1).padStart(2, '0')}`;
                case 'annuel': return aujourd_hui.getFullYear().toString();
                default: return aujourd_hui.toISOString().split('T')[0];
            }
        }

        // A-t-il payé dans la période courante ?
function aPayePeriode(membre, tontine) {
  const periodeActuelle = obtenirPeriodeActuelle(tontine.frequenceCotisation);
  return (membre.cotisationsPayees || []).some(c =>
    obtenirPeriodeCotisation(c.date, tontine.frequenceCotisation) === periodeActuelle
  );
}

// En retard = pas de paiement dans la période courante
function estEnRetardPeriode(membre, tontine) {
  return !aPayePeriode(membre, tontine);
}


        function estDansLaPeriode(date, periode, frequence) {
            const dateCotisation = new Date(date);
            switch (frequence) {
                case 'quotidien': return date === periode;
                case 'hebdomadaire':
                    const debutSemaine = new Date(periode);
                    const finSemaine = new Date(debutSemaine);
                    finSemaine.setDate(debutSemaine.getDate() + 6);
                    return dateCotisation >= debutSemaine && dateCotisation <= finSemaine;
                case 'mensuel':
                    const [annee, mois] = periode.split('-');
                    return dateCotisation.getFullYear() == annee && (dateCotisation.getMonth() + 1) == mois;
                case 'annuel':
                    return dateCotisation.getFullYear() == periode;
                default: return false;
            }
        }

        function supprimerTontine(id) {
            const tontine = tontines.find(t => t.id === id);
            if (!tontine) return;
            
            const totalCotisations = tontine.cotisations.reduce((sum, c) => sum + c.montant, 0);
            const membresActifs = tontine.membres.filter(m => !m.aGagne).length;
            
            const message = `⚠️ SUPPRESSION DÉFINITIVE ⚠️\n\n` +
                          `Tontine: "${tontine.nom}"\n` +
                          `Type: ${tontine.type}\n` +
                          `Membres: ${tontine.membres.length}/${tontine.nombreMembresMax}\n` +
                          `Membres actifs: ${membresActifs}\n` +
                          `Cotisations collectées: ${totalCotisations.toLocaleString()} FCFA\n` +
                          `Tirages effectués: ${tontine.tirages.length}\n\n` +
                          `⚠️ TOUTES LES DONNÉES SERONT PERDUES ⚠️\n` +
                          `(Membres, cotisations, historique des tirages)\n\n` +
                          `Êtes-vous absolument certain(e) ?`;
            
            if (confirm(message)) {
                // Supprimer les alertes liées
                alertes = alertes.filter(a => a.tontineId !== id);
                
                // Supprimer la tontine
                tontines = tontines.filter(t => t.id !== id);
                
                sauvegarder();
                mettreAJourAffichage();
                
                if (pageActuelle === 'accueil') {
                    afficherTontines();
                }
                
                alert(`✅ Tontine "${tontine.nom}" supprimée définitivement !\n\n` +
                      `📊 Résumé de la suppression:\n` +
                      `• ${tontine.membres.length} membres retirés\n` +
                      `• ${totalCotisations.toLocaleString()} FCFA de cotisations effacées\n` +
                      `• ${tontine.tirages.length} tirages supprimés de l'historique`);
            }
        }

        function mettreAJourAffichage() {
            document.getElementById('nombreTontines').textContent = tontines.filter(t => t.statut === 'active').length;
            verifierAlertes();
        }

        // Fonctions d'édition de tontine
        let membreEnEdition = null;
        let cotisationEnEdition = null;
        
        function ouvrirModaleEditionTontine() {
            if (!tontineActive) return;
            
            // Remplir les champs avec les données actuelles
            document.getElementById('editNomTontine').value = tontineActive.nom;
            document.getElementById('editTypeTontine').value = tontineActive.type;
            document.getElementById('editMontantCotisation').value = tontineActive.montant;
            document.getElementById('editFrequenceCotisation').value = tontineActive.frequenceCotisation;
            document.getElementById('editJourCotisation').value = tontineActive.jourCotisation;
            document.getElementById('editFrequenceTirage').value = tontineActive.frequenceTirage;
            document.getElementById('editNombreMembres').value = tontineActive.nombreMembresMax;
            document.getElementById('editDescriptionTontine').value = tontineActive.description || '';
            
            document.getElementById('modaleEditionTontine').classList.remove('hidden');
        }
        
        function fermerModaleEdition() {
            document.getElementById('modaleEditionTontine').classList.add('hidden');
        }
        
        function sauvegarderEditionTontine() {
            const nom = document.getElementById('editNomTontine').value.trim();
            const type = document.getElementById('editTypeTontine').value;
            const montant = parseFloat(document.getElementById('editMontantCotisation').value);
            const frequenceCot = document.getElementById('editFrequenceCotisation').value;
            const jourCot = document.getElementById('editJourCotisation').value;
            const frequenceTir = document.getElementById('editFrequenceTirage').value;
            const nbMembres = parseInt(document.getElementById('editNombreMembres').value);
            const description = document.getElementById('editDescriptionTontine').value.trim();
            
            if (!nom || !montant || !nbMembres || nbMembres < 2) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            if (nbMembres < tontineActive.membres.length) {
                alert(`Impossible de réduire le nombre de membres en dessous de ${tontineActive.membres.length} (nombre actuel de membres)`);
                return;
            }
            
            // Mettre à jour la tontine
            tontineActive.nom = nom;
            tontineActive.type = type;
            tontineActive.montant = montant;
            tontineActive.frequenceCotisation = frequenceCot;
            tontineActive.jourCotisation = jourCot;
            tontineActive.frequenceTirage = frequenceTir;
            tontineActive.nombreMembresMax = nbMembres;
            tontineActive.description = description;
            
            sauvegarder();
            fermerModaleEdition();
            afficherInfosTontine();
            mettreAJourAffichage();
            
            alert('✅ Tontine modifiée avec succès !');
        }
        
        function supprimerTontineActive() {
            if (!tontineActive) return;
            
            if (!confirm(`Êtes-vous sûr de vouloir supprimer la tontine "${tontineActive.nom}" ?\n\nToutes les données (membres, cotisations, tirages) seront définitivement perdues.`)) {
                return;
            }
            
            // Supprimer la tontine
            tontines = tontines.filter(t => t.id !== tontineActive.id);
            
            // Supprimer les alertes liées à cette tontine
            alertes = alertes.filter(a => a.tontineId !== tontineActive.id);
            
            sauvegarder();
            mettreAJourAlertes();
            
            alert('✅ Tontine supprimée avec succès !');
            
            // Retourner à l'accueil
            ouvrirPage('accueil');
        }
        
        // Fonctions d'édition de membre
        function ouvrirModaleEditionMembre(membreId) {
            let membre;
            
            // Chercher le membre dans la tontine active ou dans la tontine sélectionnée pour les membres
            if (tontineActive) {
                membre = tontineActive.membres.find(m => m.id === membreId);
            } else if (pageActuelle === 'membres') {
                const tontineId = parseInt(document.getElementById('selectTontineMembres').value);
                const tontine = tontines.find(t => t.id === tontineId);
                if (tontine) {
                    membre = tontine.membres.find(m => m.id === membreId);
                    tontineActive = tontine; // Définir temporairement pour l'édition
                }
            }
            
            if (!membre) return;
            
            membreEnEdition = membre;
            
            // Remplir les champs avec les données actuelles
            document.getElementById('editNomMembre').value = membre.nom;
            document.getElementById('editDateAjoutMembre').value = membre.dateAjout.split('T')[0];
            
            document.getElementById('modaleEditionMembre').classList.remove('hidden');
        }
        
        function fermerModaleEditionMembre() {
            document.getElementById('modaleEditionMembre').classList.add('hidden');
            membreEnEdition = null;
        }
        
        function sauvegarderEditionMembre() {
            if (!membreEnEdition) return;
            
            const nom = document.getElementById('editNomMembre').value.trim();
            const dateAjout = document.getElementById('editDateAjoutMembre').value;
            
            if (!nom || !dateAjout) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            // Vérifier que le nom n'existe pas déjà (sauf pour le membre actuel)
            const nomExiste = tontineActive.membres.some(m => 
                m.id !== membreEnEdition.id && m.nom.toLowerCase() === nom.toLowerCase()
            );
            
            if (nomExiste) {
                alert('Un membre avec ce nom existe déjà dans cette tontine');
                return;
            }
            
            // Mettre à jour le membre
            membreEnEdition.nom = nom;
            membreEnEdition.dateAjout = new Date(dateAjout).toISOString();
            
            sauvegarder();
            fermerModaleEditionMembre();
            
            // Rafraîchir l'affichage selon la page actuelle
            if (pageActuelle === 'gestion') {
                afficherMembresTontineGestion();
                mettreAJourSelectMembres();
            } else if (pageActuelle === 'membres') {
                afficherMembresTontine();
            }
            
            alert('✅ Membre modifié avec succès !');
        }

        // Fonctions d'édition de cotisation
        function editerCotisation(cotisationId, tontineId) {
            const tontine = tontines.find(t => t.id === tontineId);
            if (!tontine) return;
            
            const cotisation = tontine.cotisations.find(c => c.id == cotisationId);
            if (!cotisation) return;
            
            const membre = tontine.membres.find(m => m.id === cotisation.membreId);
            if (!membre) return;
            
            cotisationEnEdition = { cotisation, tontine, membre };
            
            // Remplir les champs
            document.getElementById('editMembreCotisation').value = membre.nom;
            document.getElementById('editDateCotisation').value = cotisation.date.split('T')[0];
            document.getElementById('editMontantCotisation').value = cotisation.montant;
            document.getElementById('cotisationUnitaire').textContent = tontine.montant.toLocaleString();
            
            // Calculer l'équivalent
            calculerEquivalentCotisations();
            
            // Écouter les changements de montant
            document.getElementById('editMontantCotisation').oninput = calculerEquivalentCotisations;
            
            document.getElementById('modaleEditionCotisation').classList.remove('hidden');
        }
        
        function calculerEquivalentCotisations() {
            const montant = parseFloat(document.getElementById('editMontantCotisation').value) || 0;
            const montantUnitaire = cotisationEnEdition ? cotisationEnEdition.tontine.montant : 0;
            const equivalent = montantUnitaire > 0 ? (montant / montantUnitaire).toFixed(1) : 0;
            document.getElementById('equivalentCotisations').textContent = equivalent;
        }
        
        function fermerModaleEditionCotisation() {
            document.getElementById('modaleEditionCotisation').classList.add('hidden');
            cotisationEnEdition = null;
        }
        
        function sauvegarderEditionCotisation() {
            if (!cotisationEnEdition) return;
            
            const date = document.getElementById('editDateCotisation').value;
            const montant = parseFloat(document.getElementById('editMontantCotisation').value);
            
            if (!date || !montant || montant <= 0) {
                alert('Veuillez remplir tous les champs avec des valeurs valides');
                return;
            }
            
            const { cotisation, tontine, membre } = cotisationEnEdition;
            
            // Mettre à jour la cotisation
            cotisation.date = new Date(date).toISOString();
            cotisation.montant = montant;
            
            // Mettre à jour dans la liste du membre
            const cotisationMembre = membre.cotisationsPayees.find(c => c.id == cotisation.id);
            if (cotisationMembre) {
                cotisationMembre.date = cotisation.date;
                cotisationMembre.montant = cotisation.montant;
            }
            
            sauvegarder();
            fermerModaleEditionCotisation();
            
            // Rafraîchir l'affichage
            if (pageActuelle === 'gestion') {
                afficherHistoriqueCotisations();
                afficherMembresTontineGestion();
            } else if (pageActuelle === 'membres') {
                afficherMembresTontine();
            }
            
            mettreAJourAlertes();
            
            const equivalent = (montant / tontine.montant).toFixed(1);
            alert(`✅ Cotisation modifiée avec succès !\n\n📊 Détails:\n• Montant: ${montant.toLocaleString()} FCFA\n• Équivalent: ${equivalent} cotisation(s)\n• Date: ${new Date(date).toLocaleDateString('fr-FR')}`);
        }

        function sauvegarder() {
            // Sauvegarder les données spécifiques à l'utilisateur connecté
            sauvegarderDonneesUtilisateur();
            
            // Marquer les données comme modifiées pour la synchronisation
            donneesModifiees = true;
            mettreAJourStatutReseau();
            
            // Tenter une synchronisation immédiate si en ligne
            if (estEnLigne) {
                setTimeout(synchroniserDonnees, 1000);
            }
        }
    
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'972a962a719755aa',t:'MTc1NTc4NDA5MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();
// === Gestion des tirages ===
async function supprimerTirage(tirageId, tontineId) {
    if (!confirm("Supprimer ce tirage ?")) return;

    try {
        await apiFetch(`/tirages/${tirageId}`, { method: "DELETE" });
        alert("✅ Tirage supprimé !");
        chargerTontineTirage();
        mettreAJourAlertes();
    } catch (e) {
        console.error(e);
        alert("❌ Erreur lors de la suppression du tirage");
    }
}
</script>
<script>
// ================= API CONFIG =================
const API_BASE = "https://ma-tontine-backend.onrender.com"; // ton backend Render

function getToken() {
  return localStorage.getItem("token");
}

async function apiFetch(endpoint, options = {}) {
  const headers = options.headers || {};
  headers["Content-Type"] = "application/json";
  const token = getToken();
  if (token) headers["Authorization"] = "Bearer " + token;

  const res = await fetch(API_BASE + endpoint, { ...options, headers });

  if (!res.ok) {
    const err = await res.json().catch(() => ({ error: res.statusText }));
    throw new Error(err.error || "Erreur API");
  }
  return res.json();
}

// Auth helpers
async function login(email, password) {
  const r = await apiFetch("/auth/login", {
    method: "POST",
    body: JSON.stringify({ email, password })
  });
  localStorage.setItem("token", r.token);
}

async function register(email, password) {
  const r = await apiFetch("/auth/register", {
    method: "POST",
    body: JSON.stringify({ email, password })
  });
  localStorage.setItem("token", r.token);
}

// Example usage in place of sauvegarder()
async function sauvegarder() {
  // Désormais, les données se synchronisent via API
  mettreAJourAlertes();
}

</script>


<!-- ===== Backend Integration Overrides (v2) ===== -->
<script>
(function(){
  // === Configuration ===
  const API_BASE = localStorage.getItem('api_base') || 'https://ma-tontine-backend.onrender.com';
  const TOKEN_KEY = 'auth_token';

  function setApiBase(url){
    localStorage.setItem('api_base', url);
    alert('API Base mis à jour: ' + url);
  }
  window.setApiBase = setApiBase;

  function setToken(token){
    if (token) localStorage.setItem(TOKEN_KEY, token);
  }
  function getToken(){
    return localStorage.getItem(TOKEN_KEY) || null;
  }

  async function apiFetch(path, { method='GET', headers={}, body=null } = {}){
    const token = getToken();
    const finalHeaders = Object.assign(
      { 'Content-Type': 'application/json' },
      token ? { 'Authorization': 'Bearer ' + token } : {},
      headers
    );
    const res = await fetch(API_BASE + path, {
      method,
      headers: finalHeaders,
      body: body ? JSON.stringify(body) : null
    });

    if (!res.ok){
      let errText = '';
      try { 
        errText = (await res.json()).error || res.statusText; 
      } catch(e){ 
        errText = res.statusText; 
      }
      const err = new Error(errText);
      err.status = res.status;
      err.response = res;
      throw err;
    }

    const ct = res.headers.get('content-type') || '';
    return ct.includes('application/json') ? res.json() : res.text();
  }

  // === Auth helpers ===
  async function register(email, password){
    const data = await apiFetch('/auth/register', { 
      method: 'POST', 
      body: { email, password } 
    });
    setToken(data.token);
    return data;
  }

  async function login(email, password){
    const data = await apiFetch('/auth/login', { 
      method: 'POST', 
      body: { email, password } 
    });
    setToken(data.token);
    return data;
  }

  window.apiAuth = { register, login, setToken, getToken };

  // === Local composition state (to fit existing UI model) ===
  window.__apiState = {
    tontinesMap: new Map(), // id -> { ...tontine, membres:[], cotisations:[], tirages:[] }
  };
})();


  // Map backend tontine to UI shape
  function mapTontineRow(row){
    return {
      id: row.id,
      nom: row.nom,
      type: row.type,
      montant: Number(row.montant),
      nombreMembresMax: row.membres_max || 0,
      statut: row.statut,
      description: row.description || '',
      // UI collections we keep locally in sync
      membres: [],
      cotisations: [],
      tirages: [],
      gagnants: []
    };
  }

  function ensureTontineInState(row){
    let t = window.__apiState.tontinesMap.get(row.id);
    if (!t){
      t = mapTontineRow(row);
      window.__apiState.tontinesMap.set(row.id, t);
    }else{
      // shallow update
      Object.assign(t, mapTontineRow(row));
      // preserve arrays already loaded
    }
    return t;
  }

  async function loadAllFromApi(){
  // 1) Tontines
  const tontinesRows = await apiFetch('/tontines');
  const composed = [];
  for (const row of tontinesRows){
    const t = ensureTontineInState(row);

    // 2) Membres for tontine
    try{
      const membres = await apiFetch('/membres/' + t.id);
      t.membres = membres.map(m => ({
        id: m.id,
        nom: m.nom + (m.prenom ? (' ' + m.prenom) : ''),
        dateAjout: m.created_at,
        cotisationsPayees: [],
        aGagne: false
      }));
    }catch(e){
      console.warn('Membres load failed for tontine', t.id, e.message);
      t.membres = [];
    }

    // 3) Paiements for tontine
    try{
      const pays = await apiFetch('/paiements/' + t.id);
      t.cotisations = pays.map(p => ({
        id: p.id,
        membreId: p.membre_id,
        date: p.periode,
        montant: Number(p.montant)
      }));
      // fold into membres.cotisationsPayees
      const byM = {};
      for(const c of t.cotisations){
        byM[c.membreId] = byM[c.membreId] || [];
        byM[c.membreId].push({ id: c.id, date: c.date, montant: c.montant });
      }
      for (const m of t.membres){
        m.cotisationsPayees = byM[m.id] || [];
      }
    }catch(e){
      console.warn('Paiements load failed for tontine', t.id, e.message);
      t.cotisations = [];
      for (const m of t.membres){ m.cotisationsPayees = []; }
    }

    // 4) Tirages list — not provided on backend, so we keep local cache
    t.tirages = t.tirages || [];
    t.gagnants = t.gagnants || [];

    composed.push(t);
  }

  // Replace global "tontines" used by your UI, keeping reference name intact
  window.tontines = composed;
  // Try to keep current active tontine if any
  if (window.tontineActive){
    const newActive = composed.find(x => x.id === window.tontineActive.id);
    if (newActive) window.tontineActive = newActive;
  }
  // refresh UI hooks if they exist
  try { if (typeof mettreAJourAffichage === 'function') mettreAJourAffichage(); } catch(e){}
  try { if (typeof afficherTontines === 'function') afficherTontines(); } catch(e){}
}
window.reloadFromApi = loadAllFromApi;

// === Override save (no local persistence, just refresh alerts/UI) ===
const originalSauvegarder = window.sauvegarder || function(){};
window.sauvegarder = function(){
  try { if (typeof sauvegarderDonneesUtilisateur === 'function') sauvegarderDonneesUtilisateur(); } catch(e){}
  window.donneesModifiees = true;
  try { if (typeof mettreAJourStatutReseau === 'function') mettreAJourStatutReseau(); } catch(e){}
  try { if (typeof mettreAJourAlertes === 'function') mettreAJourAlertes(); } catch(e){}
  return true;
};

// === Override: ajouterMembreTontine -> POST /membres/:tontineId ===
window.ajouterMembreTontine = async function(){
  if (!window.tontineActive){ alert('Aucune tontine active'); return; }
  const nom = (document.getElementById('nouveauMembre')?.value || '').trim();
  if (!nom){ alert('Veuillez entrer un nom'); return; }

  // Capacity (soft check — real rules backend-side)
  if (window.tontineActive.membres.length >= (window.tontineActive.nombreMembresMax || 999999)){
    alert('Nombre maximum de membres atteint');
    return;
  }
  try{
    const created = await apiFetch('/membres/' + window.tontineActive.id, {
      method: 'POST',
      body: { nom }
    });
    // Update local state
    window.tontineActive.membres.push({
      id: created.id,
      nom: created.nom,
      dateAjout: created.created_at,
      cotisationsPayees: [],
      aGagne: false
    });
    document.getElementById('nouveauMembre').value = '';
    if (typeof afficherMembresTontineGestion === 'function') afficherMembresTontineGestion();
    if (typeof mettreAJourSelectMembres === 'function') mettreAJourSelectMembres();
    if (typeof mettreAJourAffichage === 'function') mettreAJourAffichage();
    alert('✅ Membre ajouté.');
  }catch(e){
    alert('❌ Échec ajout membre: ' + e.message);
  }
};


  // === Override: enregistrerCotisationTontine -> POST /paiements ===
  // === Enregistrer une cotisation ===
window.enregistrerCotisationTontine = async function() {
  if (!window.tontineActive) {
    alert('Aucune tontine active');
    return;
  }

  const membreId = (document.getElementById('membreCotisationSelect')?.value || '').trim();
  const date = document.getElementById('dateCotisation')?.value;
  if (!membreId || !date) {
    alert('Veuillez sélectionner un membre et une date');
    return;
  }

  try {
    const body = {
      tontine_id: window.tontineActive.id,
      membre_id: membreId,
      montant: window.tontineActive.montant,
      periode: date
    };

    const p = await apiFetch('/paiements', { 
      method: 'POST', 
      body 
    });

    // reflect in local model to keep UI consistent
    const cotisation = { 
      id: p.id, 
      membreId, 
      date: p.periode, 
      montant: Number(p.montant) 
    };

    const membre = window.tontineActive.membres.find(m => m.id === membreId);
    if (membre) {
      membre.cotisationsPayees = membre.cotisationsPayees || [];
      membre.cotisationsPayees.push({ 
        id: p.id, 
        date: p.periode, 
        montant: Number(p.montant) 
      });
    }

    window.tontineActive.cotisations = window.tontineActive.cotisations || [];
    window.tontineActive.cotisations.push(cotisation);

    if (typeof afficherHistoriqueCotisations === 'function') afficherHistoriqueCotisations();
    if (typeof afficherMembresTontineGestion === 'function') afficherMembresTontineGestion();
    if (typeof mettreAJourAlertes === 'function') mettreAJourAlertes();

    alert('✅ Cotisation enregistrée.');
  } catch (e) {
    if (e.status === 409) {
      alert('⚠️ Paiement déjà enregistré pour cette période');
    } else {
      alert('❌ Échec enregistrement: ' + e.message);
    }
  }
};

// === Override: supprimerCotisation -> backend n’a pas (encore) d’endpoint DELETE ===
window.supprimerCotisation = async function(cotisationId, tontineId) {
  alert("Suppression de cotisation non supportée par l'API actuelle. Ajoutez un endpoint DELETE /paiements/:id côté backend pour l'activer.");
};


// === Override: retirerMembreTontine -> DELETE /membres/delete/:id ===
window.retirerMembreTontine = async function (membreId, tontineId) {
  const t = window.tontines?.find(x => x.id === tontineId) || window.tontineActive;
  if (!t) { alert('Tontine introuvable'); return; }
  const membre = t.membres.find(m => m.id === membreId);
  if (!membre) { alert('Membre introuvable'); return; }

  const ok = confirm(`Retirer ${membre.nom} de "${t.nom}" ? (Toutes ses cotisations liées resteront en base)`);
  if (!ok) return;

  try {
    await apiFetch('/membres/delete/' + membreId, { method: 'DELETE' });
    t.membres = t.membres.filter(m => m.id !== membreId);
    // Purge les paiements locaux liés pour rester cohérent dans l’UI
    t.cotisations = (t.cotisations || []).filter(c => c.membreId !== membreId);
    if (typeof afficherMembresTontineGestion === 'function') afficherMembresTontineGestion();
    if (typeof mettreAJourSelectMembres === 'function') mettreAJourSelectMembres();
    if (typeof mettreAJourAlertes === 'function') mettreAJourAlertes();
    alert('✅ Membre retiré.');
  } catch (e) {
    alert('❌ Échec du retrait: ' + e.message);
  }
};

// === Tirage: POST /tirages/run/:tontineId ===
async function effectuerTirage(tontineId) {
  const d = await apiFetch('/tirages/run/' + tontineId, { method: 'POST' });
  return d; // { id, tontine_id, membre_id, ordre, ... }
}
window.effectuerTirage = effectuerTirage;

// Hook bouton "Effectuer le tirage" si votre UI l’appelle via allerAuTirage/ autres
window.executerTirageEtRafraichir = async function () {
  if (!window.tontineActive) { alert('Aucune tontine active'); return; }
  try {
    const res = await effectuerTirage(window.tontineActive.id);
    // MàJ locale: marquer gagnant, pousser dans tirages
    const t = window.tontineActive;
    t.tirages = t.tirages || [];
    t.tirages.push({
      id: res.id,
      gagnantId: res.membre_id,
      date: res.date_tirage || new Date().toISOString(),
      ordre: res.ordre
    });
    const m = t.membres.find(mm => mm.id === res.membre_id);
    if (m) m.aGagne = true;
    if (typeof mettreAJourAlertes === 'function') mettreAJourAlertes();
    alert('🎯 Tirage réussi ! Gagnant mis à jour.');
  } catch (e) {
    alert('❌ Tirage impossible: ' + e.message);
  }
};

// === Initial load: if token present, load data ===
document.addEventListener('DOMContentLoaded', () => {
  if (getToken()) {
    loadAllFromApi().catch(err => console.warn('Initial load failed:', err.message));
  }
});

// === Gestion des tirages ===
async function supprimerTirage(tirageId, tontineId) {
  if (!confirm("Supprimer ce tirage ?")) return;

  try {
    await apiFetch(`/tirages/${tirageId}`, { method: "DELETE" });
    alert("✅ Tirage supprimé !");
    chargerTontineTirage();
    mettreAJourAlertes();
  } catch (e) {
    console.error(e);
    alert("❌ Erreur lors de la suppression du tirage");
  }
}

</script>
<!-- ===== End Backend Integration Overrides ===== -->


<script>
// --- PWA Installation ---
let deferredPrompt;
const installBtn = document.getElementById("installAppBtn") 
                 || document.getElementById("installAppBtnDropdown");
if (installBtn) {
  installBtn.addEventListener("click", (e) => {
    e.preventDefault();
    if (deferredPrompt) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.finally(() => deferredPrompt = null);
    }
  });
}

// ✅ Gestion de l'événement d'installation
window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.classList.remove("hidden"); // rendre visible le bouton
});

installBtn.addEventListener("click", async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === "accepted") {
      console.log("✅ L’utilisateur a installé l’app");
    } else {
      console.log("❌ Installation refusée");
    }
    deferredPrompt = null;
    installBtn.classList.add("hidden");
  }
});

// ✅ Enregistrement du Service Worker
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/pwa/sw.js")
    .then(() => console.log("Service Worker enregistré ✅"))
    .catch(err => console.error("Service Worker échec ❌", err));
}

</script>
<script>
// ===== Correctifs d'intégration backend & PWA (version stable) =====

// --- Base URL & helper fetch ---
if (typeof window.API_BASE === "undefined") {
  window.API_BASE = "https://ma-tontine-backend.onrender.com";
}
if (typeof window.apiFetch === "undefined") {
  window.apiFetch = function(path, options = {}) {
    const token = localStorage.getItem("token");
    const headers = Object.assign({}, options.headers || {});
    if (!headers["Content-Type"] && !(options.body instanceof FormData)) {
      headers["Content-Type"] = "application/json";
    }
    if (token) headers["Authorization"] = "Bearer " + token;
    return fetch(window.API_BASE + path, Object.assign({}, options, { headers }));
  };
}

// --- Auth ---
window.seConnecter = async function(e){
  try{
    if (e && e.preventDefault) e.preventDefault();
    const emailEl = document.getElementById("emailConnexion");
    const passEl  = document.getElementById("motPasseConnexion");
    const email = emailEl ? emailEl.value.trim() : "";
    const password = passEl ? passEl.value : "";
    if (!email || !password) { alert("Veuillez saisir email et mot de passe"); return false; }
    const r = await apiFetch("/auth/login", { method:"POST", body: JSON.stringify({ email, password }) });
    const data = await r.json();
    if (!r.ok) { alert(data.error || "Connexion échouée"); return false; }
    localStorage.setItem("token", data.token);
    await initialiserApplication();
    return false;
  }catch(err){
    console.error(err);
    alert("Erreur de connexion");
    return false;
  }
};

window.sInscrire = async function(e){
  try{
    if (e && e.preventDefault) e.preventDefault();
    const email = (document.getElementById("emailInscription")||{}).value?.trim();
    const password = (document.getElementById("motPasseInscription")||{}).value;
    const confirm  = (document.getElementById("confirmMotPasse")||{}).value;
    if (!email || !password) { alert("Veuillez saisir email et mot de passe"); return false; }
    if (password !== confirm) { alert("Les mots de passe ne correspondent pas"); return false; }
    const r = await apiFetch("/auth/register", { method:"POST", body: JSON.stringify({ email, password }) });
    const data = await r.json();
    if (!r.ok) { alert(data.error || "Inscription échouée"); return false; }
    alert("✅ Compte créé, vous pouvez vous connecter.");
    return false;
  }catch(err){
    console.error(err);
    alert("Erreur d'inscription");
    return false;
  }
};

window.seDeconnecter = function(){
  localStorage.removeItem("token");
  try { sessionStorage.clear(); } catch(e){}
  location.reload();
};

// --- Alertes ---


window.verifierAlertes = async function () {
  if (!localStorage.getItem("token")) {
    console.warn("Pas de token → pas de récupération des alertes");
    const badge = document.getElementById("badgeAlertes");
    if (badge) badge.classList.add("hidden");
    return [];
  }

  try {
    const r = await apiFetch("/alertes");
    if (!r.ok) throw new Error("HTTP " + r.status);
    const data = await r.json();

    if (typeof window.afficherAlertes === "function") {
      window.afficherAlertes(data);
    }

    const badge = document.getElementById("badgeAlertes");
    if (badge) {
      const n = Array.isArray(data) ? data.length : (data?.count || 0);
      badge.textContent = n;
      badge.classList.toggle("hidden", !n);
    }

    return data;
  } catch (err) {
    console.warn("verifierAlertes:", err);
    const badge = document.getElementById("badgeAlertes");
    if (badge) badge.classList.add("hidden");
    return [];
  }
};

window.mettreAJourAlertes = window.verifierAlertes;

// --- Tirages ---
window.supprimerTirage = async function(tirageId, tontineId){
  if(!confirm("Supprimer ce tirage ?")) return;
  try{
    const r = await apiFetch(`/tirages/${tirageId}`, { method:"DELETE" });
    if (!r.ok) throw new Error("HTTP "+r.status);
    alert("✅ Tirage supprimé !");
    if (typeof window.chargerTontineTirage === "function") window.chargerTontineTirage();
    await window.verifierAlertes();
  }catch(err){
    console.error(err);
    alert("❌ Erreur lors de la suppression du tirage");
  }
};

// --- Statut réseau ---
window.mettreAJourStatutReseau = function(){
  const online = navigator.onLine;
  const bandeau = document.getElementById("banniereReseau");
  if (bandeau) bandeau.classList.toggle("hidden", online);
};

// --- Stats + rafraîchissement UI ---
window.mettreAJourAffichage = async function(){
  try{
    // Exemple: vous pouvez appeler un endpoint de résumé si disponible
    // const r = await apiFetch("/dashboard/overview");
    // const stats = (await r.json()) || {};

    // Sinon, on met juste à jour les alertes + quelques compteurs déjà présents en DOM si vous les remplissez ailleurs
    await window.verifierAlertes();

    // Affichage des cartes de stats si elles existent dans le DOM (hors API pour l'instant)
    const elT = document.getElementById("statTotalTontines");
    const elM = document.getElementById("statTotalMembres");
    const elTi = document.getElementById("statTotalTirages");
    // Laissez la logique existante les mettre à jour ailleurs; ici, on ne force rien s'ils n'existent pas.
    // Vous pourrez compléter avec de vraies données si vous exposez un endpoint /dashboard/overview côté backend.
  }catch(e){
    console.warn("mettreAJourAffichage:", e);
  }
};

// --- PWA Install (dropdown + header s'ils existent) ---
(function(){
  let deferredPrompt = null;
  const updateBtn = (show) => {
    ["installAppBtnDropdown","installAppBtn"].forEach(id=>{
      const b = document.getElementById(id);
      if (!b) return;
      b.classList.toggle("hidden", !show);
      b.onclick = async () => {
        try{
          if (!deferredPrompt) return;
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
        }finally{
          deferredPrompt = null;
          updateBtn(false);
        }
      };
    });
  };

  window.addEventListener("beforeinstallprompt", (e)=>{
    e.preventDefault();
    deferredPrompt = e;
    updateBtn(true);
  });
  window.addEventListener("appinstalled", ()=> updateBtn(false));
})();

// --- SW registration (ne duplique pas si déjà fait ailleurs) ---
if ("serviceWorker" in navigator && !navigator.serviceWorker.controller) {
  navigator.serviceWorker.register("/pwa/sw.js").catch(()=>{});
}

// --- Bootstrap au chargement ---
document.addEventListener("DOMContentLoaded", async function(){
  try{
    window.mettreAJourStatutReseau();
    window.addEventListener("online",  window.mettreAJourStatutReseau);
    window.addEventListener("offline", window.mettreAJourStatutReseau);

    const token = localStorage.getItem("token");
    if (token) {
      await window.mettreAJourAffichage();
    } else {
      // Laissez la page de connexion visible; les formulaires appellent seConnecter/sInscrire
      // Rien à faire de plus ici
    }
  }catch(e){
    console.error("Init error:", e);
  }
});
// ===== Fin correctifs =====
</script>
</body>
</html>
