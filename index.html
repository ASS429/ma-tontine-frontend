<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Tontines Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .card-premium {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            box-shadow: 
                20px 20px 60px #d9d9d9,
                -20px -20px 60px #ffffff,
                inset 0 1px 0 rgba(255,255,255,0.6);
            border-radius: 20px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .card-premium:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 
                25px 25px 80px #d0d0d0,
                -25px -25px 80px #ffffff,
                0 25px 50px rgba(0,0,0,0.1);
        }
        
        .btn-gradient {
            background: var(--primary-gradient);
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 15px;
            padding: 12px 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-gradient:hover::before {
            left: 100%;
        }
        
        .btn-gradient:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: var(--success-gradient);
        }
        
        .btn-warning {
            background: var(--warning-gradient);
        }
        
        .btn-danger {
            background: var(--danger-gradient);
        }
        
        .floating-animation {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
                transform: scale(1.05);
            }
        }
        
        .slide-in-right {
            animation: slideInRight 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.8s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: pageTransition 0.5s ease-out;
        }
        
        @keyframes pageTransition {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .nav-button {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: width 0.3s ease;
        }
        
        .nav-button:hover::before {
            width: 100%;
        }
        
        .nav-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .member-card {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border-radius: 20px;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .member-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary-gradient);
        }
        
        .member-card:hover {
            transform: translateY(-8px) rotateX(5deg);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .alert-notification {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            border-radius: 15px;
            animation: alertPulse 2s infinite;
        }
        
        @keyframes alertPulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(255, 154, 158, 0.7);
            }
            70% { 
                box-shadow: 0 0 0 10px rgba(255, 154, 158, 0);
            }
        }
        
        .form-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .form-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }
        
        .winner-announcement {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border-radius: 20px;
            animation: winnerCelebration 1s ease-out;
        }
        
        @keyframes winnerCelebration {
            0% { 
                transform: scale(0.8) rotate(-5deg);
                opacity: 0;
            }
            50% { 
                transform: scale(1.1) rotate(2deg);
            }
            100% { 
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .dice-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .dice {
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            animation: diceRoll 2s ease-in-out;
            position: relative;
        }
        
        @keyframes diceRoll {
            0% { 
                transform: rotateX(0deg) rotateY(0deg) scale(1);
            }
            25% { 
                transform: rotateX(180deg) rotateY(90deg) scale(1.2);
            }
            50% { 
                transform: rotateX(360deg) rotateY(180deg) scale(1.1);
            }
            75% { 
                transform: rotateX(540deg) rotateY(270deg) scale(1.2);
            }
            100% { 
                transform: rotateX(720deg) rotateY(360deg) scale(1);
            }
        }
        
        .dice-glow {
            animation: diceGlow 2s ease-in-out;
        }
        
        @keyframes diceGlow {
            0%, 100% { 
                box-shadow: 
                    0 10px 30px rgba(0, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.6);
            }
            50% { 
                box-shadow: 
                    0 15px 40px rgba(102, 126, 234, 0.6),
                    0 0 30px rgba(102, 126, 234, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.6);
            }
        }
        
        .tontine-card {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border-radius: 25px;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .tontine-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: var(--primary-gradient);
        }
        
        .tontine-card:hover {
            transform: translateY(-15px) scale(1.02);
            box-shadow: 
                0 30px 60px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.05);
        }
        
        .header-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .icon-bounce {
            animation: iconBounce 2s infinite;
        }
        
        @keyframes iconBounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        /* Lisibilit√© renforc√©e pour publics peu alphab√©tis√©s */
html { font-size: 18px; }              /* +12.5% environ */
body { line-height: 1.6; }
input, select, textarea { font-size: 1rem; }
label { font-size: 0.95rem; font-weight: 600; }
.btn-gradient { padding: 14px 22px; font-size: 1rem; }


        /* Bordure contrast√©e pour les banni√®res de statut */
.status-banner { border-left: 6px solid rgba(255,255,255,0.6); }


    </style>
    <script>
  const API_BASE = "https://ma-tontine-backend.onrender.com/api";
</script>
</head>
<body>
    <!-- En-t√™te avec effet glass -->
    <header class="header-glass sticky top-0 z-50 mb-4 md:mb-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 sm:py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <div class="w-12 h-12 sm:w-16 sm:h-16 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 rounded-xl sm:rounded-2xl flex items-center justify-center floating-animation">
                        <span class="text-white font-bold text-lg sm:text-2xl">üéØ</span>
                    </div>
                    <div>
                        <h1 class="text-xl sm:text-2xl md:text-3xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                            Mes Tontines Pro
                        </h1>
                        <p class="text-gray-600 font-medium text-xs sm:text-sm">Gestionnaire Premium</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4 md:space-x-6">
                    <!-- Banni√®re de statut r√©seau -->
                    <div id="banniereReseau" class="hidden fixed top-0 left-0 right-0 bg-orange-500 text-white text-center py-2 text-sm font-medium z-50">
                        üì° Mode hors ligne - Donn√©es locales utilis√©es
                    </div>
                    
                    <div id="infoUtilisateur" class="text-right hidden sm:block">
                        <p class="text-xs sm:text-sm text-gray-600 font-medium">Connect√© en tant que</p>
                        <p class="text-sm sm:text-base font-bold text-gray-800" id="nomUtilisateur">-</p>
                    </div>
                    
                    <div class="text-right hidden sm:block">
                        <p class="text-xs sm:text-sm text-gray-600 font-medium">Tontines Actives</p>
                        <p class="text-xl sm:text-2xl md:text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent" id="nombreTontines">0</p>
                    </div>
                    
                    <button id="btnDeconnexion" onclick="seDeconnecter()" class="btn-gradient btn-danger text-sm sm:text-base px-3 sm:px-4 py-2 sm:py-3 hidden">
                        üö™ D√©connexion
                    </button>
                    
                    <button id="btnRetour" onclick="retourAccueil()" class="hidden btn-gradient text-sm sm:text-base px-3 sm:px-4 py-2 sm:py-3">
                        ‚Üê Retour
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6">
        <!-- PAGE CONNEXION -->
        <div id="page-connexion" class="page active">
            <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                <div class="max-w-md w-full space-y-8">
                    <div class="card-premium p-8 fade-in-up">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 floating-animation">
                                <span class="text-white font-bold text-3xl">üéØ</span>
                            </div>
                            <h2 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                                Connexion
                            </h2>
                            <p class="text-gray-600 font-medium mt-2">Acc√©dez √† vos tontines</p>
                        </div>
                        
                        <form onsubmit="seConnecter(event)" class="space-y-6">
  <div>
    <label class="block text-sm font-semibold text-gray-700 mb-3">Email</label>
    <input 
      type="email" 
      id="emailConnexion" 
      required 
      placeholder="votre@email.com" 
      class="form-input w-full"
    >
  </div>

  <div>
    <label class="block text-sm font-semibold text-gray-700 mb-3">Mot de passe</label>
    <input 
      type="password" 
      id="motPasseConnexion" 
      required 
      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
      class="form-input w-full"
    >
  </div>

  <button type="submit" class="btn-gradient w-full py-4 rounded-xl text-lg font-bold">
    üîê Se connecter
  </button>

  <button 
    type="button" 
    onclick="testerBackend()" 
    class="btn-gradient w-full py-3 rounded-xl font-medium bg-blue-600 hover:bg-blue-700 text-white"
  >
    ‚ö° Tester Backend
  </button>
</form>

                        
                        <div class="mt-6 text-center">
                            <p class="text-gray-600">Pas encore de compte ?</p>
                            <button onclick="ouvrirPageInscription()" class="text-blue-600 hover:text-blue-800 font-semibold mt-2">
                                Cr√©er un compte
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE INSCRIPTION -->
        <div id="page-inscription" class="page">
            <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                <div class="max-w-md w-full space-y-8">
                    <div class="card-premium p-8 fade-in-up">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 bg-gradient-to-r from-green-400 to-blue-500 rounded-2xl flex items-center justify-center mx-auto mb-4 floating-animation">
                                <span class="text-white font-bold text-3xl">üë§</span>
                            </div>
                            <h2 class="text-3xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
                                Inscription
                            </h2>
                            <p class="text-gray-600 font-medium mt-2">Cr√©ez votre compte</p>
                        </div>
                        
                        <form onsubmit="sInscrire(event)" class="space-y-6">
  <div>
    <label class="block text-sm font-semibold text-gray-700 mb-3">Nom complet</label>
    <input 
      type="text" 
      id="nomInscription" 
      required 
      placeholder="Jean Dupont" 
      class="form-input w-full"
    >
  </div>

  <div>
    <label class="block text-sm font-semibold text-gray-700 mb-3">Email</label>
    <input 
      type="email" 
      id="emailInscription" 
      required 
      placeholder="votre@email.com" 
      class="form-input w-full"
    >
  </div>

  <div>
    <label class="block text-sm font-semibold text-gray-700 mb-3">Mot de passe</label>
    <input 
      type="password" 
      id="motPasseInscription" 
      required 
      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
      class="form-input w-full" 
      minlength="6"
    >
    <p class="text-xs text-gray-500 mt-1">Minimum 6 caract√®res</p>
  </div>

  <div>
    <label class="block text-sm font-semibold text-gray-700 mb-3">Confirmer le mot de passe</label>
    <input 
      type="password" 
      id="confirmMotPasse" 
      required 
      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
      class="form-input w-full" 
      minlength="6"
    >
  </div>

  <button type="submit" class="btn-gradient btn-success w-full py-4 rounded-xl text-lg font-bold">
    ‚úÖ Cr√©er mon compte
  </button>
</form>

                        
                        <div class="mt-6 text-center">
                            <p class="text-gray-600">D√©j√† un compte ?</p>
                            <button onclick="ouvrirPageConnexion()" class="text-blue-600 hover:text-blue-800 font-semibold mt-2">
                                Se connecter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE ACCUEIL -->
        <div id="page-accueil" class="page">
            <!-- Navigation principale avec effets glass -->
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-3 sm:gap-4 md:gap-6 mb-8 md:mb-12">
                <button onclick="ouvrirPage('creer')" class="nav-button text-white p-4 sm:p-5 md:p-6 rounded-xl md:rounded-2xl text-center relative z-10">
                    <div class="text-2xl sm:text-3xl md:text-4xl mb-1 md:mb-2 icon-bounce">‚ûï</div>
                    <div class="font-semibold text-xs sm:text-sm md:text-base">Cr√©er</div>
                </button>
                <button onclick="ouvrirPage('gestion')" class="nav-button text-white p-4 sm:p-5 md:p-6 rounded-xl md:rounded-2xl text-center relative z-10">
                    <div class="text-2xl sm:text-3xl md:text-4xl mb-1 md:mb-2 icon-bounce" style="animation-delay: 0.2s">‚öôÔ∏è</div>
                    <div class="font-semibold text-xs sm:text-sm md:text-base">G√©rer</div>
                </button>
                <button onclick="ouvrirPage('membres')" class="nav-button text-white p-4 sm:p-5 md:p-6 rounded-xl md:rounded-2xl text-center relative z-10">
                    <div class="text-2xl sm:text-3xl md:text-4xl mb-1 md:mb-2 icon-bounce" style="animation-delay: 0.4s">üë•</div>
                    <div class="font-semibold text-xs sm:text-sm md:text-base">Membres</div>
                </button>
                <button onclick="ouvrirPage('tirages')" class="nav-button text-white p-4 sm:p-5 md:p-6 rounded-xl md:rounded-2xl text-center relative z-10">
                    <div class="text-2xl sm:text-3xl md:text-4xl mb-1 md:mb-2 icon-bounce" style="animation-delay: 0.6s">üé≤</div>
                    <div class="font-semibold text-xs sm:text-sm md:text-base">Tirages</div>
                </button>
                <button onclick="ouvrirPage('statistiques')" class="nav-button text-white p-4 sm:p-5 md:p-6 rounded-xl md:rounded-2xl text-center relative z-10">
                    <div class="text-2xl sm:text-3xl md:text-4xl mb-1 md:mb-2 icon-bounce" style="animation-delay: 0.8s">üìä</div>
                    <div class="font-semibold text-xs sm:text-sm md:text-base">Stats</div>
                </button>
                <button onclick="ouvrirPage('alertes')" class="nav-button text-white p-4 sm:p-5 md:p-6 rounded-xl md:rounded-2xl text-center relative z-10">
                    <div class="text-2xl sm:text-3xl md:text-4xl mb-1 md:mb-2 icon-bounce" style="animation-delay: 1s">üîî</div>
                    <div class="font-semibold text-xs sm:text-sm md:text-base">Alertes</div>
                    <div id="badgeAlertes" class="absolute -top-1 -right-1 sm:-top-2 sm:-right-2 bg-red-500 text-white text-xs rounded-full w-6 h-6 sm:w-8 sm:h-8 flex items-center justify-center font-bold hidden pulse-glow">0</div>
                </button>
            </div>

            <!-- Liste des tontines avec design premium -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-8" id="listeTontines">
                <!-- Les tontines seront affich√©es ici -->
            </div>
        </div>

       <!-- PAGE CR√âER TONTINE (version pas √† pas) -->
<div id="page-creer" class="page">
  <div class="card-premium p-6 sm:p-8 fade-in-up max-w-2xl mx-auto">
    
    <!-- En-t√™te -->
    <div class="text-center mb-8">
      <div class="w-20 h-20 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 floating-animation">
        <span class="text-white text-3xl">‚ûï</span>
      </div>
      <h2 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
        Cr√©er une Nouvelle Tontine
      </h2>
      <p class="text-gray-600 text-sm mt-1">√âtape <span id="etapeNum">1</span> / 4</p>
    </div>

    <!-- Etapes -->
    <div id="etape-1" class="etape space-y-6">
      <div>
        <label class="block font-semibold mb-2">Nom de la Tontine</label>
        <input type="text" id="nomTontine" placeholder="Ex: Tontine Famille" class="form-input w-full">
      </div>
      <div>
        <label class="block font-semibold mb-2">Type de Tontine</label>
        <select id="typeTontine" class="form-input w-full">
          <option value="argent">üí∞ Argent</option>
          <option value="electronique">üì± √âlectronique</option>
          <option value="cosmetique">üíÑ Cosm√©tiques</option>
          <option value="autre">üéÅ Autre</option>
        </select>
      </div>
    </div>

    <div id="etape-2" class="etape hidden space-y-6">
      <div>
        <label class="block font-semibold mb-2">Montant par Cotisation</label>
        <input type="number" id="montantCotisation" placeholder="Ex: 5000" class="form-input w-full">
      </div>
      <div>
        <label class="block font-semibold mb-2">Fr√©quence des Cotisations</label>
        <select id="frequenceCotisation" class="form-input w-full">
          <option value="quotidien">üìÖ Quotidien</option>
          <option value="hebdomadaire">üìÜ Hebdomadaire</option>
          <option value="mensuel">üóìÔ∏è Mensuel</option>
          <option value="annuel">üìã Annuel</option>
        </select>
      </div>
    </div>

    <div id="etape-3" class="etape hidden space-y-6">
      <div>
        <label class="block font-semibold mb-2">Jour de Cotisation</label>
        <select id="jourCotisation" class="form-input w-full">
          <option value="lundi">Lundi</option>
          <option value="mardi">Mardi</option>
          <option value="mercredi">Mercredi</option>
          <option value="jeudi">Jeudi</option>
          <option value="vendredi">Vendredi</option>
          <option value="samedi">Samedi</option>
          <option value="dimanche">Dimanche</option>
          <option value="1">1er du mois</option>
          <option value="10">10 du mois</option>
          <option value="20">20 du mois</option>
        </select>
      </div>
      <div>
        <label class="block font-semibold mb-2">Fr√©quence des Tirages</label>
        <select id="frequenceTirage" class="form-input w-full">
          <option value="hebdomadaire">üìÜ Hebdomadaire</option>
          <option value="mensuel">üóìÔ∏è Mensuel</option>
          <option value="trimestriel">üìä Trimestriel</option>
        </select>
      </div>
    </div>

    <div id="etape-4" class="etape hidden space-y-6">
      <div>
        <label class="block font-semibold mb-2">Nombre de Membres</label>
        <input type="number" id="nombreMembres" placeholder="Ex: 10" min="2" max="50" class="form-input w-full">
      </div>
      <div>
        <label class="block font-semibold mb-2">Description (optionnel)</label>
        <textarea id="descriptionTontine" placeholder="D√©tails sur la tontine..." class="form-input w-full h-24 resize-none"></textarea>
      </div>
    </div>

    <!-- Navigation √©tapes -->
    <div class="flex justify-between mt-8">
      <button id="btnPrev" onclick="changerEtape(-1)" class="btn-gradient px-6 py-3 rounded-xl hidden">‚¨ÖÔ∏è Retour</button>
      <button id="btnNext" onclick="changerEtape(1)" class="btn-gradient btn-success px-6 py-3 rounded-xl">Suivant ‚û°Ô∏è</button>
      <button id="btnCreate" onclick="creerTontine()" class="btn-gradient btn-success px-6 py-3 rounded-xl hidden">‚úÖ Cr√©er la Tontine</button>
    </div>
  </div>
</div>
        <!-- PAGE GESTION -->
        <div id="page-gestion" class="page">
            <div class="card-premium p-8 mb-8 fade-in-up">
                <h2 class="text-3xl font-bold bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent mb-6 text-center">
                    ‚öôÔ∏è Gestion des Tontines
                </h2>
                <select id="selectTontineGestion" onchange="chargerTontineGestion()" class="form-input w-full text-lg">
                    <option value="">Choisir une tontine...</option>
                </select>
            </div>
            
            <div id="panneauGestion" class="hidden space-y-8">
                <!-- Informations de la tontine -->
                <div class="card-premium p-8 slide-in-right">
                    <div id="infosTontine"></div>
                </div>
                
                <!-- Gestion des membres -->
                <div class="card-premium p-8 slide-in-right" style="animation-delay: 0.2s">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">üë• Membres</h3>
                    </div>
                    <div class="flex gap-4 mb-6">
                        <input type="text" id="nouveauMembre" placeholder="Nom du nouveau membre" class="form-input flex-1">
                        <button onclick="ajouterMembreTontine()" class="btn-gradient btn-success px-8 py-3 rounded-xl">Ajouter</button>
                    </div>
                    <div id="listeMembresTontineGestion" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6"></div>
                </div>
                
                <!-- Cotisations -->
                <div class="card-premium p-8 slide-in-right" style="animation-delay: 0.4s">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">üíµ Enregistrer Cotisation</h3>
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <select id="membreCotisationSelect" class="form-input">
                            <option value="">Choisir un membre</option>
                        </select>
                        <input type="date" id="dateCotisation" class="form-input">
                        <button onclick="enregistrerCotisationTontine()" class="btn-gradient btn-success px-6 py-3 rounded-xl">Enregistrer</button>
                    </div>
                    <div id="historiqueCotisations" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- PAGE MEMBRES -->
        <div id="page-membres" class="page">
            <div class="card-premium p-8 mb-8 fade-in-up">
                <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-6 text-center">
                    üë• Vue d'ensemble des Membres
                </h2>
                <select id="selectTontineMembres" onchange="afficherMembresTontine()" class="form-input w-full text-lg">
                    <option value="">Choisir une tontine...</option>
                </select>
            </div>
            
            <div id="panneauMembres" class="hidden">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-8" id="cartesMembres">
                    <!-- Les cartes des membres seront affich√©es ici -->
                </div>
            </div>
        </div>

        <!-- PAGE TIRAGES -->
        <div id="page-tirages" class="page">
            <div class="card-premium p-8 mb-8 fade-in-up">
                <h2 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-8 text-center">
                    üé≤ Tirages Automatiques
                </h2>
                
                <div class="mb-8">
                    <select id="selectTontineTirage" onchange="chargerTontineTirage()" class="form-input w-full text-lg">
                        <option value="">Choisir une tontine pour le tirage...</option>
                    </select>
                </div>
                
                <div id="panneauTirage" class="hidden">
                    <div class="grid md:grid-cols-2 gap-8 mb-8">
                        <div class="card-premium p-6 slide-in-right">
                            <h3 class="text-xl font-bold text-gray-700 mb-4">Membres √âligibles</h3>
                            <div id="membresEligibles" class="space-y-3"></div>
                        </div>
                        <div class="card-premium p-6 slide-in-right" style="animation-delay: 0.2s">
                            <h3 class="text-xl font-bold text-gray-700 mb-4">Historique des Gagnants</h3>
                            <div id="historiqueGagnants" class="space-y-3"></div>
                        </div>
                    </div>
                    
                    <div class="card-premium p-8 text-center">
                        <div id="infoTirage" class="mb-6"></div>
                        <button onclick="effectuerTirage()" id="btnTirage" class="btn-gradient text-2xl px-12 py-6 rounded-2xl font-bold">
                            üé≤ Effectuer le Tirage
                        </button>
                        
                        <div id="animationDe" class="dice-container hidden">
                            <div class="dice dice-glow">
                                üé≤
                            </div>
                        </div>
                        
                        <div id="resultatTirage" class="mt-8 hidden">
                            <div class="winner-announcement p-8 text-center">
                                <div class="text-6xl mb-4">üéâ</div>
                                <div class="text-3xl font-bold text-gray-800" id="gagnantTirage"></div>
                                <div class="text-xl text-gray-700" id="montantGagne"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE STATISTIQUES -->
        <div id="page-statistiques" class="page">
            <div class="space-y-8">
                <div class="card-premium p-8 fade-in-up">
                    <h2 class="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-8 text-center">
                        üìä Tableau de Bord Premium
                    </h2>
                    
                    <!-- M√©triques principales -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 mb-8">
                        <div class="stat-card p-4 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-blue-500 to-blue-600 bg-clip-text text-transparent" id="statTotalTontines">0</div>
                            <div class="text-xs text-gray-600 font-medium mt-1">Tontines Actives</div>
                        </div>
                        <div class="stat-card p-4 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-green-500 to-green-600 bg-clip-text text-transparent" id="statTotalMembres">0</div>
                            <div class="text-xs text-gray-600 font-medium mt-1">Total Membres</div>
                        </div>
                        <div class="stat-card p-4 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-purple-500 to-purple-600 bg-clip-text text-transparent" id="statTotalCotisations">0</div>
                            <div class="text-xs text-gray-600 font-medium mt-1">FCFA Collect√©s</div>
                        </div>
                        <div class="stat-card p-4 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-orange-500 to-orange-600 bg-clip-text text-transparent" id="statTotalTirages">0</div>
                            <div class="text-xs text-gray-600 font-medium mt-1">Tirages Effectu√©s</div>
                        </div>
                        <div class="stat-card p-4 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-red-500 to-red-600 bg-clip-text text-transparent" id="statRetards">0</div>
                            <div class="text-xs text-gray-600 font-medium mt-1">‚ö†Ô∏è Retards</div>
                        </div>
                        <div class="stat-card p-4 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-yellow-500 to-yellow-600 bg-clip-text text-transparent" id="statCyclesRetard">0</div>
                            <div class="text-xs text-gray-600 font-medium mt-1">‚è≥ Cycles Retard</div>
                        </div>
                        <div class="stat-card p-4 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-indigo-500 to-indigo-600 bg-clip-text text-transparent" id="statPaiementsAttente">0</div>
                            <div class="text-xs text-gray-600 font-medium mt-1">üí≥ Paiements</div>
                        </div>
                        <div class="stat-card p-4 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-emerald-500 to-emerald-600 bg-clip-text text-transparent" id="statTiragesDisponibles">0</div>
                            <div class="text-xs text-gray-600 font-medium mt-1">üé≤ Tirages Dispo</div>
                        </div>
                    </div>
                </div>

                <!-- Graphiques -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                    <div class="card-premium p-8 slide-in-right">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">R√©partition par Type</h3>
                        <div class="relative h-80 w-full">
                            <canvas id="graphiqueTypes"></canvas>
                        </div>
                    </div>
                    <div class="card-premium p-8 slide-in-right" style="animation-delay: 0.2s">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">√âvolution des Cotisations</h3>
                        <div class="relative h-80 w-full">
                            <canvas id="graphiqueCotisations"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Tableau d√©taill√© -->
                <div class="card-premium p-8 slide-in-right" style="animation-delay: 0.4s">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Performance des Tontines</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                                <tr>
                                    <th class="text-left p-3 font-semibold">Tontine</th>
                                    <th class="text-left p-3 font-semibold">Type</th>
                                    <th class="text-left p-3 font-semibold">Progression Membres</th>
                                    <th class="text-left p-3 font-semibold">Cotisations</th>
                                    <th class="text-left p-3 font-semibold">Progression Tirages</th>
                                    <th class="text-left p-3 font-semibold">Statut</th>
                                </tr>
                            </thead>
                            <tbody id="tableauPerformance">
                                <!-- Les donn√©es seront ajout√©es ici -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- R√©sum√© des alertes int√©gr√© -->
                <div class="card-premium p-8 slide-in-right" style="animation-delay: 0.6s">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">üìä R√©sum√© des Alertes</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="resumeAlertes">
                        <!-- Le r√©sum√© sera g√©n√©r√© ici -->
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE ALERTES -->
        <div id="page-alertes" class="page">
            <div class="card-premium p-8 fade-in-up">
                <h2 class="text-3xl font-bold bg-gradient-to-r from-red-600 to-pink-600 bg-clip-text text-transparent mb-8 text-center">
                    üîî Alertes et Notifications
                </h2>
                <div id="listeAlertes" class="space-y-6"></div>
            </div>
        </div>
    </div>

    <!-- Modale d'√©dition de tontine -->
    <div id="modaleEditionTontine" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 md:p-8 max-w-2xl w-full card-premium max-h-[90vh] overflow-y-auto">
            <h3 class="text-3xl font-bold text-gray-800 mb-8 text-center">‚úèÔ∏è √âditer la Tontine</h3>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Nom de la Tontine</label>
                        <input type="text" id="editNomTontine" class="form-input w-full">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Type de Tontine</label>
                        <select id="editTypeTontine" class="form-input w-full">
                            <option value="argent">üí∞ Argent</option>
                            <option value="electronique">üì± √âlectronique</option>
                            <option value="cosmetique">üíÑ Cosm√©tiques</option>
                            <option value="autre">üéÅ Autre</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Montant/Valeur par Cotisation</label>
                        <input type="number" id="editMontantCotisation" class="form-input w-full">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Fr√©quence des Cotisations</label>
                        <select id="editFrequenceCotisation" class="form-input w-full">
                            <option value="quotidien">üìÖ Quotidien</option>
                            <option value="hebdomadaire">üìÜ Hebdomadaire</option>
                            <option value="mensuel">üóìÔ∏è Mensuel</option>
                            <option value="annuel">üìã Annuel</option>
                        </select>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Jour de Cotisation</label>
                        <select id="editJourCotisation" class="form-input w-full">
                            <option value="lundi">Lundi</option>
                            <option value="mardi">Mardi</option>
                            <option value="mercredi">Mercredi</option>
                            <option value="jeudi">Jeudi</option>
                            <option value="vendredi">Vendredi</option>
                            <option value="samedi">Samedi</option>
                            <option value="dimanche">Dimanche</option>
                            <option value="1">1er du mois</option>
                            <option value="5">5 du mois</option>
                            <option value="10">10 du mois</option>
                            <option value="15">15 du mois</option>
                            <option value="20">20 du mois</option>
                            <option value="25">25 du mois</option>
                            <option value="30">30 du mois</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Fr√©quence des Tirages</label>
                        <select id="editFrequenceTirage" class="form-input w-full">
                            <option value="hebdomadaire">üìÜ Hebdomadaire</option>
                            <option value="mensuel">üóìÔ∏è Mensuel</option>
                            <option value="trimestriel">üìä Trimestriel</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre de Membres Max</label>
                        <input type="number" id="editNombreMembres" min="2" max="50" class="form-input w-full">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                        <textarea id="editDescriptionTontine" class="form-input w-full h-24 resize-none"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4 mt-8">
                <button onclick="fermerModaleEdition()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-6 rounded-xl font-medium transition-colors">
                    Annuler
                </button>
                <button onclick="sauvegarderEditionTontine()" class="flex-1 btn-gradient btn-success py-3 px-6 rounded-xl font-medium">
                    ‚úÖ Sauvegarder
                </button>
            </div>
        </div>
    </div>

    <!-- Modale d'√©dition de membre -->
    <div id="modaleEditionMembre" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 md:p-8 max-w-md w-full card-premium">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">‚úèÔ∏è √âditer le Membre</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nom du membre</label>
                    <input type="text" id="editNomMembre" class="form-input w-full">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Date d'ajout</label>
                    <input type="date" id="editDateAjoutMembre" class="form-input w-full">
                </div>
            </div>
            
            <div class="flex gap-4 mt-8">
                <button onclick="fermerModaleEditionMembre()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-6 rounded-xl font-medium transition-colors">
                    Annuler
                </button>
                <button onclick="sauvegarderEditionMembre()" class="flex-1 btn-gradient btn-success py-3 px-6 rounded-xl font-medium">
                    ‚úÖ Sauvegarder
                </button>
            </div>
        </div>
    </div>

    <!-- Modale d'√©dition de cotisation -->
    <div id="modaleEditionCotisation" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 md:p-8 max-w-md w-full card-premium">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">üí∞ √âditer la Cotisation</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Membre</label>
                    <input type="text" id="editMembreCotisation" class="form-input w-full bg-gray-100" readonly>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Date de cotisation</label>
                    <input type="date" id="editDateCotisation" class="form-input w-full">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Montant (FCFA)</label>
                    <input type="number" id="editMontantCotisation" class="form-input w-full" min="0" step="100">
                    <div class="text-xs text-gray-500 mt-1">
                        <div>Cotisation unitaire: <span id="cotisationUnitaire"></span> FCFA</div>
                        <div>√âquivalent: <span id="equivalentCotisations"></span> cotisation(s)</div>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4 mt-8">
                <button onclick="fermerModaleEditionCotisation()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-6 rounded-xl font-medium transition-colors">
                    Annuler
                </button>
                <button onclick="sauvegarderEditionCotisation()" class="flex-1 btn-gradient btn-success py-3 px-6 rounded-xl font-medium">
                    ‚úÖ Sauvegarder
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ‚ö†Ô∏è Remplace par les valeurs de ton projet
  const SUPABASE_URL = 'https://fcefsbpqyymxgjaijbka.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjZWZzYnBxeXlteGdqYWlqYmthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MjQ2NTQsImV4cCI6MjA3MTQwMDY1NH0.B_Ys0FuZv5FPkFs8LkX_hNxW-MrXcKvI36owIE-eO8M';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function testerBackend() {
  // 1. Connexion (ou inscription si le compte n‚Äôexiste pas encore)
  const { data, error } = await sb.auth.signInWithPassword({
    email: "testuser@example.com",   // remplace par un vrai email
    password: "motdepasse123"        // remplace par ton mot de passe
  });

  if (error) {
    console.error("Erreur connexion:", error);
    alert("‚ùå Connexion impossible: " + error.message);
    return;
  }

  // 2. R√©cup√©rer le token JWT
  const token = data.session.access_token;
  console.log("‚úÖ Token JWT:", token);

  // 3. Appeler ton backend Render
  const res = await fetch("https://ma-tontine-backend.onrender.com/api/tontines", {
    headers: {
      "Authorization": `Bearer ${token}`
    }
  });

  const json = await res.json();
  console.log("üì° R√©ponse backend:", json);
  alert("Backend OK ! R√©ponse: " + JSON.stringify(json));
}

</script>


    <script>
        // Syst√®me d'authentification
        let utilisateurConnecte = null; 

        // Variables pour la synchronisation r√©seau
        let estEnLigne = navigator.onLine;
        let donneesModifiees = false;
        let derniereSynchronisation = null;

        const utilisateurs = [];    

        // --- Hash SHA-256 pour mots de passe (stockage local s√©curis√©) ---
async function hashPassword(plain) {
  const bytes = new TextEncoder().encode(plain);
  const digest = await crypto.subtle.digest('SHA-256', bytes);
  return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2,'0')).join('');
}


document.addEventListener('DOMContentLoaded', async () => {
  // V√©rifie si l‚Äôutilisateur est d√©j√† connect√© avec Supabase
  const { data, error } = await sb.auth.getUser();
  if (data?.user) {
    utilisateurConnecte = {
      id: data.user.id,
      nom: data.user.user_metadata?.nom_complet || (data.user.email || '').split('@')[0],
      email: data.user.email
    };

    // Charger les donn√©es depuis Supabase
    await chargerDepuisSupabase();
    initialiserApplication();
    afficherInterfaceConnectee();
  } else {
    // Sinon afficher la page de connexion
    afficherPageConnexion();
  }

  // ‚ö° Garde la mise √† jour des alertes en continu
  setInterval(mettreAJourAlertes, 5 * 60 * 1000);
});

        // Syst√®me d'authentification

        async function seConnecter(event) {
  event.preventDefault();
  const email = document.getElementById('emailConnexion').value.trim();
  const motPasse = document.getElementById('motPasseConnexion').value;

  if (!email || !motPasse) return alert('Remplissez tous les champs.');

  const { data, error } = await sb.auth.signInWithPassword({ email, password: motPasse });
  if (error) return alert('Connexion impossible: ' + error.message);

  const { user } = data;
  utilisateurConnecte = {
    id: user.id,
    nom: user.user_metadata?.nom_complet || (user.email || '').split('@')[0],
    email: user.email
  };

  // üîπ S‚Äôassurer qu‚Äôun profil existe dans la table "utilisateurs"
  const { data: profil, error: profilError } = await sb
    .from('utilisateurs')
    .select('*')
    .eq('id', user.id)
    .single();

  if (!profil && !profilError) {
    await sb.from('utilisateurs').insert({
      id: user.id,
      nom_complet: utilisateurConnecte.nom,
      email: utilisateurConnecte.email
    });
  }

  await chargerDepuisSupabase();  
  initialiserApplication();
  afficherInterfaceConnectee();
}

        async function sInscrire(event) {
  event.preventDefault();
  const nom = document.getElementById('nomInscription').value.trim();
  const email = document.getElementById('emailInscription').value.trim();
  const motPasse = document.getElementById('motPasseInscription').value;
  const confirm = document.getElementById('confirmMotPasse').value;

  if (!nom || !email || !motPasse || !confirm) return alert('Remplissez tous les champs.');
  if (motPasse !== confirm) return alert('Les mots de passe ne correspondent pas.');
  if (motPasse.length < 6) return alert('Mot de passe trop court.');

  // üîπ Cr√©ation de l'utilisateur dans Supabase Auth
  const { data, error } = await sb.auth.signUp({
    email,
    password: motPasse,
    options: { data: { nom_complet: nom } }
  });

  if (error) return alert('Inscription impossible: ' + error.message);

  const user = data.user;
  if (user) {
    // üîπ Cr√©ation du profil dans ta table "utilisateurs"
    const { error: e2 } = await sb.from('utilisateurs')
      .insert({ id: user.id, nom_complet: nom, email: email });

    if (e2) console.warn('‚ö†Ô∏è Profil non cr√©√© (utilisateurs):', e2.message);
  }

  alert('‚úÖ Compte cr√©√© ! V√©rifie tes mails si la confirmation est activ√©e.');
}

        async function seDeconnecter() {
  if (!confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) return;
  await sb.auth.signOut();
  utilisateurConnecte = null;
  tontines = [];
  alertes = [];
  tontineActive = null;
  pageActuelle = 'connexion';
  afficherPageConnexion();
  alert('‚úÖ D√©connexion r√©ussie !');
}

        function ouvrirPageConnexion() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-connexion').classList.add('active');
            pageActuelle = 'connexion';
        }

        function ouvrirPageInscription() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-inscription').classList.add('active');
            pageActuelle = 'inscription';
        }

        function afficherPageConnexion() {
            // Masquer l'en-t√™te et afficher la page de connexion
            document.querySelector('header').style.display = 'none';
            ouvrirPageConnexion();
        }

        function afficherInterfaceConnectee() {
            // Afficher l'en-t√™te et les √©l√©ments connect√©s
            document.querySelector('header').style.display = 'block';
            document.getElementById('infoUtilisateur').classList.remove('hidden');
            document.getElementById('btnDeconnexion').classList.remove('hidden');
            document.getElementById('nomUtilisateur').textContent = utilisateurConnecte.nom;
            
            // Aller √† l'accueil
            ouvrirPage('accueil');
        }

// -------- DATA LAYER --------
async function chargerDepuisSupabase() {
  if (!utilisateurConnecte) return;
  // R√©cup√©rer toutes les tontines de l‚Äôutilisateur + membres + cotisations
  const { data: rows, error } = await sb
    .from('tontines')
    .select(`
      id, nom, type, montant_cotisation, frequence_cotisation, jour_cotisation,
      frequence_tirage, nombre_membres, description, cree_le,
      membres ( id, nom, cree_le ),
      cotisations ( id, membre_id, montant, date_cotisation ),
      tirages ( id, membre_id, date_tirage )
    `)
    .order('cree_le', { ascending: true });

  if (error) {
    console.error(error);
    return alert('Erreur au chargement des donn√©es: ' + error.message);
  }

  // Mapper vers ta structure actuelle (pour ne pas toucher √† ton UI)
  tontines = (rows || []).map(mapTontineRowToLocal);

  // Reconstituer cotisationsPayees par membre (comme aujourd‚Äôhui)
  tontines.forEach(t => {
    (t.cotisations || []).forEach(c => {
      const m = t.membres.find(mm => mm.id === c.membreId);
      if (m) m.cotisationsPayees.push({ id: c.id, date: c.date, montant: c.montant });
    });
  });
}

function mapTontineRowToLocal(r) {
  const membres = (r.membres || []).map(m => ({
    id: m.id,
    nom: m.nom,
    aGagne: false,               // sera pilot√© par la table 'tirages' si tu l‚Äôajoutes
    dateAjout: m.cree_le,
    cotisationsPayees: []
  }));

  const cotisations = (r.cotisations || []).map(c => ({
    id: c.id,
    membreId: c.membre_id,
    montant: Number(c.montant),
    date: new Date(c.date_cotisation).toISOString()
  }));

  const tirages = (r.tirages || []).map(t => ({
  id: t.id,
  gagnantId: t.membre_id,
  date: new Date(t.date_tirage).toISOString()
}));

const gagnants = tirages.map(tr => {
  const membre = (r.membres || []).find(m => m.id === tr.membre_id);
  return {
    gagnantId: tr.gagnantId,
    nom: membre?.nom || "Inconnu",
    date: tr.date
  };
});

  return {
    id: r.id,
    nom: r.nom,
    type: r.type,
    montant: Number(r.montant_cotisation || 0),
    frequenceCotisation: r.frequence_cotisation,
    jourCotisation: r.jour_cotisation,
    frequenceTirage: r.frequence_tirage,
    nombreMembresMax: r.nombre_membres,
    description: r.description || '',
    membres,
    cotisations,
    tirages,    
    gagnants
  };
}



        // Initialisation de l'application
        function initialiserApplication() {
            mettreAJourStatutReseau();
            mettreAJourAffichage();
            mettreAJourAlertes();
            
            // Initialiser la date de cotisation si l'√©l√©ment existe
            const dateCotisation = document.getElementById('dateCotisation');
            if (dateCotisation) {
                dateCotisation.value = new Date().toISOString().split('T')[0];
            }
            
            // Afficher la derni√®re synchronisation si disponible
            if (derniereSynchronisation) {
                const dateDerniere = new Date(derniereSynchronisation);
                console.log(`Derni√®re synchronisation: ${dateDerniere.toLocaleString('fr-FR')}`);
            }
        }

        // Configuration des √©v√©nements r√©seau
        function configurerEvenementsReseau() {
            window.addEventListener('online', function() {
                estEnLigne = true;
                mettreAJourStatutReseau();
                synchroniserDonnees();
            });

            window.addEventListener('offline', function() {
                estEnLigne = false;
                mettreAJourStatutReseau();
            });
        }

        // Mise √† jour du statut r√©seau
        function mettreAJourStatutReseau() {
            const banniere = document.getElementById('banniereReseau');
            
            if (!estEnLigne) {
                banniere.classList.remove('hidden');
                banniere.innerHTML = 'üì° Mode hors ligne - Donn√©es locales utilis√©es';
                banniere.className = 'fixed top-0 left-0 right-0 bg-orange-500 text-white text-center py-2 text-sm font-medium z-50';
            } else {
                if (donneesModifiees) {
                    banniere.classList.remove('hidden');
                    banniere.innerHTML = 'üîÑ Synchronisation en cours...';
                    banniere.className = 'fixed top-0 left-0 right-0 bg-blue-500 text-white text-center py-2 text-sm font-medium z-50';
                } else {
                    banniere.classList.add('hidden');
                }
            }
        }

        // Synchronisation des donn√©es
        function synchroniserDonnees() {
            if (!estEnLigne || !donneesModifiees || !utilisateurConnecte) return;
            
            try {
                // Simulation de synchronisation avec un serveur
                // Dans une vraie application, ici on enverrait les donn√©es au serveur
                
                setTimeout(() => {
                    // Marquer comme synchronis√©
                    donneesModifiees = false;
                    derniereSynchronisation = new Date().toISOString();
                    
                    // Sauvegarder la date de synchronisation pour l'utilisateur
                    const cleUtilisateur = `user_${utilisateurConnecte.id}`;
                    localStorage.setItem(`${cleUtilisateur}_derniere_sync`, derniereSynchronisation);
                    
                    // Mettre √† jour l'interface
                    mettreAJourStatutReseau();
                    
                    // Afficher une notification de succ√®s
                    afficherNotificationSync('‚úÖ Donn√©es synchronis√©es avec succ√®s');
                    
                    console.log('Synchronisation termin√©e:', new Date().toLocaleString('fr-FR'));
                }, 2000); // Simulation d'un d√©lai de synchronisation
                
            } catch (error) {
                console.error('Erreur de synchronisation:', error);
                afficherNotificationSync('‚ùå Erreur de synchronisation');
            }
        }

        // Affichage des notifications de synchronisation
        function afficherNotificationSync(message) {
            const banniere = document.getElementById('banniereReseau');
            banniere.classList.remove('hidden');
            banniere.innerHTML = message;
            banniere.className = 'fixed top-0 left-0 right-0 bg-green-500 text-white text-center py-2 text-sm font-medium z-50';
            
            setTimeout(() => {
                banniere.classList.add('hidden');
            }, 3000);
        }

        // Navigation entre pages
        function ouvrirPage(page) {
            // Masquer toutes les pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            // Afficher la page demand√©e
            const pageElement = document.getElementById('page-' + page);
            pageElement.classList.add('active');
            
            // Afficher/masquer le bouton retour
            const btnRetour = document.getElementById('btnRetour');
            if (page === 'accueil') {
                btnRetour.classList.add('hidden');
            } else {
                btnRetour.classList.remove('hidden');
            }
            
            pageActuelle = page;
            
            // Charger le contenu sp√©cifique √† la page
            switch(page) {
                case 'accueil':
                    afficherTontines();
                    break;
                case 'gestion':
                    chargerSelectsTontines();
                    break;
                case 'membres':
                    chargerSelectsTontines();
                    break;
                case 'tirages':
                    chargerSelectsTontines();
                    break;
                case 'statistiques':
                    afficherStatistiques();
                    break;
                case 'alertes':
                    afficherAlertes();
                    break;
            }
        }


        function retourAccueil() {
            ouvrirPage('accueil');
        }

        // Cr√©ation de tontine
let etape = 1;

function changerEtape(dir) {
  // Validation avant d'avancer
  if (dir === 1 && !validerEtape(etape)) return;

  // Masquer l‚Äô√©tape actuelle
  document.getElementById("etape-" + etape).classList.add("hidden");

  // Changer d‚Äô√©tape
  etape += dir;

  // Afficher la nouvelle √©tape
  document.getElementById("etape-" + etape).classList.remove("hidden");

  // Mettre √† jour compteur
  document.getElementById("etapeNum").innerText = etape;

  // G√©rer boutons
  document.getElementById("btnPrev").classList.toggle("hidden", etape === 1);
  document.getElementById("btnNext").classList.toggle("hidden", etape === 4);
  document.getElementById("btnCreate").classList.toggle("hidden", etape !== 4);
}

// Validation par √©tape
function validerEtape(num) {
  switch (num) {
    case 1:
      if (!document.getElementById('nomTontine').value.trim()) {
        afficherErreur("Veuillez entrer un nom de tontine");
        return false;
      }
      return true;

    case 2:
      const montant = parseFloat(document.getElementById('montantCotisation').value);
      if (!montant || montant <= 0) {
        afficherErreur("Veuillez entrer un montant valide");
        return false;
      }
      return true;

    case 3:
      if (!document.getElementById('jourCotisation').value) {
        afficherErreur("Veuillez choisir un jour de cotisation");
        return false;
      }
      return true;

    case 4:
      const nbMembres = parseInt(document.getElementById('nombreMembres').value);
      if (!nbMembres || nbMembres < 2) {
        afficherErreur("Veuillez entrer au moins 2 membres");
        return false;
      }
      return true;
  }
  return true;
}

// Affichage d‚Äôune petite notification erreur (au lieu d‚Äôalert)
function afficherErreur(msg) {
  const div = document.createElement("div");
  div.className = "bg-red-500 text-white text-center py-2 rounded-lg mb-4";
  div.textContent = "‚ö†Ô∏è " + msg;
  const parent = document.querySelector("#page-creer .card-premium");
  parent.insertBefore(div, parent.firstChild);

  setTimeout(() => div.remove(), 3000);
}

// Cr√©ation finale (uniquement √† l‚Äô√©tape 4)
async function creerTontine() {
  const nom = document.getElementById('nomTontine').value.trim();
  const type = document.getElementById('typeTontine').value;
  const montant = parseFloat(document.getElementById('montantCotisation').value);
  const frequenceCot = document.getElementById('frequenceCotisation').value;
  const jourCot = document.getElementById('jourCotisation').value;
  const frequenceTir = document.getElementById('frequenceTirage').value;
  const nbMembres = parseInt(document.getElementById('nombreMembres').value, 10);
  const description = document.getElementById('descriptionTontine').value.trim();

  if (!nom || !montant || !nbMembres || nbMembres < 2) {
    return afficherErreur("Veuillez remplir les champs requis.");
  }

  const { data, error } = await sb.from('tontines')
    .insert({
      nom,
      type,
      montant_cotisation: montant,
      frequence_cotisation: frequenceCot,
      jour_cotisation: jourCot,
      frequence_tirage: frequenceTir,
      nombre_membres: nbMembres,
      description,
      createur: utilisateurConnecte.id
    })
    .select()
    .single();

  if (error) return alert('Cr√©ation impossible: ' + error.message);

  // Met √† jour le state local pour r√©utiliser ton UI sans refactor
  tontines.push(mapTontineRowToLocal({ ...data, membres: [], cotisations: [] }));
  ouvrirPage('accueil');
  alert('‚úÖ Tontine cr√©√©e avec succ√®s !');
}

        // Affichage des tontines
       function afficherTontines() {
    const liste = document.getElementById('listeTontines');
    liste.innerHTML = '';

    // üëâ V√©rifier si le guide est masqu√© dans localStorage
    const guideMasque = localStorage.getItem('guideMasque') === 'true';

    if (!guideMasque) {
        const guide = document.createElement('div');
        guide.className = 'col-span-full bg-gradient-to-r from-green-400 to-green-500 text-white rounded-xl shadow-md p-4 mb-6 text-center relative';
        guide.innerHTML = `
            <button onclick="masquerGuide()" class="absolute top-2 right-2 text-white font-bold text-lg">‚ùå</button>
            <h3 class="text-lg font-semibold mb-2">üìò Guide rapide</h3>
            <ol class="text-left list-decimal list-inside space-y-1">
              <li>‚ûï Cr√©ez une tontine</li>
              <li>üë• Ajoutez les membres</li>
              <li>üí∞ Enregistrez les cotisations</li>
              <li>üé≤ Faites le tirage quand c‚Äôest pr√™t</li>
            </ol>
        `;
        liste.appendChild(guide);
    }

    if (tontines.length === 0) {
        liste.innerHTML += `
            <div class="col-span-full text-center py-16">
                <div class="text-8xl mb-6 floating-animation">üéØ</div>
                <h3 class="text-2xl font-bold text-white mb-4">Aucune tontine cr√©√©e</h3>
                <p class="text-white/80 mb-6 text-lg">Commencez par cr√©er votre premi√®re tontine</p>
                <button onclick="ouvrirPage('creer')" class="btn-gradient btn-success px-8 py-4 rounded-2xl text-lg">
                    ‚ûï Cr√©er une Tontine
                </button>
            </div>
        `;
        return;
    }

    tontines.forEach((tontine, index) => {
        const typeIcon = {
            'argent': 'üí∞',
            'electronique': 'üì±',
            'cosmetique': 'üíÑ',
            'autre': 'üéÅ'
        };

        const frequenceText = {
            'quotidien': 'Quotidien',
            'hebdomadaire': 'Hebdomadaire',
            'mensuel': 'Mensuel',
            'annuel': 'Annuel'
        };

        const progression = (tontine.membres.length / tontine.nombreMembresMax) * 100;
        const cotisationsCompletes = verifierCotisationsCompletes(tontine);
        const tiragePossible = verifierDateTiragePossible(tontine);
        const prochaineTirage = obtenirProchaineDateTirage(tontine);
        const eligibles = tontine.membres.filter(m => !m.aGagne);

        const div = document.createElement('div');
        div.className = 'tontine-card p-8 fade-in-up';
        div.style.animationDelay = `${index * 0.1}s`;
        div.innerHTML = `
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex items-center space-x-4">
                            <div class="text-5xl floating-animation">${typeIcon[tontine.type]}</div>
                            <div>
                                <h3 class="font-bold text-xl text-gray-800">${tontine.nom}</h3>
                                <p class="text-gray-600 font-medium">${frequenceText[tontine.frequenceCotisation]} - ${tontine.montant.toLocaleString()} FCFA</p>
                            </div>
                        </div>
                        <span class="px-4 py-2 bg-gradient-to-r from-green-400 to-green-500 text-white rounded-full text-sm font-semibold">
                            ${tontine.statut}
                        </span>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-600 mb-2 font-medium">
                            <span>Membres: ${tontine.membres.length}/${tontine.nombreMembresMax}</span>
                            <span>${Math.round(progression)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="progress-bar h-3 rounded-full" style="width: ${progression}%"></div>
                        </div>
                    </div>
                    
                    ${eligibles.length === 0 ? `
                        <div class="bg-gradient-to-r from-gray-400 to-gray-500 text-center px-4 py-3 mb-6 text-white font-semibold rounded-xl">
                            üèÅ Tontine termin√©e
                        </div>
                    ` : tontine.membres.length === 0 ? `
                        <div class="bg-gradient-to-r from-blue-400 to-blue-500 text-center px-4 py-3 mb-6 text-white font-semibold rounded-xl">
                            üë• En attente de membres
                        </div>
                    ` : tontine.cotisations.length === 0 ? `
                        <div class="bg-gradient-to-r from-purple-400 to-purple-500 text-center px-4 py-3 mb-6 text-white font-semibold rounded-xl">
                            üí∞ En attente de cotisations
                        </div>
                    ` : (cotisationsCompletes && tiragePossible) ? `
                        <div class="alert-notification text-center px-4 py-3 mb-6 text-white font-semibold">
                            ${tontine.tirages.length === 0 ? 'üéØ Premier tirage disponible !' : 'üé≤ Tirage disponible !'}
                        </div>
                    ` : cotisationsCompletes && !tiragePossible ? `
                        <div class="bg-gradient-to-r from-orange-400 to-orange-500 text-center px-4 py-3 mb-6 text-white font-semibold rounded-xl">
                            ‚è≥ Prochain tirage dans ${obtenirJoursRestantsAvantTirage(tontine)} jour(s)
                        </div>
                    ` : !cotisationsCompletes ? `
                        <div class="bg-gradient-to-r from-red-400 to-red-500 text-center px-4 py-3 mb-6 text-white font-semibold rounded-xl">
                            ‚ùå Cotisations incompl√®tes (${tontine.membres.filter(m => {
                                const periodeActuelle = obtenirPeriodeCotisation(new Date().toISOString().split('T')[0], tontine.frequenceCotisation);
                                return !m.cotisationsPayees.some(c => obtenirPeriodeCotisation(c.date, tontine.frequenceCotisation) === periodeActuelle);
                            }).length} membre(s) en retard)
                        </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button onclick="gererTontine(${tontine.id})" class="btn-gradient text-sm py-3 px-4 rounded-xl font-medium">
                            ‚öôÔ∏è G√©rer
                        </button>
                        <button onclick="voirMembres(${tontine.id})" class="btn-gradient text-sm py-3 px-4 rounded-xl font-medium" style="background: var(--secondary-gradient)">
                            üë• Membres
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="editerTontineAccueil(${tontine.id})" class="btn-gradient text-sm py-3 px-4 rounded-xl font-medium" style="background: var(--warning-gradient)">
                            ‚úèÔ∏è √âditer
                        </button>
                        <button onclick="supprimerTontine(${tontine.id})" class="btn-gradient btn-danger text-sm py-3 px-4 rounded-xl font-medium">
                            üóëÔ∏è Supprimer
                        </button>
                    </div>
                `;
        liste.appendChild(div);
    });
}

function masquerGuide() {
    localStorage.setItem('guideMasque', 'true'); // Sauvegarde le choix
    afficherTontines(); // Recharge la page d‚Äôaccueil sans le guide
}

        // Gestion des tontines
        function gererTontine(id) {
            ouvrirPage('gestion');
            document.getElementById('selectTontineGestion').value = id;
            chargerTontineGestion();
        }

        function voirMembres(id) {
            ouvrirPage('membres');
            document.getElementById('selectTontineMembres').value = id;
            afficherMembresTontine();
        }

        function chargerSelectsTontines() {
            const selects = ['selectTontineGestion', 'selectTontineMembres', 'selectTontineTirage'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Choisir une tontine...</option>';
                    tontines.forEach(tontine => {
                        const option = document.createElement('option');
                        option.value = tontine.id;
                        option.textContent = tontine.nom;
                        select.appendChild(option);
                    });
                }
            });
        }

        async function chargerTontineGestion() {
    const id = document.getElementById('selectTontineGestion').value;
    if (!id) {
        document.getElementById('panneauGestion').classList.add('hidden');
        return;
    }

    try {
        // üîπ Charger la tontine compl√®te depuis le backend
        const res = await fetch(`${API_BASE}/tontines/${id}`, {
            headers: {
                "Authorization": `Bearer ${localStorage.getItem("token")}`,
                "Content-Type": "application/json"
            }
        });

        if (!res.ok) {
            throw new Error("Erreur chargement tontine");
        }

        tontineActive = await res.json();

        // ‚úÖ Afficher le panneau
        document.getElementById('panneauGestion').classList.remove('hidden');

        // ‚úÖ Afficher les infos avec les nouvelles donn√©es
        afficherInfosTontine();
        afficherMembresTontineGestion();
        mettreAJourSelectMembres();
        afficherHistoriqueCotisations();

    } catch (err) {
        console.error("Erreur chargement gestion tontine:", err);
        alert("Impossible de charger la tontine s√©lectionn√©e ‚ùå");
    }
}

        function afficherInfosTontine() {
    const tontine = tontineActive;
    const typeIcon = {
        'argent': 'üí∞',
        'electronique': 'üì±',
        'cosmetique': 'üíÑ',
        'autre': 'üéÅ',
        'classique': 'üéØ'
    };

    const cycleActuel = tontine.cotisations.length > 0 ? Math.ceil(tontine.cotisations.length / tontine.nombre_membres) : 1;
    const totalCycles = tontine.nombre_membres || 0;
    const progressionCycle = totalCycles > 0 ? ((cycleActuel - 1) / totalCycles) * 100 : 0;

    document.getElementById('infosTontine').innerHTML = `
        <div class="grid md:grid-cols-5 gap-6">
            <div class="text-center">
                <div class="text-5xl mb-3 floating-animation">${typeIcon[tontine.type] || 'üéÅ'}</div>
                <div class="font-bold text-xl text-gray-800">${tontine.nom}</div>
                <div class="text-sm text-gray-600 font-medium">${tontine.type}</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold bg-gradient-to-r from-green-500 to-green-600 bg-clip-text text-transparent">${tontine.montant_cotisation.toLocaleString()}</div>
                <div class="text-sm text-gray-600 font-medium">FCFA par cotisation</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold bg-gradient-to-r from-blue-500 to-blue-600 bg-clip-text text-transparent">${tontine.membres.length}/${tontine.nombre_membres}</div>
                <div class="text-sm text-gray-600 font-medium">Membres</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold bg-gradient-to-r from-orange-500 to-orange-600 bg-clip-text text-transparent">${cycleActuel}/${totalCycles || '?'}</div>
                <div class="text-sm text-gray-600 font-medium">Cycle actuel</div>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                    <div class="bg-gradient-to-r from-orange-500 to-orange-600 h-2 rounded-full" style="width: ${progressionCycle}%"></div>
                </div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold bg-gradient-to-r from-purple-500 to-purple-600 bg-clip-text text-transparent">${tontine.cotisations.length}</div>
                <div class="text-sm text-gray-600 font-medium">Cotisations enregistr√©es</div>
            </div>
        </div>
    `;
}

        // Affichage des membres par tontine
        function afficherMembresTontine() {
            const id = parseInt(document.getElementById('selectTontineMembres').value);
            if (!id) {
                document.getElementById('panneauMembres').classList.add('hidden');
                return;
            }

            const tontine = tontines.find(t => t.id === id);
            document.getElementById('panneauMembres').classList.remove('hidden');
            
            const cartes = document.getElementById('cartesMembres');
            cartes.innerHTML = '';

            if (tontine.membres.length === 0) {
                cartes.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-6 floating-animation">üë•</div>
                        <h3 class="text-xl font-bold text-gray-700">Aucun membre</h3>
                        <p class="text-gray-600">Cette tontine n'a pas encore de membres</p>
                    </div>
                `;
                return;
            }

            tontine.membres.forEach((membre, index) => {
                const cotisationsCount = membre.cotisationsPayees.length;
                const totalCotise = cotisationsCount * tontine.montant;
                const statut = membre.aGagne ? 'Gagnant' : 'Actif';
                const couleurStatut = membre.aGagne ? 'bg-gradient-to-r from-yellow-400 to-yellow-500 text-white' : 'bg-gradient-to-r from-green-400 to-green-500 text-white';
                
                // Calculer le statut de paiement pour la p√©riode actuelle
                const tousOntGagne = tontine.membres.every(m => m.aGagne);
                let statutPaiement;
                
                if (tousOntGagne) {
                    statutPaiement = '<span class="text-blue-600 font-semibold">üèÅ Tontine termin√©e</span>';
                } else {
                    const periodeActuelle = obtenirPeriodeCotisation(new Date().toISOString().split('T')[0], tontine.frequenceCotisation);
                    const aCotisePeriodeActuelle = membre.cotisationsPayees.some(c => {
                        const periodeCotisation = obtenirPeriodeCotisation(c.date, tontine.frequenceCotisation);
                        return periodeCotisation === periodeActuelle;
                    });
                    
                    statutPaiement = aCotisePeriodeActuelle ? 
                        '<span class="text-green-600 font-semibold">‚úÖ √Ä jour</span>' : 
                        '<span class="text-red-600 font-semibold">‚ö†Ô∏è En retard</span>';
                }
                
                const div = document.createElement('div');
                div.className = 'member-card p-8 fade-in-up';
                div.style.animationDelay = `${index * 0.1}s`;
                div.innerHTML = `
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-4 floating-animation">
                            <span class="text-white text-3xl">${membre.aGagne ? 'üèÜ' : 'üë§'}</span>
                        </div>
                        <h3 class="font-bold text-xl text-gray-800 mb-2">${membre.nom}</h3>
                        <span class="px-4 py-2 ${couleurStatut} rounded-full text-sm font-semibold">${statut}</span>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-gray-600 font-medium">Cotisations:</span>
                            <span class="font-bold text-lg">${cotisationsCount}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-gray-600 font-medium">Total cotis√©:</span>
                            <span class="font-bold text-lg text-green-600">${totalCotise.toLocaleString()} FCFA</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-gray-600 font-medium">Statut paiement:</span>
                            ${statutPaiement}
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-gray-600 font-medium">Membre depuis:</span>
                            <span class="font-bold">${new Date(membre.dateAjout).toLocaleDateString('fr-FR')}</span>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t">
                        <div class="text-sm text-gray-600 font-medium mb-3">Historique des paiements:</div>
                        <div class="space-y-2 max-h-40 overflow-y-auto">
                            ${membre.cotisationsPayees.slice(-5).reverse().map(c => 
                                `<div class="flex justify-between items-center text-xs bg-gradient-to-r from-blue-50 to-purple-50 p-3 rounded-lg">
                                    <div>
                                        <div class="font-medium">${new Date(c.date).toLocaleDateString('fr-FR')}</div>
                                        <div class="text-gray-500">${c.montant.toLocaleString()} FCFA</div>
                                        ${c.montant > tontine.montant ? `<div class="text-green-600 font-semibold text-xs">üìä ${Math.round(c.montant / tontine.montant)} cotisations</div>` : ''}
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="editerCotisation('${c.id}', ${tontine.id})" class="text-blue-500 hover:text-blue-700 text-sm" title="√âditer">‚úèÔ∏è</button>
                                        <button onclick="supprimerCotisation('${c.id}', ${tontine.id})" class="text-red-500 hover:text-red-700 text-sm" title="Supprimer">‚ùå</button>
                                    </div>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6 pt-4 border-t">
                        <button onclick="ouvrirModaleEditionMembre(${membre.id})" class="flex-1 btn-gradient px-4 py-3 rounded-xl font-medium" style="background: var(--warning-gradient)">
                            ‚úèÔ∏è √âditer
                        </button>
                        <button onclick="retirerMembreTontine(${membre.id}, ${tontine.id})" class="flex-1 btn-gradient btn-danger py-3 rounded-xl font-medium">
                            üóëÔ∏è Retirer
                        </button>
                    </div>
                `;
                cartes.appendChild(div);
            });
        }

        // Gestion des membres
        async function ajouterMembreTontine() {
  if (!tontineActive) return;
  const nom = document.getElementById('nomMembre').value.trim();
  if (!nom) return alert('Veuillez entrer un nom de membre');

  const { data, error } = await sb.from('membres')
    .insert({ tontine_id: tontineActive.id, nom })
    .select()
    .single();

  if (error) return alert('Ajout impossible: ' + error.message);

  tontineActive.membres.push({
    id: data.id, nom: data.nom, aGagne: false,
    dateAjout: data.cree_le, cotisationsPayees: []
  });
  document.getElementById('nomMembre').value = '';
  mettreAJourSelectMembres?.();
  afficherMembresTontineGestion?.();
  alert('‚úÖ Membre ajout√©.');
}

        function afficherMembresTontineGestion() {
    const liste = document.getElementById('listeMembresTontineGestion');
    liste.innerHTML = '';

    if (!tontineActive.membres || tontineActive.membres.length === 0) {
        liste.innerHTML = `
            <div class="col-span-full text-center py-12">
                <div class="text-6xl mb-6 floating-animation">üë•</div>
                <h3 class="text-xl font-bold text-gray-700">Aucun membre</h3>
                <p class="text-gray-600">Cette tontine n'a pas encore de membres</p>
            </div>
        `;
        return;
    }

    tontineActive.membres.forEach((membre, index) => {
        const cotisationsCount = tontineActive.cotisations.filter(c => c.membreid === membre.id).length;
        const totalCotise = cotisationsCount * tontineActive.montant_cotisation;

        const div = document.createElement('div');
        div.className = 'member-card p-4 bg-gradient-to-r from-blue-50 to-purple-50 fade-in-up';
        div.style.animationDelay = `${index * 0.1}s`;
        div.innerHTML = `
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                        <span class="text-white text-lg">üë§</span>
                    </div>
                    <div>
                        <div class="font-bold text-gray-800">${membre.nom}</div>
                        <div class="text-xs text-gray-500">Depuis ${new Date(membre.date_ajout).toLocaleDateString('fr-FR')}</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="font-bold text-lg text-green-600">${totalCotise.toLocaleString()} FCFA</div>
                    <div class="text-sm text-gray-600">${cotisationsCount} cotisations</div>
                </div>
            </div>
        `;
        liste.appendChild(div);
    });
}

        function supprimerMembreTontine(membreId) {
            if (confirm('Supprimer ce membre ?')) {
                tontineActive.membres = tontineActive.membres.filter(m => m.id !== membreId);
                sauvegarder();
                afficherMembresTontineGestion();
                mettreAJourSelectMembres();
                mettreAJourAffichage();
            }
        }

        function editerTontineAccueil(id) {
            const tontine = tontines.find(t => t.id === id);
            if (!tontine) return;
            
            tontineActive = tontine;
            ouvrirModaleEditionTontine();
        }

        function mettreAJourSelectMembres() {
            const select = document.getElementById('membreCotisationSelect');
            select.innerHTML = '<option value="">Choisir un membre</option>';
            
            tontineActive.membres.forEach(membre => {
                const option = document.createElement('option');
                option.value = membre.id;
                option.textContent = membre.nom;
                select.appendChild(option);
            });
        }

        // Gestion des cotisations
        async function enregistrerCotisationTontine() {
  if (!tontineActive) return;
  const membreId = document.getElementById('selectMembreCotisation').value;
  const montant = tontineActive.montant;
  const date = document.getElementById('dateCotisation').value || new Date().toISOString().split('T')[0];

  const { data, error } = await sb.from('cotisations')
    .insert({ tontine_id: tontineActive.id, membre_id: membreId, montant, date_cotisation: date })
    .select()
    .single();

  if (error) return alert('Enregistrement impossible: ' + error.message);

  // MAJ state local pour l‚ÄôUI
  const c = { id: data.id, membreId, montant: Number(data.montant), date: new Date(data.date_cotisation).toISOString() };
  tontineActive.cotisations.push(c);
  const m = tontineActive.membres.find(mm => mm.id === membreId);
  if (m) m.cotisationsPayees.push({ id: c.id, date: c.date, montant: c.montant });

  afficherHistoriqueCotisations?.();
  afficherMembresTontineGestion?.();
  mettreAJourAlertes?.();
  alert('‚úÖ Cotisation enregistr√©e.');
}

        function afficherHistoriqueCotisations() {
    const liste = document.getElementById('historiqueCotisations');
    liste.innerHTML = '';

    if (!tontineActive.cotisations || tontineActive.cotisations.length === 0) {
        liste.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <div class="text-4xl mb-3">üí∞</div>
                <p>Aucune cotisation enregistr√©e</p>
            </div>
        `;
        return;
    }

    const cotisationsRecentes = tontineActive.cotisations.slice(-10).reverse();

    cotisationsRecentes.forEach((cotisation, index) => {
        const membre = tontineActive.membres.find(m => m.id === cotisation.membreid);
        const div = document.createElement('div');
        div.className = 'member-card p-4 bg-gradient-to-r from-green-50 to-green-100 fade-in-up';
        div.style.animationDelay = `${index * 0.1}s`;
        div.innerHTML = `
            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <div class="flex items-center gap-3">
                        <span class="font-semibold text-gray-800">${membre ? membre.nom : 'Membre supprim√©'}</span>
                        <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-medium">${new Date(cotisation.date).toLocaleDateString('fr-FR')}</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="font-bold text-green-600 text-lg">+${cotisation.montant.toLocaleString()} FCFA</span>
                </div>
            </div>
        `;
        liste.appendChild(div);
    });
}
        // Fonctions de gestion des cotisations et membres
        async function retirerMembreTontine(membreId, tontineId) {
  const tontine = tontines.find(t => t.id === tontineId);
  if (!tontine) return;

  const membre = tontine.membres.find(m => m.id === membreId);
  if (!membre) return;

  const cotisationsCount = membre.cotisationsPayees.length;
  const totalCotise = cotisationsCount * tontine.montant;
  const cotisationsTontine = tontine.cotisations.filter(c => c.membreId === membreId).length;

  const message = `‚ö†Ô∏è RETRAIT DE MEMBRE ‚ö†Ô∏è\n\n` +
                  `Membre: "${membre.nom}"\n` +
                  `Tontine: "${tontine.nom}"\n` +
                  `Statut: ${membre.aGagne ? 'üèÜ Gagnant' : 'üë§ Actif'}\n` +
                  `Membre depuis: ${new Date(membre.dateAjout).toLocaleDateString('fr-FR')}\n\n` +
                  `üí∞ IMPACT FINANCIER:\n` +
                  `‚Ä¢ Cotisations pay√©es: ${cotisationsCount}\n` +
                  `‚Ä¢ Montant total cotis√©: ${totalCotise.toLocaleString()} FCFA\n` +
                  `‚Ä¢ Cotisations dans l'historique: ${cotisationsTontine}\n\n` +
                  `‚ö†Ô∏è CONS√âQUENCES:\n` +
                  `‚Ä¢ Toutes ses cotisations seront supprim√©es\n` +
                  `‚Ä¢ Son historique sera effac√© d√©finitivement\n` +
                  `${membre.aGagne ? '‚Ä¢ Son statut de gagnant sera perdu\n' : ''}\n` +
                  `Confirmer le retrait ?`;

  if (!confirm(message)) return;

  // üîπ Supprimer c√¥t√© BDD (membre + cotisations associ√©es via ON DELETE CASCADE)
  const { error } = await sb.from('membres').delete().eq('id', membreId);
  if (error) return alert('Suppression impossible: ' + error.message);

  // üîπ MAJ c√¥t√© front (pour ne pas casser ton UI)
  tontine.membres = tontine.membres.filter(m => m.id !== membreId);
  tontine.cotisations = tontine.cotisations.filter(c => c.membreId !== membreId);
  if (membre.aGagne) {
    tontine.gagnants = tontine.gagnants.filter(g => g.gagnantId !== membreId);
    tontine.tirages = tontine.tirages.filter(t => t.gagnantId !== membreId);
  }

  // üîπ Rafra√Æchir l‚Äôaffichage
  if (pageActuelle === 'gestion') {
    afficherMembresTontineGestion();
    mettreAJourSelectMembres();
  } else if (pageActuelle === 'membres') {
    afficherMembresTontine();
  }
  mettreAJourAlertes();

  alert(`‚úÖ Membre "${membre.nom}" retir√© avec succ√®s !\n\n` +
        `üìä R√©sum√© du retrait:\n` +
        `‚Ä¢ ${cotisationsCount} cotisations supprim√©es\n` +
        `‚Ä¢ ${totalCotise.toLocaleString()} FCFA retir√©s de l'historique\n` +
        `${membre.aGagne ? '‚Ä¢ Statut de gagnant annul√©\n' : ''}` +
        `‚Ä¢ Membre retir√© de "${tontine.nom}"`);
}
        
        async function supprimerCotisation(cotisationId, tontineId) {
  if (!confirm('Supprimer cette cotisation ?')) return;
  const { error } = await sb.from('cotisations').delete().eq('id', cotisationId);
  if (error) return alert('Suppression impossible: ' + error.message);

  const t = tontines.find(t => t.id === tontineId);
  if (t) {
    const c = t.cotisations.find(x => x.id == cotisationId);
    t.cotisations = t.cotisations.filter(x => x.id != cotisationId);
    const m = t.membres.find(mm => mm.id === c?.membreId);
    if (m) m.cotisationsPayees = m.cotisationsPayees.filter(x => x.id != cotisationId);
  }
  afficherHistoriqueCotisations?.();
  afficherMembresTontine?.();
  mettreAJourAlertes?.();
  alert('‚úÖ Cotisation supprim√©e !');
}

        // Syst√®me de tirage
        function chargerTontineTirage() {
            const id = parseInt(document.getElementById('selectTontineTirage').value);
            if (!id) {
                document.getElementById('panneauTirage').classList.add('hidden');
                return;
            }

            tontineActive = tontines.find(t => t.id === id);
            document.getElementById('panneauTirage').classList.remove('hidden');
            
            afficherMembresEligibles();
            afficherHistoriqueGagnants();
            afficherInfosTirage();
        }

        function afficherMembresEligibles() {
            const liste = document.getElementById('membresEligibles');
            liste.innerHTML = '';
            
            const eligibles = tontineActive.membres.filter(m => !m.aGagne);
            
            if (eligibles.length === 0) {
                liste.innerHTML = '<p class="text-gray-600 text-center py-4">Aucun membre √©ligible</p>';
                return;
            }

            eligibles.forEach((membre, index) => {
                const div = document.createElement('div');
                div.className = 'member-card p-4 bg-gradient-to-r from-blue-50 to-purple-50 fade-in-up';
                div.style.animationDelay = `${index * 0.1}s`;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-gray-800">${membre.nom}</span>
                        <span class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-medium">${membre.cotisationsPayees.length} cotisations</span>
                    </div>
                `;
                liste.appendChild(div);
            });
        }

        function afficherHistoriqueGagnants() {
            const liste = document.getElementById('historiqueGagnants');
            liste.innerHTML = '';
            
            tontineActive.gagnants.forEach((gagnant, index) => {
                const div = document.createElement('div');
                div.className = 'member-card p-4 bg-gradient-to-r from-yellow-50 to-yellow-100 fade-in-up';
                div.style.animationDelay = `${index * 0.1}s`;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-gray-800">üèÜ ${gagnant.nom}</span>
                        <span class="text-sm bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full font-medium">${new Date(gagnant.date).toLocaleDateString('fr-FR')}</span>
                    </div>
                `;
                liste.appendChild(div);
            });
        }

        function afficherInfosTirage() {
            const infoDiv = document.getElementById('infoTirage');
            const btnTirage = document.getElementById('btnTirage');
            
            const eligibles = tontineActive.membres.filter(m => !m.aGagne);
            
            // üî¥ GRIS - Tontine termin√©e
            if (eligibles.length === 0) {
                infoDiv.innerHTML = `
                    <div class="bg-gradient-to-r from-gray-400 to-gray-500 p-6 rounded-xl text-white">
                        <div class="text-xl font-bold mb-2">üèÅ Tontine Termin√©e</div>
                        <div class="text-sm opacity-90">Tous les membres ont d√©j√† gagn√©</div>
                        <div class="text-sm opacity-75 mt-2">Aucun tirage possible</div>
                    </div>
                `;
                btnTirage.style.display = 'none';
                return;
            }
            
            const cotisationsCompletes = verifierCotisationsCompletes(tontineActive);
            const tiragePossible = verifierDateTiragePossible(tontineActive);
           const membresEnRetard = tontineActive.membres.filter(m => 
    !m.aGagne && estEnRetardPeriode(m, tontineActive)
);

            // üî¥ ROUGE - Cotisations incompl√®tes
            if (!cotisationsCompletes) {
                infoDiv.innerHTML = `
                    <div class="bg-gradient-to-r from-red-500 to-red-600 p-6 rounded-xl text-white">
                        <div class="text-xl font-bold mb-2">‚ùå Tirage Impossible</div>
                        <div class="text-sm opacity-90 mb-3">Cotisations incompl√®tes</div>
                        <div class="bg-red-600 bg-opacity-50 p-3 rounded-lg text-sm">
                            <div class="font-semibold mb-1">üìã Membres en retard:</div>
                            ${membresEnRetard.map(m => `‚Ä¢ ${m.nom}`).join('<br>')}
                        </div>
                        <div class="text-xs opacity-75 mt-3">Tous les membres √©ligibles doivent cotiser</div>
                    </div>
                `;
                btnTirage.disabled = true;
                btnTirage.style.opacity = '0.3';
                btnTirage.style.background = 'linear-gradient(135deg, #9ca3af, #6b7280)';
                btnTirage.style.cursor = 'not-allowed';
                btnTirage.style.display = 'inline-block';
                return;
            }
            
            // üü† ORANGE - Intervalle non respect√©
            if (!tiragePossible) {
                const joursRestants = obtenirJoursRestantsAvantTirage(tontineActive);
                const prochaineTirage = obtenirProchaineDateTirage(tontineActive);
                const intervalles = {
                    'hebdomadaire': '7 jours',
                    'mensuel': '30 jours',
                    'trimestriel': '90 jours'
                };
                
                const couleurOrange = joursRestants <= 3 ? 'from-yellow-500 to-orange-500' : 'from-orange-500 to-orange-600';
                
                infoDiv.innerHTML = `
                    <div class="bg-gradient-to-r ${couleurOrange} p-6 rounded-xl text-white">
                        <div class="text-xl font-bold mb-2">‚è≥ Tirage en Attente</div>
                        <div class="text-sm opacity-90 mb-3">Intervalle de temps non respect√©</div>
                        <div class="bg-orange-600 bg-opacity-50 p-3 rounded-lg text-sm space-y-1">
                            <div><span class="font-semibold">Fr√©quence:</span> ${intervalles[tontineActive.frequenceTirage] || '30 jours'}</div>
                            <div><span class="font-semibold">Temps restant:</span> ${joursRestants} jour(s)</div>
                            <div><span class="font-semibold">Disponible le:</span> ${prochaineTirage.toLocaleDateString('fr-FR')}</div>
                        </div>
                        <div class="text-xs opacity-75 mt-3">
                            ${joursRestants <= 3 ? 'üî• Bient√¥t disponible !' : 'Patience requise pour respecter l\'intervalle'}
                        </div>
                    </div>
                `;
                btnTirage.disabled = true;
                btnTirage.style.opacity = '0.6';
                btnTirage.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                btnTirage.style.cursor = 'not-allowed';
                btnTirage.style.display = 'inline-block';
                btnTirage.innerHTML = `‚è≥ Disponible dans ${joursRestants}j`;
                return;
            }
            
            // üü¢ VERT - Tirage possible
            const estPremierTirage = tontineActive.tirages.length === 0;
            const montantTotal = tontineActive.montant * tontineActive.membres.length;
            
            infoDiv.innerHTML = `
                <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 rounded-xl text-white">
                    <div class="text-xl font-bold mb-2">
                        ${estPremierTirage ? 'üéØ Premier Tirage Disponible !' : '‚úÖ Nouveau Tirage Disponible !'}
                    </div>
                    <div class="text-sm opacity-90 mb-3">Toutes les conditions sont remplies</div>
                    <div class="bg-green-600 bg-opacity-50 p-3 rounded-lg text-sm space-y-1">
                        <div><span class="font-semibold">Membres √©ligibles:</span> ${eligibles.length}</div>
                        <div><span class="font-semibold">Montant √† gagner:</span> ${montantTotal.toLocaleString()} FCFA</div>
                        <div><span class="font-semibold">Cotisations:</span> ‚úÖ Toutes compl√®tes</div>
                        ${estPremierTirage ? 
                            '<div class="font-semibold text-yellow-200">üéâ Premier tirage de cette tontine !</div>' : 
                            '<div><span class="font-semibold">Intervalle:</span> ‚úÖ Respect√©</div>'
                        }
                    </div>
                </div>
            `;
            
            btnTirage.disabled = false;
            btnTirage.style.opacity = '1';
            btnTirage.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            btnTirage.style.cursor = 'pointer';
            btnTirage.style.display = 'inline-block';
            btnTirage.innerHTML = 'üé≤ Effectuer le Tirage';
        }

        async function effectuerTirage() {
  if (!tontineActive) return;

  const participants = tontineActive.membres.filter(m => !m.aGagne);
  if (participants.length === 0) {
    return alert("Tous les membres ont d√©j√† gagn√©.");
  }

  // Tirage al√©atoire
  const gagnant = participants[Math.floor(Math.random() * participants.length)];

  // üîπ Ins√©rer dans Supabase
  const { data, error } = await sb.from('tirages')
    .insert({ tontine_id: tontineActive.id, membre_id: gagnant.id })
    .select()
    .single();

  if (error) return alert('Erreur lors du tirage : ' + error.message);

  // üîπ MAJ locale pour l‚ÄôUI
  tontineActive.tirages.push({
    id: data.id,
    gagnantId: gagnant.id,
    date: new Date(data.date_tirage).toISOString()
  });

  tontineActive.gagnants.push({
    gagnantId: gagnant.id,
    date: new Date(data.date_tirage).toISOString()
  });

  // Marquer le membre comme gagnant
  gagnant.aGagne = true;

  // Rafra√Æchir l‚Äôaffichage
  afficherInfosTontine();
  mettreAJourAlertes();

  alert(`üéâ Tirage effectu√© !\n\nLe gagnant est : ${gagnant.nom}`);
}

        // Statistiques et graphiques
        function afficherStatistiques() {
            calculerMetriques();
            creerGraphiques();
            remplirTableauPerformance();
        }

        function calculerMetriques() {
            const alertesActuelles = mettreAJourAlertes();
            
            const totalTontines = tontines.filter(t => t.statut === 'active').length;
            const totalMembres = tontines.reduce((sum, t) => sum + t.membres.length, 0);
            const totalCotisations = tontines.reduce((sum, t) => 
                sum + t.cotisations.reduce((s, c) => s + c.montant, 0), 0);
            const totalTirages = tontines.reduce((sum, t) => sum + t.tirages.length, 0);
            
            // Calculer les nouvelles m√©triques d'alertes
            const retards = alertesActuelles.filter(a => a.type === 'retard').length;
            const cyclesRetard = tontines.filter(t => {
                const eligibles = t.membres.filter(m => !m.aGagne);
                return eligibles.length > 0 && !verifierDateTiragePossible(t) && verifierCotisationsCompletes(t);
            }).length;
            const paiementsAttente = tontines.reduce((sum, t) => {
                const tousOntGagne = t.membres.every(m => m.aGagne);
                if (tousOntGagne) return sum;
                
                const periodeActuelle = obtenirPeriodeCotisation(new Date().toISOString().split('T')[0], t.frequenceCotisation);
                return sum + t.membres.filter(m => {
                    return !m.cotisationsPayees.some(c => {
                        const periodeCotisation = obtenirPeriodeCotisation(c.date, t.frequenceCotisation);
                        return periodeCotisation === periodeActuelle;
                    });
                }).length;
            }, 0);
            const tiragesDisponibles = alertesActuelles.filter(a => a.type === 'tirage').length;

            document.getElementById('statTotalTontines').textContent = totalTontines;
            document.getElementById('statTotalMembres').textContent = totalMembres;
            document.getElementById('statTotalCotisations').textContent = totalCotisations.toLocaleString();
            document.getElementById('statTotalTirages').textContent = totalTirages;
            document.getElementById('statRetards').textContent = retards;
            document.getElementById('statCyclesRetard').textContent = cyclesRetard;
            document.getElementById('statPaiementsAttente').textContent = paiementsAttente;
            document.getElementById('statTiragesDisponibles').textContent = tiragesDisponibles;
        }

        function creerGraphiques() {
            // Graphique des types de tontines
            const typesData = {};
            tontines.forEach(t => {
                typesData[t.type] = (typesData[t.type] || 0) + 1;
            });

            const ctxTypes = document.getElementById('graphiqueTypes').getContext('2d');
            new Chart(ctxTypes, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(typesData).map(type => {
                        const icons = {'argent': 'üí∞', 'electronique': 'üì±', 'cosmetique': 'üíÑ', 'autre': 'üéÅ'};
                        return icons[type] + ' ' + type.charAt(0).toUpperCase() + type.slice(1);
                    }),
                    datasets: [{
                        data: Object.values(typesData),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    layout: {
                        padding: 10
                    }
                }
            });

            // Graphique des cotisations par mois
            const cotisationsParMois = {};
            tontines.forEach(tontine => {
                tontine.cotisations.forEach(cotisation => {
                    const mois = new Date(cotisation.date).toLocaleDateString('fr-FR', {year: 'numeric', month: 'short'});
                    cotisationsParMois[mois] = (cotisationsParMois[mois] || 0) + cotisation.montant;
                });
            });

            const ctxCotisations = document.getElementById('graphiqueCotisations').getContext('2d');
            new Chart(ctxCotisations, {
                type: 'line',
                data: {
                    labels: Object.keys(cotisationsParMois).slice(-6),
                    datasets: [{
                        label: 'Cotisations (FCFA)',
                        data: Object.values(cotisationsParMois).slice(-6),
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    weight: 'bold',
                                    size: 12
                                }
                            }
                        }
                    },
                    layout: {
                        padding: 10
                    }
                }
            });
        }

        function remplirTableauPerformance() {
            const tableau = document.getElementById('tableauPerformance');
            tableau.innerHTML = '';

            tontines.forEach((tontine, index) => {
                const typeIcons = {'argent': 'üí∞', 'electronique': 'üì±', 'cosmetique': 'üíÑ', 'autre': 'üéÅ'};
                const totalCotisations = tontine.cotisations.reduce((sum, c) => sum + c.montant, 0);
                
                // Progression des membres
                const progressionMembres = (tontine.membres.length / tontine.nombreMembresMax) * 100;
                
                // Progression des tirages
                const eligibles = tontine.membres.filter(m => !m.aGagne);
                const progressionTirages = tontine.membres.length > 0 ? 
                    ((tontine.membres.length - eligibles.length) / tontine.membres.length) * 100 : 0;
                
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all fade-in-up';
                tr.style.animationDelay = `${index * 0.1}s`;
                tr.innerHTML = `
                    <td class="p-3 font-semibold">${typeIcons[tontine.type]} ${tontine.nom}</td>
                    <td class="p-3 capitalize">${tontine.type}</td>
                    <td class="p-3">
                        <div class="flex items-center gap-2">
                            <div class="flex-1">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full" style="width: ${progressionMembres}%"></div>
                                </div>
                            </div>
                            <span class="text-xs font-semibold text-gray-600">${tontine.membres.length}/${tontine.nombreMembresMax}</span>
                        </div>
                    </td>
                    <td class="p-3 font-semibold text-green-600">${totalCotisations.toLocaleString()} FCFA</td>
                    <td class="p-3">
                        <div class="flex items-center gap-2">
                            <div class="flex-1">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 h-2 rounded-full" style="width: ${progressionTirages}%"></div>
                                </div>
                            </div>
                            <span class="text-xs font-semibold text-gray-600">${tontine.tirages.length}/${tontine.membres.length}</span>
                        </div>
                    </td>
                    <td class="p-3">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                            tontine.statut === 'active' ? 'bg-gradient-to-r from-green-400 to-green-500 text-white' : 
                            tontine.statut === 'terminee' ? 'bg-gradient-to-r from-gray-400 to-gray-500 text-white' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${tontine.statut === 'active' ? 'üü¢ Active' : 
                              tontine.statut === 'terminee' ? 'üèÅ Termin√©e' : tontine.statut}
                        </span>
                    </td>
                `;
                tableau.appendChild(tr);
            });
            
            // G√©n√©rer le r√©sum√© des alertes
            genererResumeAlertes();
        }
        
        function genererResumeAlertes() {
            const alertesActuelles = mettreAJourAlertes();
            const resume = document.getElementById('resumeAlertes');
            
            const retards = alertesActuelles.filter(a => a.type === 'retard');
            const tirages = alertesActuelles.filter(a => a.type === 'tirage');
            
            const cyclesRetard = tontines.filter(t => {
                const eligibles = t.membres.filter(m => !m.aGagne);
                return eligibles.length > 0 && !verifierDateTiragePossible(t) && verifierCotisationsCompletes(t);
            }).length;
            
            const paiementsAttente = tontines.reduce((sum, t) => {
                const tousOntGagne = t.membres.every(m => m.aGagne);
                if (tousOntGagne) return sum;
                
                const periodeActuelle = obtenirPeriodeCotisation(new Date().toISOString().split('T')[0], t.frequenceCotisation);
                return sum + t.membres.filter(m => {
                    return !m.cotisationsPayees.some(c => {
                        const periodeCotisation = obtenirPeriodeCotisation(c.date, t.frequenceCotisation);
                        return periodeCotisation === periodeActuelle;
                    });
                }).length;
            }, 0);
            
            resume.innerHTML = `
                <div class="bg-gradient-to-r from-red-100 to-red-200 p-4 rounded-xl text-center">
                    <div class="text-2xl font-bold text-red-600">${retards.length}</div>
                    <div class="text-sm text-red-700 font-medium">‚ö†Ô∏è Retards de paiement</div>
                    <div class="text-xs text-red-600 mt-1">${retards.filter(r => r.urgence === 'haute').length} urgents</div>
                </div>
                <div class="bg-gradient-to-r from-yellow-100 to-yellow-200 p-4 rounded-xl text-center">
                    <div class="text-2xl font-bold text-yellow-600">${cyclesRetard}</div>
                    <div class="text-sm text-yellow-700 font-medium">‚è≥ Cycles en retard</div>
                    <div class="text-xs text-yellow-600 mt-1">Tirages en attente</div>
                </div>
                <div class="bg-gradient-to-r from-blue-100 to-blue-200 p-4 rounded-xl text-center">
                    <div class="text-2xl font-bold text-blue-600">${paiementsAttente}</div>
                    <div class="text-sm text-blue-700 font-medium">üí≥ Paiements en attente</div>
                    <div class="text-xs text-blue-600 mt-1">Membres √† jour</div>
                </div>
                <div class="bg-gradient-to-r from-green-100 to-green-200 p-4 rounded-xl text-center">
                    <div class="text-2xl font-bold text-green-600">${tirages.length}</div>
                    <div class="text-sm text-green-700 font-medium">üé≤ Tirages disponibles</div>
                    <div class="text-xs text-green-600 mt-1">${tirages.filter(t => t.estPremierTirage).length} premiers tirages</div>
                </div>
            `;
        }

        // Syst√®me d'alertes intelligentes automatiques
        async function mettreAJourAlertes() {
  if (!utilisateurConnecte) return [];

  // 1. Charger les alertes existantes depuis Supabase
  const { data: alertesExistantes, error: errLoad } = await sb
    .from('alertes')
    .select('*')
    .eq('utilisateurId', utilisateurConnecte.id);

  if (errLoad) {
    console.error("Erreur chargement alertes:", errLoad);
    return [];
  }

  let nouvellesAlertes = [];

  // 2. V√©rifier les tontines
  tontines.forEach(tontine => {
    if (tontine.statut !== 'active') return;

    const tousOntGagne = tontine.membres.every(m => m.aGagne);

    // ‚ö†Ô∏è Retards cotisations
    if (!tousOntGagne) {
      tontine.membres.forEach(membre => {
        const periodeActuelle = obtenirPeriodeCotisation(new Date().toISOString().split('T')[0], tontine.frequenceCotisation);
        const aCotise = membre.cotisationsPayees.some(c => obtenirPeriodeCotisation(c.date, tontine.frequenceCotisation) === periodeActuelle);

        const dejaAlerte = alertesExistantes?.some(a => a.type === 'retard' && a.membreId === membre.id && a.tontineId === tontine.id);

        if (!aCotise && !dejaAlerte) {
          const joursRetard = membre.cotisationsPayees.length === 0 ? 
            Math.floor((new Date() - new Date(membre.dateAjout)) / 86400000) :
            Math.floor((new Date() - new Date(membre.cotisationsPayees.at(-1).date)) / 86400000);

          nouvellesAlertes.push({
            type: 'retard',
            tontineId: tontine.id,
            membreId: membre.id,
            message: `${membre.nom} est en retard de ${joursRetard} jour(s) pour "${tontine.nom}"`,
            urgence: joursRetard > 7 ? 'haute' : 'moyenne',
            utilisateurId: utilisateurConnecte.id,
            dateCreation: new Date().toISOString()
          });
        }
      });
    }

    // üé≤ Tirage possible
    const eligibles = tontine.membres.filter(m => !m.aGagne);
    const cotisationsCompletes = verifierCotisationsCompletes(tontine);
    const tiragePossible = verifierDateTiragePossible(tontine);
    const dejaAlerteTirage = alertesExistantes?.some(a => a.type === 'tirage' && a.tontineId === tontine.id);

    if (eligibles.length > 0 && cotisationsCompletes && tiragePossible && !dejaAlerteTirage) {
      nouvellesAlertes.push({
        type: 'tirage',
        tontineId: tontine.id,
        message: `üé≤ Tirage disponible pour "${tontine.nom}"`,
        urgence: tontine.tirages.length === 0 ? 'haute' : 'moyenne',
        utilisateurId: utilisateurConnecte.id,
        dateCreation: new Date().toISOString()
      });
    }

    // ‚è≥ Cycle en retard
    const dejaAlerteCycle = alertesExistantes?.some(a => a.type === 'cycle_retard' && a.tontineId === tontine.id);
    if (cotisationsCompletes && !tiragePossible && !dejaAlerteCycle) {
      const joursRestants = obtenirJoursRestantsAvantTirage(tontine);
      nouvellesAlertes.push({
        type: 'cycle_retard',
        tontineId: tontine.id,
        message: `‚è≥ Cycle en attente pour "${tontine.nom}" (${joursRestants} j restants)`,
        urgence: joursRestants <= 3 ? 'moyenne' : 'basse',
        utilisateurId: utilisateurConnecte.id,
        dateCreation: new Date().toISOString()
      });
    }
  });

  // 3. Ins√©rer les nouvelles alertes
  if (nouvellesAlertes.length > 0) {
    const { error: errInsert } = await sb.from('alertes').insert(nouvellesAlertes);
    if (errInsert) {
      console.error("Erreur insertion alertes:", errInsert);
    }
  }

  // 4. Mettre √† jour l‚Äôaffichage **une seule fois**
  await afficherAlertes(); // ‚ö° recharge le DOM + le badge

  // ‚úÖ Retourne la liste compl√®te
  return [...(alertesExistantes || []), ...nouvellesAlertes];
}
        
       function mettreAJourBadgeAlertes(alertesActuelles = []) {
  const badge = document.getElementById('badgeAlertes');
  if (alertesActuelles && alertesActuelles.length > 0) {
    badge.textContent = alertesActuelles.length;
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
}


        function verifierAlertes() {
            return mettreAJourAlertes();
        }

       async function afficherAlertes() {
  if (!utilisateurConnecte) return;

  // Charger les alertes de Supabase
  const { data: alertesActuelles, error } = await sb
    .from('alertes')
    .select('*')
    .eq('utilisateurId', utilisateurConnecte.id)
    .order('datecreation', { ascending: false });

  if (error) {
    console.error("Erreur r√©cup√©ration alertes:", error);
    return;
  }

  const liste = document.getElementById('listeAlertes');
  liste.innerHTML = '';

  if (!alertesActuelles || alertesActuelles.length === 0) {
    liste.innerHTML = `
      <div class="text-center py-16">
          <div class="text-8xl mb-6 floating-animation">‚úÖ</div>
          <h3 class="text-3xl font-bold text-gray-700 mb-4">Aucune alerte active</h3>
          <p class="text-gray-600 text-lg mb-4">Toutes les tontines sont bien g√©r√©es !</p>
          <div class="bg-gradient-to-r from-green-100 to-blue-100 p-6 rounded-xl max-w-md mx-auto">
              <div class="text-sm text-gray-700">
                  <div class="font-semibold mb-2">üéØ Syst√®me d'alertes intelligent :</div>
                  <div class="space-y-1 text-left">
                      <div>‚Ä¢ Validation automatique des tirages</div>
                      <div>‚Ä¢ Nettoyage des alertes obsol√®tes</div>
                      <div>‚Ä¢ Suivi des membres √©ligibles uniquement</div>
                  </div>
              </div>
          </div>
      </div>
    `;
    // ‚úÖ Badge √† z√©ro
    document.getElementById('badgeAlertes').classList.add('hidden');
    return;
  }

  // Trier par urgence puis par type
  const urgenceOrder = { 'haute': 4, 'moyenne': 3, 'basse': 2 };
  const typeOrder = { 'tirage': 4, 'retard': 3, 'cycle_retard': 2, 'paiement_attente': 1 };

  alertesActuelles.sort((a, b) => {
    if (urgenceOrder[a.urgence] !== urgenceOrder[b.urgence]) {
      return urgenceOrder[b.urgence] - urgenceOrder[a.urgence];
    }
    return typeOrder[b.type] - typeOrder[a.type];
  });

  // Affichage
  alertesActuelles.forEach((alerte, index) => {
    let couleur, icone, details = '';

    if (alerte.type === 'retard') {
      couleur = alerte.urgence === 'haute' ? 'from-red-600 to-red-700' : 'from-orange-500 to-red-500';
      icone = alerte.urgence === 'haute' ? 'üö®' : '‚ö†Ô∏è';
      details = `<div class="text-sm opacity-90 mt-2">‚è∞ Urgence: ${alerte.urgence}</div>`;
    } 
    else if (alerte.type === 'tirage') {
      couleur = 'from-blue-500 to-green-500';
      icone = 'üé≤';
      details = `<div class="text-sm opacity-90 mt-2">üéâ Tirage disponible</div>`;
    } 
    else if (alerte.type === 'cycle_retard') {
      couleur = 'from-yellow-500 to-orange-500';
      icone = '‚è≥';
      details = `<div class="text-sm opacity-90 mt-2">üìä Cycle en retard</div>`;
    } 
    else {
      couleur = 'from-gray-500 to-gray-600';
      icone = '‚ÑπÔ∏è';
    }

    const div = document.createElement('div');
    div.className = `bg-gradient-to-r ${couleur} p-6 rounded-2xl text-white fade-in-up mb-6 shadow-lg`;
    div.style.animationDelay = `${index * 0.1}s`;

    // ‚úÖ on ajoute l'attribut data-alerte-id
    div.setAttribute("data-alerte-id", alerte.id);

    div.innerHTML = `
      <div class="flex items-start justify-between">
          <div class="flex items-start flex-1">
              <span class="text-4xl mr-4 floating-animation" style="animation-delay: ${index * 0.2}s">${icone}</span>
              <div class="flex-1">
                  <div class="font-bold text-xl mb-1">${alerte.message}</div>
                  <div class="text-sm opacity-75 mb-2">üìã Tontine ID: ${alerte.tontineId}</div>
                  ${details}
                  <div class="text-xs opacity-60 mt-3">
                      üïí Cr√©√©e le ${new Date(alerte.dateCreation).toLocaleDateString('fr-FR')} √† ${new Date(alerte.dateCreation).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}
                  </div>
              </div>
          </div>
          <div class="flex flex-col gap-2 ml-4">
              <button onclick="supprimerAlerte('${alerte.id}')" 
                      class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap">
                  ‚ùå Ignorer
              </button>
          </div>
      </div>
    `;
    liste.appendChild(div);
  });

  // ‚úÖ Mise √† jour badge (une seule fois)
  const badge = document.getElementById('badgeAlertes');
  badge.textContent = alertesActuelles.length;
  badge.classList.remove('hidden');
}

        function allerAuTirage(tontineId) {
            ouvrirPage('tirages');
            document.getElementById('selectTontineTirage').value = tontineId;
            chargerTontineTirage();
        }
        
       async function supprimerAlerte(alerteId) {
  const { error } = await sb.from('alertes').delete().eq('id', alerteId);
  if (error) {
    alert("Erreur suppression: " + error.message);
    return;
  }

  // ‚úÖ Retirer du DOM directement
  const el = document.querySelector(`[data-alerte-id="${alerteId}"]`);
  if (el) el.remove();

  // ‚úÖ Mettre √† jour le badge en d√©cr√©mentant
  const badge = document.getElementById('badgeAlertes');
  const actuel = parseInt(badge.textContent || "0", 10);

  if (actuel > 1) {
    badge.textContent = actuel - 1;
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }

  console.log(`‚úÖ Alerte ${alerteId} supprim√©e`);
}

        // Fonction pour calculer le cycle actuel
        function obtenirCycleActuel(tontine) {
            if (tontine.membres.length === 0) return 1;
            
            // Le cycle actuel est bas√© sur le nombre de tirages effectu√©s + 1
            // Si aucun tirage n'a √©t√© effectu√©, on est au cycle 1
            // Si 1 tirage effectu√©, on est au cycle 2, etc.
            return tontine.tirages.length + 1;
        }

        // Fonctions utilitaires
        function verifierCotisationsCompletes(tontine) {
            if (tontine.membres.length === 0) return false;
            
            // Tous les membres doivent cotiser, m√™me ceux qui ont d√©j√† gagn√©
            // Seule exception : si tous les membres ont gagn√© (tontine termin√©e)
            const tousOntGagne = tontine.membres.every(m => m.aGagne);
            if (tousOntGagne) return true;
            
            // V√©rifier que tous les membres ont cotis√© pour la p√©riode actuelle
            const periodeActuelle = obtenirPeriodeCotisation(new Date().toISOString().split('T')[0], tontine.frequenceCotisation);
            
            return tontine.membres.every(membre => {
                return membre.cotisationsPayees.some(c => {
                    const periodeCotisation = obtenirPeriodeCotisation(c.date, tontine.frequenceCotisation);
                    return periodeCotisation === periodeActuelle;
                });
            });
        }

        function verifierDateTiragePossible(tontine) {
            if (!verifierCotisationsCompletes(tontine)) return false;
            
            const eligibles = tontine.membres.filter(m => !m.aGagne);
            if (eligibles.length === 0) return false;
            
            // Premier tirage : disponible d√®s que toutes les cotisations sont compl√®tes
            if (tontine.tirages.length === 0) return true;
            
            // Tirages suivants : v√©rifier l'intervalle de temps
            const dernierTirage = tontine.tirages[tontine.tirages.length - 1];
            const dateDernierTirage = new Date(dernierTirage.date);
            const maintenant = new Date();
            const diffJours = (maintenant - dateDernierTirage) / (1000 * 60 * 60 * 24);
            
            // Intervalles selon la fr√©quence
            const intervalles = {
                'hebdomadaire': 7,
                'mensuel': 30,
                'trimestriel': 90
            };
            
            const intervalleRequis = intervalles[tontine.frequenceTirage] || 30;
            return diffJours >= intervalleRequis;
        }

        function obtenirProchaineDateTirage(tontine) {
            if (tontine.tirages.length === 0) {
                return new Date();
            }
            
            const dernierTirage = new Date(tontine.tirages[tontine.tirages.length - 1].date);
            const intervalles = {
                'hebdomadaire': 7,
                'mensuel': 30,
                'trimestriel': 90
            };
            
            const intervalle = intervalles[tontine.frequenceTirage] || 30;
            const prochaineTirage = new Date(dernierTirage);
            prochaineTirage.setDate(dernierTirage.getDate() + intervalle);
            
            return prochaineTirage;
        }

        function obtenirJoursRestantsAvantTirage(tontine) {
            if (tontine.tirages.length === 0) return 0;
            
            const prochaineTirage = obtenirProchaineDateTirage(tontine);
            const maintenant = new Date();
            const diffJours = Math.ceil((prochaineTirage - maintenant) / (1000 * 60 * 60 * 24));
            
            return Math.max(0, diffJours);
        }

        function estEnRetard(derniereCotisation, frequence) {
            const aujourd_hui = new Date();
            const dateCotisation = new Date(derniereCotisation);
            const diffJours = (aujourd_hui - dateCotisation) / (1000 * 60 * 60 * 24);
            
            switch (frequence) {
                case 'quotidien': return diffJours > 1;
                case 'hebdomadaire': return diffJours > 7;
                case 'mensuel': return diffJours > 30;
                case 'annuel': return diffJours > 365;
                default: return false;
            }
        }

        function obtenirPeriodeCotisation(date, frequence) {
            const dateObj = new Date(date);
            switch (frequence) {
                case 'quotidien': return date.split('T')[0];
                case 'hebdomadaire': 
                    const debutSemaine = new Date(dateObj);
                    debutSemaine.setDate(dateObj.getDate() - dateObj.getDay());
                    return debutSemaine.toISOString().split('T')[0];
                case 'mensuel': return `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                case 'annuel': return dateObj.getFullYear().toString();
                default: return date.split('T')[0];
            }
        }

        function obtenirPeriodeActuelle(frequence) {
            const aujourd_hui = new Date();
            switch (frequence) {
                case 'quotidien': return aujourd_hui.toISOString().split('T')[0];
                case 'hebdomadaire': 
                    const debutSemaine = new Date(aujourd_hui);
                    debutSemaine.setDate(aujourd_hui.getDate() - aujourd_hui.getDay());
                    return debutSemaine.toISOString().split('T')[0];
                case 'mensuel': return `${aujourd_hui.getFullYear()}-${String(aujourd_hui.getMonth() + 1).padStart(2, '0')}`;
                case 'annuel': return aujourd_hui.getFullYear().toString();
                default: return aujourd_hui.toISOString().split('T')[0];
            }
        }

        // A-t-il pay√© dans la p√©riode courante ?
function aPayePeriode(membre, tontine) {
  const periodeActuelle = obtenirPeriodeActuelle(tontine.frequenceCotisation);
  return (membre.cotisationsPayees || []).some(c =>
    obtenirPeriodeCotisation(c.date, tontine.frequenceCotisation) === periodeActuelle
  );
}

// En retard = pas de paiement dans la p√©riode courante
function estEnRetardPeriode(membre, tontine) {
  return !aPayePeriode(membre, tontine);
}


        function estDansLaPeriode(date, periode, frequence) {
            const dateCotisation = new Date(date);
            switch (frequence) {
                case 'quotidien': return date === periode;
                case 'hebdomadaire':
                    const debutSemaine = new Date(periode);
                    const finSemaine = new Date(debutSemaine);
                    finSemaine.setDate(debutSemaine.getDate() + 6);
                    return dateCotisation >= debutSemaine && dateCotisation <= finSemaine;
                case 'mensuel':
                    const [annee, mois] = periode.split('-');
                    return dateCotisation.getFullYear() == annee && (dateCotisation.getMonth() + 1) == mois;
                case 'annuel':
                    return dateCotisation.getFullYear() == periode;
                default: return false;
            }
        }

        function supprimerTontine(id) {
            const tontine = tontines.find(t => t.id === id);
            if (!tontine) return;
            
            const totalCotisations = tontine.cotisations.reduce((sum, c) => sum + c.montant, 0);
            const membresActifs = tontine.membres.filter(m => !m.aGagne).length;
            
            const message = `‚ö†Ô∏è SUPPRESSION D√âFINITIVE ‚ö†Ô∏è\n\n` +
                          `Tontine: "${tontine.nom}"\n` +
                          `Type: ${tontine.type}\n` +
                          `Membres: ${tontine.membres.length}/${tontine.nombreMembresMax}\n` +
                          `Membres actifs: ${membresActifs}\n` +
                          `Cotisations collect√©es: ${totalCotisations.toLocaleString()} FCFA\n` +
                          `Tirages effectu√©s: ${tontine.tirages.length}\n\n` +
                          `‚ö†Ô∏è TOUTES LES DONN√âES SERONT PERDUES ‚ö†Ô∏è\n` +
                          `(Membres, cotisations, historique des tirages)\n\n` +
                          `√ätes-vous absolument certain(e) ?`;
            
            if (confirm(message)) {
                // Supprimer les alertes li√©es
                alertes = alertes.filter(a => a.tontineId !== id);
                
                // Supprimer la tontine
                tontines = tontines.filter(t => t.id !== id);
                
                sauvegarder();
                mettreAJourAffichage();
                
                if (pageActuelle === 'accueil') {
                    afficherTontines();
                }
                
                alert(`‚úÖ Tontine "${tontine.nom}" supprim√©e d√©finitivement !\n\n` +
                      `üìä R√©sum√© de la suppression:\n` +
                      `‚Ä¢ ${tontine.membres.length} membres retir√©s\n` +
                      `‚Ä¢ ${totalCotisations.toLocaleString()} FCFA de cotisations effac√©es\n` +
                      `‚Ä¢ ${tontine.tirages.length} tirages supprim√©s de l'historique`);
            }
        }

        function mettreAJourAffichage() {
            document.getElementById('nombreTontines').textContent = tontines.filter(t => t.statut === 'active').length;
            verifierAlertes();
        }

        // Fonctions d'√©dition de tontine
        let membreEnEdition = null;
        let cotisationEnEdition = null;
        
        function ouvrirModaleEditionTontine() {
            if (!tontineActive) return;
            
            // Remplir les champs avec les donn√©es actuelles
            document.getElementById('editNomTontine').value = tontineActive.nom;
            document.getElementById('editTypeTontine').value = tontineActive.type;
            document.getElementById('editMontantCotisation').value = tontineActive.montant;
            document.getElementById('editFrequenceCotisation').value = tontineActive.frequenceCotisation;
            document.getElementById('editJourCotisation').value = tontineActive.jourCotisation;
            document.getElementById('editFrequenceTirage').value = tontineActive.frequenceTirage;
            document.getElementById('editNombreMembres').value = tontineActive.nombreMembresMax;
            document.getElementById('editDescriptionTontine').value = tontineActive.description || '';
            
            document.getElementById('modaleEditionTontine').classList.remove('hidden');
        }
        
        function fermerModaleEdition() {
            document.getElementById('modaleEditionTontine').classList.add('hidden');
        }
        
        async function sauvegarderEditionTontine() {
  if (!tontineActive) return;
  const id = tontineActive.id;
  const nom = document.getElementById('editNomTontine').value.trim();
  const type = document.getElementById('editTypeTontine').value;
  const montant = parseFloat(document.getElementById('editMontantCotisation').value);
  const frequenceCot = document.getElementById('editFrequenceCotisation').value;
  const jourCot = document.getElementById('editJourCotisation').value;
  const frequenceTir = document.getElementById('editFrequenceTirage').value;
  const nbMembres = parseInt(document.getElementById('editNombreMembres').value, 10);
  const description = document.getElementById('editDescriptionTontine').value.trim();

  const { error } = await sb.from('tontines').update({
    nom, type, montant_cotisation: montant, frequence_cotisation: frequenceCot,
    jour_cotisation: jourCot, frequence_tirage: frequenceTir,
    nombre_membres: nbMembres, description
  }).eq('id', id);

  if (error) return alert('Modification impossible: ' + error.message);

  // MAJ state local pour l‚ÄôUI (comme avant)
  Object.assign(tontineActive, {
    nom, type, montant, frequenceCotisation: frequenceCot,
    jourCotisation: jourCot, frequenceTirage: frequenceTir,
    nombreMembresMax: nbMembres, description
  });
  fermerModaleEdition?.();
  afficherInfosTontine?.();
  mettreAJourAffichage?.();
  alert('‚úÖ Tontine modifi√©e avec succ√®s !');
}
        
        async function supprimerTontineActive() {
  if (!tontineActive) return;

  const message = `‚ö†Ô∏è SUPPRESSION DE TONTINE ‚ö†Ô∏è\n\n` +
                  `Nom: "${tontineActive.nom}"\n\n` +
                  `Cette action est irr√©versible.\n` +
                  `Toutes les donn√©es li√©es (membres, cotisations, tirages, alertes) seront supprim√©es d√©finitivement.\n\n` +
                  `Confirmer la suppression ?`;

  if (!confirm(message)) return;

  // üîπ Suppression c√¥t√© Supabase
  const { error } = await sb.from('tontines').delete().eq('id', tontineActive.id);
  if (error) return alert('Suppression impossible: ' + error.message);

  // üîπ Mise √† jour c√¥t√© front
  tontines = tontines.filter(t => t.id !== tontineActive.id);
  alertes = alertes.filter(a => a.tontineId !== tontineActive.id);
  tontineActive = null;

  mettreAJourAlertes();

  alert(`‚úÖ Tontine "${tontineActive?.nom || ''}" supprim√©e avec succ√®s !\n\n` +
        `üìä Toutes ses donn√©es associ√©es (membres, cotisations, tirages) ont √©t√© effac√©es.`);

  // Retourner √† l'accueil
  ouvrirPage('accueil');
}
        
        // Fonctions d'√©dition de membre
        function ouvrirModaleEditionMembre(membreId) {
            let membre;
            
            // Chercher le membre dans la tontine active ou dans la tontine s√©lectionn√©e pour les membres
            if (tontineActive) {
                membre = tontineActive.membres.find(m => m.id === membreId);
            } else if (pageActuelle === 'membres') {
                const tontineId = parseInt(document.getElementById('selectTontineMembres').value);
                const tontine = tontines.find(t => t.id === tontineId);
                if (tontine) {
                    membre = tontine.membres.find(m => m.id === membreId);
                    tontineActive = tontine; // D√©finir temporairement pour l'√©dition
                }
            }
            
            if (!membre) return;
            
            membreEnEdition = membre;
            
            // Remplir les champs avec les donn√©es actuelles
            document.getElementById('editNomMembre').value = membre.nom;
            document.getElementById('editDateAjoutMembre').value = membre.dateAjout.split('T')[0];
            
            document.getElementById('modaleEditionMembre').classList.remove('hidden');
        }
        
        function fermerModaleEditionMembre() {
            document.getElementById('modaleEditionMembre').classList.add('hidden');
            membreEnEdition = null;
        }
        
        function sauvegarderEditionMembre() {
            if (!membreEnEdition) return;
            
            const nom = document.getElementById('editNomMembre').value.trim();
            const dateAjout = document.getElementById('editDateAjoutMembre').value;
            
            if (!nom || !dateAjout) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            // V√©rifier que le nom n'existe pas d√©j√† (sauf pour le membre actuel)
            const nomExiste = tontineActive.membres.some(m => 
                m.id !== membreEnEdition.id && m.nom.toLowerCase() === nom.toLowerCase()
            );
            
            if (nomExiste) {
                alert('Un membre avec ce nom existe d√©j√† dans cette tontine');
                return;
            }
            
            // Mettre √† jour le membre
            membreEnEdition.nom = nom;
            membreEnEdition.dateAjout = new Date(dateAjout).toISOString();
            
            sauvegarder();
            fermerModaleEditionMembre();
            
            // Rafra√Æchir l'affichage selon la page actuelle
            if (pageActuelle === 'gestion') {
                afficherMembresTontineGestion();
                mettreAJourSelectMembres();
            } else if (pageActuelle === 'membres') {
                afficherMembresTontine();
            }
            
            alert('‚úÖ Membre modifi√© avec succ√®s !');
        }

        // Fonctions d'√©dition de cotisation
        function editerCotisation(cotisationId, tontineId) {
            const tontine = tontines.find(t => t.id === tontineId);
            if (!tontine) return;
            
            const cotisation = tontine.cotisations.find(c => c.id == cotisationId);
            if (!cotisation) return;
            
            const membre = tontine.membres.find(m => m.id === cotisation.membreId);
            if (!membre) return;
            
            cotisationEnEdition = { cotisation, tontine, membre };
            
            // Remplir les champs
            document.getElementById('editMembreCotisation').value = membre.nom;
            document.getElementById('editDateCotisation').value = cotisation.date.split('T')[0];
            document.getElementById('editMontantCotisation').value = cotisation.montant;
            document.getElementById('cotisationUnitaire').textContent = tontine.montant.toLocaleString();
            
            // Calculer l'√©quivalent
            calculerEquivalentCotisations();
            
            // √âcouter les changements de montant
            document.getElementById('editMontantCotisation').oninput = calculerEquivalentCotisations;
            
            document.getElementById('modaleEditionCotisation').classList.remove('hidden');
        }
        
        function calculerEquivalentCotisations() {
            const montant = parseFloat(document.getElementById('editMontantCotisation').value) || 0;
            const montantUnitaire = cotisationEnEdition ? cotisationEnEdition.tontine.montant : 0;
            const equivalent = montantUnitaire > 0 ? (montant / montantUnitaire).toFixed(1) : 0;
            document.getElementById('equivalentCotisations').textContent = equivalent;
        }
        
        function fermerModaleEditionCotisation() {
            document.getElementById('modaleEditionCotisation').classList.add('hidden');
            cotisationEnEdition = null;
        }
        
        function sauvegarderEditionCotisation() {
            if (!cotisationEnEdition) return;
            
            const date = document.getElementById('editDateCotisation').value;
            const montant = parseFloat(document.getElementById('editMontantCotisation').value);
            
            if (!date || !montant || montant <= 0) {
                alert('Veuillez remplir tous les champs avec des valeurs valides');
                return;
            }
            
            const { cotisation, tontine, membre } = cotisationEnEdition;
            
            // Mettre √† jour la cotisation
            cotisation.date = new Date(date).toISOString();
            cotisation.montant = montant;
            
            // Mettre √† jour dans la liste du membre
            const cotisationMembre = membre.cotisationsPayees.find(c => c.id == cotisation.id);
            if (cotisationMembre) {
                cotisationMembre.date = cotisation.date;
                cotisationMembre.montant = cotisation.montant;
            }
            
            sauvegarder();
            fermerModaleEditionCotisation();
            
            // Rafra√Æchir l'affichage
            if (pageActuelle === 'gestion') {
                afficherHistoriqueCotisations();
                afficherMembresTontineGestion();
            } else if (pageActuelle === 'membres') {
                afficherMembresTontine();
            }
            
            mettreAJourAlertes();
            
            const equivalent = (montant / tontine.montant).toFixed(1);
            alert(`‚úÖ Cotisation modifi√©e avec succ√®s !\n\nüìä D√©tails:\n‚Ä¢ Montant: ${montant.toLocaleString()} FCFA\n‚Ä¢ √âquivalent: ${equivalent} cotisation(s)\n‚Ä¢ Date: ${new Date(date).toLocaleDateString('fr-FR')}`);
        }

        function sauvegarder() {
            // Sauvegarder les donn√©es sp√©cifiques √† l'utilisateur connect√©
            sauvegarderDonneesUtilisateur();
            
            // Marquer les donn√©es comme modifi√©es pour la synchronisation
            donneesModifiees = true;
            mettreAJourStatutReseau();
            
            // Tenter une synchronisation imm√©diate si en ligne
            if (estEnLigne) {
                setTimeout(synchroniserDonnees, 1000);
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'972a962a719755aa',t:'MTc1NTc4NDA5MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
